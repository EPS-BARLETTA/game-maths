<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Math√©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    body { 
      font-family: Arial, sans-serif;
      background: #eceff1;
      margin: 0; 
      padding: 0; 
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 95%;
      max-width: 430px;
      background: linear-gradient(180deg, #fafafa, #e6e9ef);
      border-radius: 22px;
      padding: 18px 22px;
      box-shadow: 0 6px 18px #0003;
      text-align: center;
      margin: 20px;
    }

    h1 { margin-top: 8px; }

    /* PAGE DE GARDE */
    #welcome { padding: 30px 10px; }

    #startApp {
      padding: 14px 28px;
      font-size: 1.2em;
      background: #ffffff;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 3px 8px #0003;
    }

    /* BOUTONS G√âN√âRAUX */
    button {
      cursor: pointer;
    }

    .button {
      padding: 12px 24px;
      font-size: 1.05em;
      border-radius: 12px;
      border: none;
      background: #fff;
      color: #333;
      font-weight: bold;
      box-shadow: 0 2px 6px #0003;
      margin-top: 10px;
    }

    /* BOUTONS PASTEL PREMIUM */
    .operation-btn[data-op="multiply"] { background:#b2f2bb; }
    .operation-btn[data-op="add"] { background:#a5d8ff; }
    .operation-btn[data-op="subtract"] { background:#d0bfff; }
    .operation-btn[data-op="divide"] { background:#ffc9c2; }

    .mode-btn[data-mode="multiplication"] { background:#c3f7c0; }
    .mode-btn[data-mode="chrono"] { background:#b3e5fc; }
    .mode-btn[data-mode="vrai_faux"] { background:#ffdde5; }
    .mode-btn[data-mode="erreur"] { background:#eac9a8; }

    .level-btn[data-level="1"] { background:#d8f5a2; }
    .level-btn[data-level="2"] { background:#ffef9c; }
    .level-btn[data-level="3"] { background:#cfd8dc; }

    .questions-btn { background:#ececec; color:#333; }

    /* √âTAT SELECTIONN√â */
    .selected {
      filter: brightness(0.9);
      border: 2px solid #fff;
      box-shadow: 0 0 6px #0004 inset;
    }

    input[type="text"] {
      padding: 10px;
      font-size: 1.1em;
      width: 70%;
      border-radius: 10px;
      border: none;
      background: #f1f3f4;
      color: #333;
      margin: 8px auto;
      display: block;
      text-align: center;
    }

    /* JEU */
    #game {
      margin-top: 10px;
    }

    #question {
      font-size: 2em;
      margin: 16px 0;
      min-height: 2.2em;
    }

    /* NUMPAD */
    #numpad {
      margin-top: 8px;
    }

    #numpad-row {
      display: flex;
      justify-content: center;
    }

    #numpad button {
      width: 60px;
      height: 58px;
      margin: 3px;
      border-radius: 12px;
      font-size: 1.3em;
      border: none;
      background: #ececec;
      color:#333;
      box-shadow: 0 2px 6px #0002;
    }

    .numpad-eff { background:#bbb; }
    .numpad-ok { background:#66bb6a !important; color:white; font-weight:bold; }

    .numpad-vrai { background:#66dd77; width:48%; height:60px; font-size:1.4em; border-radius:14px; }
    .numpad-faux { background:#ff6666; width:48%; height:60px; font-size:1.4em; border-radius:14px; }

    /* CHRONO AFFICH√â EN BAS */
    #chronoDisplay {
      font-size: 1.3em;
      margin-top: 12px;
      font-weight: bold;
      color: #333;
    }

    /* R√âSULTATS */
    #result canvas {
      margin: 20px auto;
      display: block;
    }

    .feedback {
      font-size: 2.2em;
      margin-top: 6px;
      min-height: 1.4em;
      font-weight: bold;
    }

    .hidden { display:none !important; }
  </style>
</head>

<body>

<div class="container">

  <div id="welcome">
    <h1>üéÆ D√©fi Math√©matiques</h1>
    <button id="startApp">D√©marrer</button>
  </div>

  <div id="start" class="hidden">

    <p>Pr√©nom : <input id="prenom" type="text"></p>
    <p>Classe : <input id="classe" type="text"></p>

    <h3>Op√©ration :</h3>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <h3>Niveau :</h3>
    <div id="level-choose"></div>

    <h3>Nombre de questions :</h3>
    <div id="questions-choose"></div>

    <h3>Mode :</h3>
    <div id="mode-choose"></div>

    <button id="btn-play" class="button">Valider et jouer</button>
  </div>

  <div id="chronoStartPage" class="hidden">
    <h2>Mode Chrono</h2>
    <p id="chronoInfo"></p>
    <button id="btn-start-chrono" class="button">D√©marrer l‚Äôexercice</button>
  </div>

  <form id="game" class="hidden" onsubmit="return false;">
    <div id="question"></div>
    <div id="numpad"></div>
    <div class="feedback" id="feedback"></div>

    <div id="chronoDisplay" class="hidden">‚è± 0.0s</div>

    <p id="progress"></p>
  </form>

  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText"></p>
    <p id="timeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>

<!-- ICI TU COLLERAS LE BLOC 2 -->
<script>
// --------------------------------------------------
// √âTAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: "multiply",
  level: 1,
  numQuestions: 10,
  prenom: "",
  classe: "",
  questionCount: 0,
  correctCount: 0,
  currentQuestion: "",
  correctAnswer: null,
  selectedTables: [],
  chronoStart: 0,
  chrono: 0,
  chronoRunning: false
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$("startApp").onclick = () => {
  $("welcome").classList.add("hidden");
  $("start").classList.remove("hidden");
};

// --------------------------------------------------
// BOUTONS OP√âRATIONS
// --------------------------------------------------
const ops = [
  { op: "multiply", label: "√ó Multiplication" },
  { op: "add", label: "+ Addition" },
  { op: "subtract", label: "‚àí Soustraction" },
  { op: "divide", label: "√∑ Division" }
];

ops.forEach(o => {
  let b = document.createElement("button");
  b.textContent = o.label;
  b.className = "operation-btn";
  b.dataset.op = o.op;

  b.onclick = () => {
    state.operation = o.op;
    document.querySelectorAll(".operation-btn").forEach(x => x.classList.remove("selected"));
    b.classList.add("selected");

    $("tables-choose").classList.toggle("hidden", o.op !== "multiply");

    if (o.op !== "multiply") {
      state.selectedTables = [];
      document.querySelectorAll(".table-btn").forEach(t => t.classList.remove("selected"));
    }
  };

  $("op-choose").appendChild(b);
});
document.querySelector(".operation-btn[data-op='multiply']").classList.add("selected");

// --------------------------------------------------
// TABLES PERSONNALIS√âES (MULTIPLICATION)
// --------------------------------------------------
let htmlTables = "";
for (let i = 1; i <= 12; i++) {
  htmlTables += `<button class="table-btn" data-table="${i}">${i}</button>`;
}
$("tables-choose").innerHTML = htmlTables;

document.querySelectorAll(".table-btn").forEach(btn => {
  btn.onclick = () => {
    let v = parseInt(btn.dataset.table);
    if (state.selectedTables.includes(v)) {
      state.selectedTables = state.selectedTables.filter(x => x !== v);
      btn.classList.remove("selected");
    } else {
      state.selectedTables.push(v);
      btn.classList.add("selected");
    }
  };
});

// --------------------------------------------------
// NIVEAUX
// --------------------------------------------------
[1, 2, 3].forEach(l => {
  let b = document.createElement("button");
  b.className = "level-btn";
  b.dataset.level = l;
  b.textContent = "Niveau " + l;

  b.onclick = () => {
    state.level = l;
    document.querySelectorAll(".level-btn").forEach(x => x.classList.remove("selected"));
    b.classList.add("selected");
  };

  $("level-choose").appendChild(b);
});
document.querySelector(".level-btn[data-level='1']").classList.add("selected");

// --------------------------------------------------
// NOMBRE DE QUESTIONS
// --------------------------------------------------
[10, 15, 20, 25, 30].forEach(q => {
  let b = document.createElement("button");
  b.className = "questions-btn";
  b.dataset.q = q;
  b.textContent = q;

  b.onclick = () => {
    state.numQuestions = q;
    document.querySelectorAll(".questions-btn").forEach(x => x.classList.remove("selected"));
    b.classList.add("selected");
  };

  $("questions-choose").appendChild(b);
});
document.querySelector(".questions-btn[data-q='10']").classList.add("selected");

// --------------------------------------------------
// MODES
// --------------------------------------------------
const modes = [
  { m: "multiplication", label: "Classique" },
  { m: "chrono", label: "Chrono" },
  { m: "vrai_faux", label: "Vrai/Faux" },
  { m: "erreur", label: "Erreur" }
];

modes.forEach(o => {
  let b = document.createElement("button");
  b.className = "mode-btn";
  b.dataset.mode = o.m;
  b.textContent = o.label;

  b.onclick = () => {
    state.mode = o.m;
    document.querySelectorAll(".mode-btn").forEach(x => x.classList.remove("selected"));
    b.classList.add("selected");
  };

  $("mode-choose").appendChild(b);
});
document.querySelector(".mode-btn[data-mode='multiplication']").classList.add("selected");

// --------------------------------------------------
// VALIDATION MENU
// --------------------------------------------------
$("btn-play").onclick = () => {
  state.prenom = $("prenom").value.trim();
  state.classe = $("classe").value.trim();

  if (!state.prenom || !state.classe) {
    alert("Merci d‚Äôentrer un pr√©nom et une classe.");
    return;
  }

  if (state.mode === "chrono") {
    $("start").classList.add("hidden");
    $("chronoInfo").innerHTML = `Tu dois r√©pondre √† <b>${state.numQuestions}</b> questions.`;
    $("chronoStartPage").classList.remove("hidden");
  } else {
    startGame();
  }
};

// --------------------------------------------------
// CHRONO START PAGE
// --------------------------------------------------
$("btn-start-chrono").onclick = () => {
  $("chronoStartPage").classList.add("hidden");
  startGame(true);
};

// --------------------------------------------------
// LANCEMENT DU JEU
// --------------------------------------------------
function startGame(chronoMode = false) {
  state.questionCount = 0;
  state.correctCount = 0;
  state.chrono = 0;
  state.chronoRunning = false;

  $("start").classList.add("hidden");
  $("result").classList.add("hidden");
  $("game").classList.remove("hidden");

  $("feedback").textContent = "";
  $("chronoDisplay").classList.toggle("hidden", state.mode !== "chrono");

  if (chronoMode) startChrono();

  nextQuestion();
}

// --------------------------------------------------
// CHRONO TOTAL
// --------------------------------------------------
function startChrono() {
  state.chronoStart = performance.now();
  state.chronoRunning = true;

  function tick() {
    if (!state.chronoRunning) return;
    let t = (performance.now() - state.chronoStart) / 1000;
    state.chrono = t;
    $("chronoDisplay").textContent = `‚è± ${t.toFixed(1)}s`;
    requestAnimationFrame(tick);
  }
  requestAnimationFrame(tick);
}

// --------------------------------------------------
// OUTILS NOMBRES
// --------------------------------------------------
function rand(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function rangeFromLevel(level) {
  if (level === 1) return [1, 9];
  if (level === 2) return [10, 20];
  return [10, 99];
}

// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createPad() {
  const pad = $("numpad");
  pad.innerHTML = "";

  if (state.mode === "vrai_faux")
    return createVF("vrai", "faux");

  if (state.mode === "erreur")
    return createVF("juste", "faux");

  const rows = [
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ["Eff",0,"OK"]
  ];

  rows.forEach(r => {
    let line = document.createElement("div");
    line.id = "numpad-row";

    r.forEach(v => {
      let b = document.createElement("button");
      b.textContent = v;

      if (v === "Eff") b.className = "numpad-eff";
      if (v === "OK") b.className = "numpad-ok";

      b.onclick = () => handlePad(v);
      line.appendChild(b);
    });

    pad.appendChild(line);
  });
}

function createVF(a, b) {
  const pad = $("numpad");
  pad.innerHTML = "";

  let b1 = document.createElement("button");
  b1.className = "numpad-vrai";
  b1.textContent = a;
  b1.onclick = () => submitSpecial(a);

  let b2 = document.createElement("button");
  b2.className = "numpad-faux";
  b2.textContent = b;
  b2.onclick = () => submitSpecial(b);

  pad.appendChild(b1);
  pad.appendChild(b2);
}

function handlePad(v) {
  if (typeof v === "number") {
    $("answer").value += v;
  } else if (v === "Eff") {
    $("answer").value = $("answer").value.slice(0, -1);
  } else if (v === "OK") {
    submitAnswer();
  }
}

// --------------------------------------------------
// G√âN√âRATION DES QUESTIONS
// --------------------------------------------------
function nextQuestion() {
  state.questionCount++;
  if (state.questionCount > state.numQuestions) return finishGame();

  $("feedback").textContent = "";

  let a,b,rep,q;

  if (state.operation === "multiply" && state.selectedTables.length > 0) {
    a = state.selectedTables[rand(0, state.selectedTables.length - 1)];
    b = rand(0, 12);
    rep = a * b;
    q = `${a} √ó ${b}`;
  } else {
    let [min, max] = rangeFromLevel(state.level);
    a = rand(min, max);
    b = rand(min, max);

    switch(state.operation) {
      case "add": rep = a+b; q = `${a} + ${b}`; break;
      case "subtract": if (b > a) [a,b] = [b,a]; rep = a-b; q = `${a} ‚àí ${b}`; break;
      case "multiply": rep = a*b; q = `${a} √ó ${b}`; break;
      case "divide": rep = a; q = `${a*b} √∑ ${b}`; break;
    }
  }

  state.correctAnswer = rep;

  if (state.mode === "vrai_faux") {
    let shown = rep + (Math.random() < 0.5 ? 0 : rand(1,5));
    state.vraiFauxTrue = (shown === rep);
    q += " = " + shown;
  }

  if (state.mode === "erreur") {
    let wrong = Math.random() < 0.5;
    let shown = wrong ? rep + rand(1,3) : rep;
    state.erreur = wrong;
    q += " = " + shown;
  }

  $("question").textContent = q;
  $("progress").textContent = `${state.questionCount}/${state.numQuestions}`;

  $("answer").value = "";
  createPad();
}

// --------------------------------------------------
// VALIDATION DES REPONSES
// --------------------------------------------------
function submitSpecial(val) {
  let ok = false;
  if (state.mode === "vrai_faux") ok = (val === "vrai") === state.vraiFauxTrue;
  if (state.mode === "erreur") ok = (val === "faux") === state.erreur;

  showFeedback(ok);
}

function submitAnswer() {
  let ans = $("answer").value.trim();
  let ok = (parseInt(ans) === state.correctAnswer);
  showFeedback(ok);
}

function showFeedback(ok) {
  if (ok) {
    state.correctCount++;
    $("feedback").textContent = "‚úÖ";
    $("feedback").style.color = "#22aa22";
  } else {
    $("feedback").innerHTML = `‚ùå<br><small>R√©ponse attendue : ${state.correctAnswer}</small>`;
    $("feedback").style.color = "#d32f2f";
  }

  setTimeout(nextQuestion, 1500);
}

// --------------------------------------------------
// FIN DU JEU
// --------------------------------------------------
function finishGame() {
  state.chronoRunning = false;

  $("game").classList.add("hidden");
  $("result").classList.remove("hidden");

  $("scoreText").textContent = `Score : ${state.correctCount}/${state.numQuestions}`;

  if (state.mode === "chrono") {
    $("timeText").textContent = `‚è± Temps total : ${state.chrono.toFixed(1)}s`;
  } else {
    $("timeText").textContent = "";
  }

  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    mode: state.mode,
    score: `${state.correctCount}/${state.numQuestions}`,
    temps: state.mode === "chrono" ? state.chrono.toFixed(1) : null
  };

  new QRious({
    element: $("qr"),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$("restart").onclick = () => {
  $("result").classList.add("hidden");
  $("start").classList.remove("hidden");
};

</script>
