<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DÃ©fi MathÃ©matiques - ScanProf</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #222; 
      color: #fff; 
      margin: 0; 
      padding: 20px; 
      min-height: 100vh; 
      text-align: center;
      display: flex;
      justify-content: center;
    }

    .container { 
      width: 100%;
      max-width: 420px;
      background: #333;
      border-radius: 16px;
      box-shadow: 0 4px 16px #0007;
      padding: 10px 20px;
    }

    #welcome {
      min-height: calc(100vh - 80px);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 0;
    }

    #welcome h1 { font-size: 2.2em; margin-bottom: 20px; }

    #startApp { 
      padding: 14px 28px; 
      font-size: 1.2em; 
      background: #fff; 
      color: #000; 
      border-radius: 12px; 
      border: none; 
      cursor: pointer;
      font-weight: bold;
    }

    button.button, 
    .operation-btn, 
    .level-btn, 
    .mode-btn, 
    .questions-btn,
    .table-btn { 
      padding: 11px 22px; 
      margin: 6px; 
      border: none; 
      border-radius: 10px; 
      color: #fff; 
      font-size: 1.07em; 
      cursor: pointer; 
      outline: none; 
      box-shadow: 0 1px 4px #0005;
    }

    .button {
      background: #fff !important;
      color: #000 !important;
      font-weight: bold;
      border: 2px solid #0003;
    }

    .operation-btn[data-op="multiply"] { background: #FF9800; }
    .operation-btn[data-op="add"] { background: #2196F3; }
    .operation-btn[data-op="subtract"] { background: #8E24AA; }
    .operation-btn[data-op="divide"] { background: #E53935; }
    .op-selected { border: 2px solid #fff; }

    .level-btn[data-level="1"] { background: #A5D6A7; color: #222; }
    .level-btn[data-level="2"] { background: #FFF176; color: #222; }
    .level-btn[data-level="3"] { background: #90A4AE; }
    .level-selected { border:2px solid #fff; }

    .mode-btn[data-mode="multiplication"] { background:#4CAF50; }
    .mode-btn[data-mode="chrono"] { background:#00BCD4; }
    .mode-btn[data-mode="vrai_faux"] { background:#F06292; }
    .mode-btn[data-mode="erreur"] { background:#795548; }

    .questions-btn { background:#222; }
    .questions-selected { background:#00BCD4; border:2px solid #fff; }

    #tables-choose { margin-top: 10px; }
    .table-btn { width: 60px; background:#222; }
    .table-selected { background:#009688 !important; border:2px solid #fff; }

    input[type="text"] {
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 1.1em;
      margin: 10px auto;
      width: 70%;
      background: #222;
      color: #fff;
      text-align: center;
      display: block;
    }

    #question { font-size: 2em; margin: 20px 0; min-height: 2.2em; }

    #numpad {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: 10px;
    }

    #numpad-row {
      display: flex;
      justify-content: center;
    }

    #numpad button {
      width: 56px;
      height: 52px;
      margin: 3px;
      border-radius: 8px;
      border: none;
      background: #444;
      color: #fff;
      font-size: 1.25em;
    }

    .numpad-eff { background:#aaa !important; color:#222; }
    .numpad-ok { background:#4CAF50 !important; color:#fff !important; }

    .numpad-vrai { background:#6ac200; width:48%; height:54px; }
    .numpad-faux { background:#e94444; width:48%; height:54px; }

    #chronoBar {
      width: 100%;
      height: 14px;
      background: #555;
      border-radius: 7px;
      overflow: hidden;
      margin-top: 10px;
    }

    #chronoFill {
      height: 100%;
      background: #00e676;
      width: 100%;
      transition: width .2s linear;
    }

    #result canvas {
      margin: 20px auto;
      display: block;
    }

    .hidden { display:none !important; }
  </style>
</head>

<body>

<div class="container">

  <div id="welcome">
    <h1>ðŸŽ® DÃ©fi MathÃ©matiques</h1>
    <button id="startApp">DÃ©marrer</button>
  </div>

  <div id="start" class="hidden">

    <p>PrÃ©nom : <input id="prenom" type="text" maxlength="18"></p>
    <p>Classe : <input id="classe" type="text" maxlength="18"></p>

    <div>Type d'opÃ©ration :</div>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <div>Niveau :</div>
    <div id="level-choose"></div>

    <div>Nombre de questions :</div>
    <div id="questions-choose"></div>

    <h3>Mode :</h3>
    <div id="mode-choose"></div>

    <div id="chronoPickerContainer" class="hidden"></div>

    <button id="btn-play" class="button">Valider et jouer</button>
  </div>

  <form id="game" class="hidden" onsubmit="return false;">
    <div id="question"></div>
    <input id="answer" type="text" autocomplete="off">
    <div id="numpad"></div>
    <div id="chronoBar" class="hidden"><div id="chronoFill"></div></div>
    <p id="progress"></p>
    <p id="chronoLine"></p>
  </form>

  <div id="result" class="hidden">
    <h2>RÃ©sultat</h2>
    <p id="scoreText"></p>
    <p id="bestTimeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>
<script>
// --------------------------------------------------
// Ã‰TAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: 'multiply',
  level: 1,
  numQuestions: 10,
  prenom: '',
  classe: '',
  questionCount: 0,
  correctCount: 0,
  currentQuestion: '',
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  chronoDuration: 60,
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: []
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$('startApp').onclick = () => {
  $('welcome').classList.add('hidden');
  $('start').classList.remove('hidden');
};

// --------------------------------------------------
// BOUTONS OPÃ‰RATIONS
// --------------------------------------------------
const ops = [
  {op:"multiply", label:"Ã— Multiplication"},
  {op:"add", label:"+ Addition"},
  {op:"subtract", label:"âˆ’ Soustraction"},
  {op:"divide", label:"Ã· Division"}
];

ops.forEach(o=>{
  let b=document.createElement("button");
  b.className="operation-btn";
  b.dataset.op=o.op;
  b.textContent=o.label;
  b.onclick=()=>{
    state.operation=o.op;
    document.querySelectorAll('.operation-btn').forEach(x=>x.classList.remove('op-selected'));
    b.classList.add('op-selected');

    $('tables-choose').classList.toggle('hidden', o.op!=="multiply");
    if (o.op !== "multiply") {
      state.selectedTables = [];
      document.querySelectorAll(".table-btn").forEach(t=>t.classList.remove("table-selected"));
    }
  };
  $('op-choose').appendChild(b);
});
document.querySelector('.operation-btn[data-op="multiply"]').classList.add('op-selected');

// --------------------------------------------------
// TABLES PERSONNALISÃ‰ES
// --------------------------------------------------
let tableBox = "";
for(let i=1;i<=12;i++){
  tableBox += `<button class="table-btn" data-table="${i}">${i}</button>`;
}
$('tables-choose').innerHTML = "<h3>Tables personnalisÃ©es :</h3>" + tableBox;

document.querySelectorAll(".table-btn").forEach(btn=>{
  btn.onclick=()=>{
    let val=parseInt(btn.dataset.table);
    if(state.selectedTables.includes(val)){
      state.selectedTables = state.selectedTables.filter(x=>x!==val);
      btn.classList.remove("table-selected");
    } else {
      state.selectedTables.push(val);
      btn.classList.add("table-selected");
    }
  };
});

// --------------------------------------------------
// NIVEAUX
// --------------------------------------------------
[1,2,3].forEach(l=>{
  let b=document.createElement("button");
  b.className="level-btn";
  b.dataset.level=l;
  b.textContent="Niveau "+l;
  b.onclick=()=>{
    state.level=l;
    document.querySelectorAll('.level-btn').forEach(x=>x.classList.remove('level-selected'));
    b.classList.add('level-selected');
  };
  $('level-choose').appendChild(b);
});
document.querySelector('.level-btn[data-level="1"]').classList.add('level-selected');

// --------------------------------------------------
// NOMBRE DE QUESTIONS
// --------------------------------------------------
[10,15,20].forEach(q=>{
  let b=document.createElement("button");
  b.className="questions-btn";
  b.dataset.q=q;
  b.textContent=q;
  b.onclick=()=>{
    state.numQuestions=q;
    document.querySelectorAll('.questions-btn').forEach(x=>x.classList.remove('questions-selected'));
    b.classList.add('questions-selected');
  };
  $('questions-choose').appendChild(b);
});
document.querySelector('.questions-btn[data-q="10"]').classList.add('questions-selected');

// --------------------------------------------------
// MODES
// --------------------------------------------------
const modes = [
  {m:"multiplication", label:"Classique"},
  {m:"chrono", label:"Chrono"},
  {m:"vrai_faux", label:"Vrai/Faux"},
  {m:"erreur", label:"Erreur"}
];

modes.forEach(o=>{
  let b=document.createElement("button");
  b.className="mode-btn";
  b.dataset.mode=o.m;
  b.textContent=o.label;
  b.onclick=()=>{
    state.mode=o.m;
    document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('mode-selected'));
    b.classList.add('mode-selected');
    $('chronoPickerContainer').classList.toggle('hidden', o.m!=="chrono");
  };
  $('mode-choose').appendChild(b);
});
document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add('mode-selected');

// --------------------------------------------------
// CHOIX TEMPS VERSION SIMPLE
// --------------------------------------------------
let timeSelector = document.createElement("select");
timeSelector.style.fontSize = "1.2em";
timeSelector.style.padding = "8px";
timeSelector.style.borderRadius = "8px";

for(let t=5;t<=120;t+=5){
  let opt=document.createElement("option");
  opt.value=t;
  opt.textContent = t + " sec";
  timeSelector.appendChild(opt);
}
timeSelector.onchange = ()=> state.chronoDuration = parseInt(timeSelector.value);
$('chronoPickerContainer').appendChild(timeSelector);

// --------------------------------------------------
// LANCEMENT DU JEU
// --------------------------------------------------
$('btn-play').onclick = () => {

  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if (!state.prenom || !state.classe) {
    alert("Merci dâ€™entrer un prÃ©nom et une classe.");
    return;
  }

  state.questionCount = 0;
  state.correctCount = 0;

  $('start').classList.add('hidden');
  $('result').classList.add('hidden');
  $('game').classList.remove('hidden');

  if(state.mode==="chrono"){
    state.chronoStart = Date.now();
    $('chronoBar').classList.remove("hidden");
    startChronoDisplay();
  } else {
    $('chronoBar').classList.add("hidden");
  }

  nextQuestion();
};

// --------------------------------------------------
// TIMER VISUEL
// --------------------------------------------------
let chronoInterval = null;

function startChronoDisplay(){
  if(chronoInterval) clearInterval(chronoInterval);

  let total = state.chronoDuration;

  chronoInterval = setInterval(()=>{
    let elapsed = Math.floor((Date.now() - state.chronoStart)/1000);
    let remaining = Math.max(0, total - elapsed);
    $('chronoFill').style.width = (remaining/total*100)+"%";

    if(elapsed >= total){
      clearInterval(chronoInterval);
      submitAnswer();
    }
  },200);
}

function stopChrono(){
  if(chronoInterval) clearInterval(chronoInterval);
  state.chronoTime = Math.floor((Date.now()-state.chronoStart)/1000);
}

// --------------------------------------------------
// UTILITAIRES
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getRangeFromLevel(level){
  if(level===1) return [1,9];
  if(level===2) return [10,20];
  return [10,99];
}

// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createContextualPad(){
  const pad = $('numpad');
  pad.innerHTML = "";

  if(state.mode==="vrai_faux"){
    return createTrueFalseButtons("vrai","faux");
  }
  if(state.mode==="erreur"){
    return createTrueFalseButtons("juste","faux");
  }

  const rows = [
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ['Eff',0,'OK']
  ];

  rows.forEach(r=>{
    let line=document.createElement("div");
    line.id="numpad-row";
    r.forEach(v=>{
      let b=document.createElement("button");
      b.textContent=v;
      if(v==="Eff") b.className="numpad-eff";
      if(v==="OK") b.className="numpad-ok";
      b.onclick = ()=>handleNumpad(v);
      line.appendChild(b);
    });
    pad.appendChild(line);
  });
}

function createTrueFalseButtons(txt1,txt2){
  const pad = $('numpad');
  pad.innerHTML = "";

  let b1=document.createElement("button");
  b1.className="numpad-vrai";
  b1.textContent=txt1;
  b1.onclick=()=>{ $('answer').value=txt1; submitAnswer(); };

  let b2=document.createElement("button");
  b2.className="numpad-faux";
  b2.textContent=txt2;
  b2.onclick=()=>{ $('answer').value=txt2; submitAnswer(); };

  pad.appendChild(b1);
  pad.appendChild(b2);
}

function handleNumpad(v){
  let input=$('answer');

  if(typeof v==="number"){
    input.value += v;
  }
  else if(v==="Eff"){
    input.value = input.value.slice(0,-1);
  }
  else if(v==="OK"){
    submitAnswer();
  }
}

// --------------------------------------------------
// GÃ‰NERATION QUESTION
// --------------------------------------------------
function nextQuestion(){
  state.questionCount++;
  if(state.questionCount > state.numQuestions){
    return finishGame();
  }

  let a,b,rep,quest;

  if(state.operation==="multiply" && state.selectedTables.length>0){
    a = state.selectedTables[randInt(0,state.selectedTables.length-1)];
    b = randInt(0,12);
    rep = a*b;
    quest = `${a} Ã— ${b}`;
  } else {
    let [min,max] = getRangeFromLevel(state.level);
    a = randInt(min,max);
    b = randInt(min,max);

    switch(state.operation){
      case "add": rep=a+b; quest=`${a} + ${b}`; break;
      case "subtract": if(b>a)[a,b]=[b,a]; rep=a-b; quest=`${a} âˆ’ ${b}`; break;
      case "multiply": rep=a*b; quest=`${a} Ã— ${b}`; break;
      case "divide": rep=a; quest=`${a*b} Ã· ${b}`; break;
    }
  }

  state.correctAnswer = rep;

  if(state.mode==="vrai_faux"){
    let shown = rep + (Math.random()<0.5 ? 0 : randInt(1,5));
    state.vraiFauxIsTrue = (shown===rep);
    quest += " = " + shown;
  }

  if(state.mode==="erreur"){
    let wrong = Math(random()<0.5);
    let shown = wrong ? rep + randInt(1,3) : rep;
    state.erreurQuestion = wrong;
    quest += " = " + shown;
  }

  state.currentQuestion = quest;

  $('question').textContent = quest;
  $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;
  $('answer').value="";
  $('answer').focus();

  createContextualPad();
}

// --------------------------------------------------
// VALIDATION
// --------------------------------------------------
function submitAnswer(){
  let ans = $('answer').value.trim().toLowerCase();
  let ok = false;

  if(state.mode==="multiplication" || state.mode==="chrono"){
    ok = (parseInt(ans) === state.correctAnswer);
  }

  if(state.mode==="vrai_faux"){
    ok = (/^(vrai|true|1)$/i.test(ans) === state.vraiFauxIsTrue);
  }

  if(state.mode==="erreur"){
    let juste = /^(juste|true|1)$/i.test(ans);
    let faux  = /^(faux|false|0)$/i.test(ans);
    ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
  }

  if(ok) state.correctCount++;
  nextQuestion();
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){

  if(state.mode==="chrono"){
    stopChrono();
    if(state.bestTime===null || state.chronoTime < state.bestTime){
      state.bestTime = state.chronoTime;
      localStorage.setItem("bestTime", state.bestTime);
    }
  }

  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

  if(state.mode==="chrono"){
    $('bestTimeText').textContent = 
      `â± Temps : ${state.chronoTime}s â€” Record : ${state.bestTime}s`;
  } else {
    $('bestTimeText').textContent = "";
  }

  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    infos: `${state.operation} N${state.level} ${state.correctCount}/${state.numQuestions}`,
    temps: state.chronoTime ?? null
  };

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$('restart').onclick = ()=>{
  $('result').classList.add('hidden');
  $('start').classList.remove('hidden');
};
</script>
