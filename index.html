<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Math√©matiques - ScanProf</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #222; color: #fff; margin: 0; padding: 20px; min-height: 100vh; text-align: center;}
    .container { max-width: 400px; margin: 0 auto; background: #333; border-radius: 16px; box-shadow: 0 4px 16px #0007; padding: 20px; }
    h1 { font-size: 2em; margin: 8px 0 18px; }
    button.button, .operation-btn, .level-btn, .mode-btn, .questions-btn { padding: 11px 22px; margin: 6px; border: none; border-radius: 10px; color: #fff; font-size: 1.07em; cursor: pointer; margin-top: 7px; transition: background .22s; outline: none; box-shadow: 0 1px 4px #0005; }
    .operation-btn[data-op="multiply"] { background: #FF9800; }
    .operation-btn[data-op="add"]      { background: #2196F3; }
    .operation-btn[data-op="subtract"] { background: #8E24AA; }
    .operation-btn[data-op="divide"]   { background: #E53935; }
    .op-selected[data-op="multiply"], .op-selected[data-op="add"], .op-selected[data-op="subtract"], .op-selected[data-op="divide"] { border: 2px solid #fff; filter: brightness(1.2);}
    .level-btn[data-level="1"] { background: #A5D6A7; color: #222; }
    .level-btn[data-level="2"] { background: #FFF176; color: #222; }
    .level-btn[data-level="3"] { background: #90A4AE; color: #fff; }
    .level-selected { box-shadow: 0 0 1px 3px #fff3; border:2px solid #fff; filter: brightness(1.09);}
    .mode-btn[data-mode="multiplication"] { background:#4CAF50; }
    .mode-btn[data-mode="chrono"]         { background:#00BCD4; }
    .mode-btn[data-mode="vrai_faux"]      { background:#F06292; }
    .mode-btn[data-mode="erreur"]         { background:#795548; }
    .mode-selected { box-shadow:0 0 1px 3px #fff3; border:2px solid #fff; filter: brightness(1.09);}
    .questions-btn { background: #222; color: #fff;}
    .questions-selected { background: #00BCD4; color: #fff; border:2px solid #fff; }
    input[type="text"] { padding: 10px; border-radius: 8px; border: none; font-size: 1.1em; margin: 10px; width: 70%; background: #222; color: #fff; outline: none; text-align: center; margin-bottom: 18px; }
    #question { font-size: 2em; margin: 19px 0 10px; min-height: 2.2em;}
    #btn-help { margin-top: 8px; margin-bottom: 10px; background: #757575; }
    #helpbox { display:none; background:#263238; color:#fff; border-radius:10px; padding:18px; box-shadow: 0 4px 16px #0007; margin:18px 0;}
    #close-help { background:#e53935; color:#fff; margin-top:7px;}
    @media (max-width:600px) {.container { max-width: 98%; } body { padding: 7px; } h1 { font-size: 1.35em; } #question { font-size: 1.18em; } #numpad button { font-size: 1.1em !important; width: 43px !important; height: 39px !important;} #numpad .numpad-vrai, #numpad .numpad-faux { width: 48% !important; min-width:100px !important; }}
    #result canvas { margin: 20px auto; display: block; }
    .hidden { display: none !important; }
    #numpad { margin: 10px 0 10px 0; }
    #numpad button { width: 56px; height: 52px; font-size: 1.25em; margin: 3px; border-radius: 8px; border: none; background: #444; color: #fff; cursor: pointer; transition: background .18s; display: inline-block; outline: none; user-select: none;}
    #numpad button.numpad-eff { background: #aaa; color: #222; }
    #numpad button.numpad-ok  { background: #4CAF50; }
    #numpad .numpad-vrai { background: #6ac200; color: #fff; width: 48%; min-width:140px; height: 54px; font-size: 1.19em; margin:8px 1vw;}
    #numpad .numpad-faux { background: #e94444; color: #fff; width: 48%; min-width:140px; height: 54px; font-size: 1.19em; margin:8px 1vw;}
    #numpad button:active { background: #666; }
    .op-choose-label { font-size: 1.07em; margin-top:18px;}
  </style>
</head>
<body>
<div class="container">
  <h1>üéÆ D√©fi Math√©matiques</h1>
  <button id="btn-help">AIDE / Mode d'emploi</button>
  <div id="helpbox">
    <strong>Comment utiliser l'application ?</strong><br><br>
    <b>1. Choisis ton pr√©nom et ta classe.</b><br>
    <b>2. S√©lectionne le type d'exercice :</b><br>
    <span style="color:#FF9800;">Multiplication</span> (tables)<br>
    <span style="color:#2196F3;">Addition</span> (somme)<br>
    <span style="color:#8E24AA;">Soustraction</span> (calculer la diff√©rence)<br>
    <span style="color:#E53935;">Division</span> (division pos√©e, r√©sultat entier)<br><br>
    <b>3. Choisis ton niveau de difficult√© :</b><br>
    <span style="color:#A5D6A7;">Niveau 1</span> (1-9)<br>
    <span style="color:#FFF176;">Niveau 2</span> (10-20)<br>
    <span style="color:#90A4AE;">Niveau 3</span> (jusqu'√† 99)<br><br>
    <b>4. S√©lectionne ton mode de jeu :</b><br>
    <span style="color:#4CAF50;">Classique</span>, <span style="color:#00BCD4;">Chrono</span>, <span style="color:#F06292;">Vrai/Faux</span>, <span style="color:#795548;">Trouve l'Erreur</span><br><br>
    <b>5. Choisis le nombre de questions :</b> (10 / 15 / 20 / 25 / 30 / 35 / 40)<br><br>
    <b>6. Valide et commence : utilise le pav√© num√©rique ou les boutons Vrai/Faux pour r√©pondre selon le mode.</b><br><br>
    <b>QR Code ScanProf :</b><br>
    Le QR affich√© r√©sume ton score et o√π tu dois progresser (ex‚ÄØ: "Addition N2 13/20, √† r√©viser‚ÄØ: Soustraction"). Donne-le √† ton enseignant pour le scanner.
    <br><br>
    <button id="close-help">Fermer l'aide</button>
  </div>
  <div id="start">
    <p>Pr√©nom : <input id="prenom" type="text" autocomplete="off" maxlength="18" placeholder="Pr√©nom"></p>
    <p>Classe : <input id="classe" type="text" autocomplete="off" maxlength="18" placeholder="Classe"></p>
    <div class="op-choose-label">Type d'op√©ration :</div>
    <div id="op-choose">
      <button type="button" class="operation-btn" data-op="multiply">√ó Multiplication</button>
      <button type="button" class="operation-btn" data-op="add">+ Addition</button>
      <button type="button" class="operation-btn" data-op="subtract">‚àí Soustraction</button>
      <button type="button" class="operation-btn" data-op="divide">√∑ Division</button>
    </div>
    <div id="op-chosen" style="margin:12px;font-size:1.12em;"></div>
    <div class="op-choose-label">Niveau de difficult√© :</div>
    <div id="level-choose">
      <button type="button" class="level-btn" data-level="1">Niveau 1</button>
      <button type="button" class="level-btn" data-level="2">Niveau 2</button>
      <button type="button" class="level-btn" data-level="3">Niveau 3</button>
    </div>
    <div id="level-chosen" style="margin:12px;font-size:1.12em;"></div>
    <div class="op-choose-label">Nombre de questions :</div>
    <div id="questions-choose">
      <button type="button" class="questions-btn" data-q="10">10</button>
      <button type="button" class="questions-btn" data-q="15">15</button>
      <button type="button" class="questions-btn" data-q="20">20</button>
      <button type="button" class="questions-btn" data-q="25">25</button>
      <button type="button" class="questions-btn" data-q="30">30</button>
      <button type="button" class="questions-btn" data-q="35">35</button>
      <button type="button" class="questions-btn" data-q="40">40</button>
    </div>
    <div id="questions-chosen" style="margin:12px;font-size:1.12em;"></div>
    <h3>Choisir un mode :</h3>
    <div id="mode-choose" style="margin-bottom:12px;">
      <button type="button" class="mode-btn" data-mode="multiplication">Classique</button>
      <button type="button" class="mode-btn" data-mode="chrono">Chrono</button>
      <button type="button" class="mode-btn" data-mode="vrai_faux">Vrai/Faux</button>
      <button type="button" class="mode-btn" data-mode="erreur">Trouve l'Erreur</button>
    </div>
    <button type="button" class="button" id="btn-play">Valider et jouer</button>
  </div>
  <form id="game" class="hidden" autocomplete="off" onsubmit="return false;">
    <div id="question"></div>
    <input id="answer" type="text" autocomplete="off" maxlength="10" inputmode="numeric" pattern="[0-9]*">
    <br>
    <div id="numpad"></div>
    <button type="submit" class="button">Valider</button>
    <p id="progress" style="margin-top:12px; font-size:1.07em;"></p>
    <p id="chronoLine" style="font-size:1em;"></p>
  </form>
  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText" style="font-size:1.15em;"></p>
    <p id="advice" style="font-size:1.1em; margin-bottom:13px;"></p>
    <canvas id="qr"></canvas>
    <br>
    <button type="button" id="restart" class="button">Rejouer</button>
  </div>
</div>
<script defer>
let state = {
  mode: null, operation:'multiply', level:1, numQuestions:10, prenom:'', classe:'',
  questionCount: 0, correctCount: 0,
  currentQuestion: '', correctAnswer: null,
  mistakes: {},
  vraiFauxIsTrue: false, erreurQuestion: false,
  startTime: null, endTime: null
};
const operationColors = { multiply: '#FF9800', add: '#2196F3', subtract: '#8E24AA', divide: '#E53935' };
const levelColors = { 1: '#A5D6A7', 2: '#FFF176', 3: '#90A4AE' };
const modeColors = { multiplication:'#4CAF50', chrono:'#00BCD4', vrai_faux:'#F06292', erreur:'#795548' };
const $ = id => document.getElementById(id);

document.getElementById('btn-help').onclick = () => { $('helpbox').style.display = 'block'; };
document.getElementById('close-help').onclick = () => { $('helpbox').style.display = 'none'; };

// Op√©ration
document.querySelectorAll('#op-choose .operation-btn').forEach(btn => {
  btn.onclick = () => {
    state.operation = btn.dataset.op;
    document.querySelectorAll('#op-choose .operation-btn').forEach(b=>b.classList.remove("op-selected"));
    btn.classList.add("op-selected");
    let txt={ multiply:"Multiplication",add:"Addition",subtract:"Soustraction",divide:"Division" };
    $('op-chosen').textContent="Vous travaillerez : "+txt[state.operation];
    $('op-chosen').style.background = operationColors[state.operation];
    $('op-chosen').style.color = "#fff";
  };
});
document.querySelector('.operation-btn[data-op="multiply"]').click();

// Niveau
document.querySelectorAll('#level-choose .level-btn').forEach(btn => {
  btn.onclick = () => {
    state.level = parseInt(btn.dataset.level);
    document.querySelectorAll('#level-choose .level-btn').forEach(b=>b.classList.remove("level-selected"));
    btn.classList.add("level-selected");
    $('level-chosen').textContent = "Niveau choisi : " + btn.textContent;
    $('level-chosen').style.background = levelColors[state.level];
    $('level-chosen').style.color = state.level==2 ? "#222" : "#fff";
  };
});
document.querySelector('.level-btn[data-level="1"]').click();

// Nombre de questions
document.querySelectorAll('#questions-choose .questions-btn').forEach(btn => {
  btn.onclick = () => {
    state.numQuestions = parseInt(btn.dataset.q);
    document.querySelectorAll('#questions-choose .questions-btn').forEach(b=>b.classList.remove("questions-selected"));
    btn.classList.add("questions-selected");
    $('questions-chosen').textContent = "Tu r√©pondras √† "+btn.textContent+" questions";
  };
});
document.querySelector('.questions-btn[data-q="10"]').click();

// Mode
document.querySelectorAll('#mode-choose .mode-btn').forEach(btn => {
  btn.onclick = () => {
    state.mode = btn.dataset.mode;
    document.querySelectorAll('#mode-choose .mode-btn').forEach(b=>b.classList.remove("mode-selected"));
    btn.classList.add("mode-selected");
  };
});
document.querySelector('.mode-btn[data-mode="multiplication"]').click();

$('btn-play').onclick = () => {
  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();
  if (!state.prenom || !state.classe) { alert("Merci d‚Äôentrer un pr√©nom et une classe."); return; }
  if (!state.operation) { alert("Merci de choisir le type d'op√©ration !"); return;}
  if (!state.level) { alert("Merci de choisir un niveau !"); return;}
  if(!state.mode){ alert("Merci de choisir un mode !"); return;}
  Object.assign(state, {
    questionCount:0, correctCount:0, mistakes:{}, startTime: Date.now()
  });
  hide($('start')); hide($('result')); show($('game'));
  $('chronoLine').textContent = '';
  nextQuestion();
};

function getRangeFromLevel(level) {
  if(level === 1) return [1,9];
  if(level === 2) return [10,20];
  if(level === 3) return [10,99];
  return [1,9];
}
function show(el) { el.classList.remove('hidden'); }
function hide(el) { el.classList.add('hidden'); }
function resetInput(inp) { inp.value = ''; inp.placeholder = ''; inp.focus(); }
function randInt(min,max) { return Math.floor(Math.random()*(max-min+1))+min; }

function nextQuestion() {
  let total = state.numQuestions;
  state.questionCount++;
  if (state.questionCount > total) return finishGame();

  let op = state.operation;
  let [min,max] = getRangeFromLevel(state.level||1);
  let a = randInt(min,max), b = randInt(min,max), quest='', rep=null;
  switch(op){
    case 'add':      quest = `${a} + ${b}`; rep = a+b; break;
    case 'subtract': if(b>a) [a,b]=[b,a]; quest = `${a} ‚àí ${b}`; rep = a-b; break;
    case 'multiply': quest = `${a} √ó ${b}`; rep = a*b; break;
    case 'divide':   rep = a; let prod=a*b; quest = `${prod} √∑ ${b}`; break;
  }
  state.currentQuestion = quest;
  state.correctAnswer = rep;
  state.mistakes[`op_${op}`] ??= 0;

  if(state.mode==="multiplication"||state.mode==="chrono"){
    showQuestion(quest,"R√©ponds :",operationColors[op]);
    $('answer').placeholder="";
    $('chronoLine').style.background = modeColors[state.mode];
    $('chronoLine').style.color = "#fff";
    if(state.mode==="chrono") $('chronoLine').textContent="Mode chronom√©tr√© : Vise la rapidit√© !";
    else $('chronoLine').textContent="";
  }
  else if(state.mode==="vrai_faux"){
    let corr = Math.random() < .5;
    let value = rep;
    if(!corr){
      let fake = rep + (op==="subtract"?randInt(-2,2):randInt(1,5));
      if(op==="subtract" && fake===rep) fake += 1;
      if(op==="divide" && fake<=0) fake = rep + randInt(1,3);
      value = fake;
    }
    state.currentQuestion=quest+" = "+value;
    state.vraiFauxIsTrue = (value===rep);
    showQuestion(state.currentQuestion,"Vrai ou Faux ?",operationColors[op]);
    $('answer').placeholder="vrai / faux";
  }
  else if(state.mode==='erreur'){
    let isWrong = Math.random() < .5;
    let value=rep;
    if(isWrong){
      value+= (op==="subtract"?randInt(-2,2):randInt(1,3));
      if(op==="divide" && value<=0) value=rep+randInt(1,3);
    }
    state.erreurQuestion = isWrong;
    state.currentQuestion = quest+" = "+value;
    showQuestion(state.currentQuestion,"Juste ou Faux ?",operationColors[op]);
    $('answer').placeholder="juste / faux";
  }
  $('progress').textContent = `${state.questionCount}/${total}`;
  resetInput($('answer'));
  createContextualPad();
}
function createContextualPad() {
  const pad = document.getElementById("numpad");
  pad.innerHTML = "";
  if(state.mode === "vrai_faux") {
    let b1 = document.createElement("button");
    b1.type = "button"; b1.textContent = "Vrai"; b1.className = "numpad-vrai";
    b1.onclick = function() { $("answer").value = "vrai"; submitAnswer(); };
    let b2 = document.createElement("button");
    b2.type = "button"; b2.textContent = "Faux"; b2.className = "numpad-faux";
    b2.onclick = function() { $("answer").value = "faux"; submitAnswer(); };
    pad.appendChild(b1); pad.appendChild(b2);
  } else {
    const digits = [[1,2,3],[4,5,6],[7,8,9],['Eff',0,'OK']];
    digits.forEach(row => {
      row.forEach(val => {
        const b = document.createElement("button");
        b.type = "button"; b.textContent = val;
        if(val==='Eff') b.className = "numpad-eff";
        if(val==='OK')  b.className = "numpad-ok";
        b.onclick = () => handleNumpad(val);
        pad.appendChild(b);
      });
      pad.appendChild(document.createElement("br"));
    });
  }
}
function handleNumpad(val) {
  const input = document.getElementById("answer");
  if(typeof val === "number") { input.value += val; input.focus(); }
  else if(val === "Eff") { input.value = input.value.slice(0, -1); input.focus(); }
  else if(val==='OK') { submitAnswer(); }
}
function showQuestion(text,prompt,color) {
  $('question').textContent = text + (prompt ? ' ('+prompt+')' : '');
  $('question').style.color = color || '#fff';
}
$('game').onsubmit = submitAnswer;
$('answer').onkeydown = e => { if(e.key==="Enter") submitAnswer(); };
function submitAnswer(e) {
  if(e) e.preventDefault && e.preventDefault();
  let ans = $('answer').value.trim().toLowerCase(), op = state.operation;
  let result = false;
  if(state.mode==='multiplication'||state.mode==='chrono'){
    if(op==='divide'){
      if(parseInt(ans) == state.correctAnswer) result=true;
      else registerMistake(op);
    }
    else {
      if(parseInt(ans) === state.correctAnswer) result=true;
      else registerMistake(op);
    }
  }
  else if(state.mode==='vrai_faux'){
    let userTrue = /^(vrai|1|true)$/i.test(ans);
    result = userTrue === state.vraiFauxIsTrue;
    if(!result) registerMistake(op);
  }
  else if(state.mode==='erreur'){
    let userWrong = /^(faux|false|0)$/i.test(ans), userJust = /^(juste|1|true)$/i.test(ans);
    result = (state.erreurQuestion && userWrong) || (!state.erreurQuestion && userJust);
    if(!result) registerMistake(op);
  }
  if(result) state.correctCount++;
  nextQuestion();
}
function registerMistake(opType) { state.mistakes[`op_${opType}`]++; }
function finishGame() {
  hide($('game')); show($('result'));
  state.endTime = Date.now();
  let totalQ = state.numQuestions;
  let opfr = {multiply:"Multiplication",add:"Addition",subtract:"Soustraction",divide:"Division"};
  let conseilArr = [];
  for(let op in state.mistakes){
    if(state.mistakes[op]>0) {
      conseilArr.push(opfr[op.replace('op_','')]);
    }
  }
  let conseilMsg = conseilArr.length ? "√Ä r√©viser : " + conseilArr.join(', ') : "Excellent !";
  $('scoreText').textContent = `Score : ${opfr[state.operation]} N${state.level} ${state.correctCount}/${totalQ}`;
  $('advice').textContent = conseilMsg;

  // QR : seulement r√©sultat et conseils
  let qrData = {
    resultat: `${opfr[state.operation]} N${state.level} ${state.correctCount}/${totalQ}`,
    conseil: conseilMsg
  };
  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}
$('restart').onclick = () => {
  hide($('result')); show($('start'));
  $('prenom').focus();
};
window.onload = () => {$('prenom').focus();};
</script>
</body>
</html>
