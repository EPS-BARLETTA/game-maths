<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DÃ©fi MathÃ©matiques - ScanProf</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #222; 
      color: #fff; 
      margin: 0; 
      padding: 20px; 
      min-height: 100vh; 
      text-align: center;
    }

    .container { 
      max-width: 400px; 
      margin: 0 auto; 
      background: #333; 
      border-radius: 16px; 
      box-shadow: 0 4px 16px #0007; 
      padding: 10px 20px; /* rÃ©duit */
    }

    /* PAGE DE GARDE RÃ‰DUITE */
    #welcome {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 40vh;   /* avant 60vh */
      padding-top: 10px;
      padding-bottom: 10px;
    }

    #welcome h1 { font-size: 2em; margin-bottom: 20px; }

    #startApp { 
      padding: 14px 28px; 
      font-size: 1.2em; 
      background: #fff; 
      color: #000; 
      border-radius: 12px; 
      border: none; 
      cursor: pointer;
      font-weight: bold;
    }

    h1 { font-size: 2em; margin: 8px 0 18px; }

    button.button, 
    .operation-btn, 
    .level-btn, 
    .mode-btn, 
    .questions-btn,
    .table-btn { 
      padding: 11px 22px; 
      margin: 6px; 
      border: none; 
      border-radius: 10px; 
      color: #fff; 
      font-size: 1.07em; 
      cursor: pointer; 
      margin-top: 7px; 
      transition: background .22s; 
      outline: none; 
      box-shadow: 0 1px 4px #0005;
    }

    /* BOUTON BLANC */
    .button {
      background: #ffffff !important;
      color: #000 !important;
      font-weight: bold;
      border: 2px solid #00000033;
    }

    /* Couleurs boutons */
    .operation-btn[data-op="multiply"] { background: #FF9800; }
    .operation-btn[data-op="add"]      { background: #2196F3; }
    .operation-btn[data-op="subtract"] { background: #8E24AA; }
    .operation-btn[data-op="divide"]   { background: #E53935; }
    .op-selected { border: 2px solid #fff; filter: brightness(1.2); }

    .level-btn[data-level="1"] { background: #A5D6A7; color: #222; }
    .level-btn[data-level="2"] { background: #FFF176; color: #222; }
    .level-btn[data-level="3"] { background: #90A4AE; }
    .level-selected { border:2px solid #fff; filter: brightness(1.1); }

    .mode-btn[data-mode="multiplication"] { background:#4CAF50; }
    .mode-btn[data-mode="chrono"]         { background:#00BCD4; }
    .mode-btn[data-mode="vrai_faux"]      { background:#F06292; }
    .mode-btn[data-mode="erreur"]         { background:#795548; }
    .mode-selected { border:2px solid #fff; filter: brightness(1.1); }

    .questions-btn { background: #222; }
    .questions-selected { background:#00BCD4; border:2px solid #fff; }

    /* TABLES PERSONNALISÃ‰ES */
    #tables-choose { margin-top: 10px; }
    .table-btn { 
      background: #222;
      width: 60px;
      display: inline-block;
    }
    .table-selected {
      background: #009688 !important;
      border: 2px solid #fff;
    }

    input[type="text"] {
      padding: 10px; 
      border-radius: 8px; 
      border: none; 
      font-size: 1.1em; 
      margin: 10px auto; 
      width: 70%; 
      background: #222; 
      color: #fff; 
      text-align: center;
      display: block;
    }

    #question { font-size: 2em; margin: 20px 0; min-height: 2.2em; }

    /* NUMPAD */
    #numpad button {
      width: 56px; 
      height: 52px; 
      font-size: 1.25em; 
      margin: 3px; 
      border-radius: 8px; 
      border: none; 
      background: #444; 
      color: #fff; 
      cursor: pointer;
    }
    #numpad .numpad-eff { background: #aaa; color: #222; }
    #numpad .numpad-ok  { background: #4CAF50; }

    /* VRAI / FAUX */
    #numpad .numpad-vrai { background: #6ac200; width: 48%; height: 54px; }
    #numpad .numpad-faux { background: #e94444; width: 48%; height: 54px; }

    /* TIMER VISUEL */
    #chronoBar {
      width: 100%;
      height: 14px;
      background: #555;
      border-radius: 7px;
      overflow: hidden;
      margin-top: 10px;
    }
    #chronoFill {
      height: 100%;
      width: 100%;
      background: #00e676;
      transition: width 0.2s linear;
    }

    .hidden { display: none !important; }

    #result canvas { margin: 20px auto; display: block; }

    /* ðŸŽ¡ ROULETTE iPHONE 3D (OPTION C) */
    #chronoPickerContainer {
      margin-top: 12px;
      margin-bottom: 10px;
    }

    .wheel {
      width: 100%;
      height: 260px; /* grande roulette option C */
      overflow: hidden;
      position: relative;
      perspective: 1000px;
      margin: 10px auto;
    }

    .wheel-list {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      transform-style: preserve-3d;
      transform: translateY(-50%);
    }

    .wheel-item {
      height: 40px;
      line-height: 40px;
      font-size: 1.4em;
      color: #fff;
      transform-origin: center center -120px;
    }

    .wheel-highlight {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 40px;
      margin-top: -20px;
      border-top: 2px solid #fff;
      border-bottom: 2px solid #fff;
      pointer-events: none;
    }

  </style>
</head>
<body>

<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>ðŸŽ® DÃ©fi MathÃ©matiques</h1>
    <button id="startApp">DÃ©marrer</button>
  </div>

  <!-- MENU PRINCIPAL -->
  <div id="start" class="hidden">
    <p>PrÃ©nom : <input id="prenom" type="text" maxlength="18"></p>
    <p>Classe : <input id="classe" type="text" maxlength="18"></p>

    <div>Type d'opÃ©ration :</div>
    <div id="op-choose">
      <button class="operation-btn" data-op="multiply">Ã— Multiplication</button>
      <button class="operation-btn" data-op="add">+ Addition</button>
      <button class="operation-btn" data-op="subtract">âˆ’ Soustraction</button>
      <button class="operation-btn" data-op="divide">Ã· Division</button>
    </div>

    <!-- TABLES PERSONNALISÃ‰ES (uniquement si multiplication) -->
    <div id="tables-choose" class="hidden">
      <h3>Tables personnalisÃ©es :</h3>
      <div>
        <!-- 12 tables -->
        <button class="table-btn" data-table="1">1</button>
        <button class="table-btn" data-table="2">2</button>
        <button class="table-btn" data-table="3">3</button>
        <button class="table-btn" data-table="4">4</button>
        <button class="table-btn" data-table="5">5</button>
        <button class="table-btn" data-table="6">6</button>
        <button class="table-btn" data-table="7">7</button>
        <button class="table-btn" data-table="8">8</button>
        <button class="table-btn" data-table="9">9</button>
        <button class="table-btn" data-table="10">10</button>
        <button class="table-btn" data-table="11">11</button>
        <button class="table-btn" data-table="12">12</button>
      </div>
      <small>(Tu peux en choisir plusieurs)</small>
    </div>

    <div>Niveau :</div>
    <div id="level-choose">
      <button class="level-btn" data-level="1">Niveau 1</button>
      <button class="level-btn" data-level="2">Niveau 2</button>
      <button class="level-btn" data-level="3">Niveau 3</button>
    </div>

    <div>Nombre de questions :</div>
    <div id="questions-choose">
      <button class="questions-btn" data-q="10">10</button>
      <button class="questions-btn" data-q="15">15</button>
      <button class="questions-btn" data-q="20">20</button>
    </div>

    <h3>Choisir un mode :</h3>
    <div id="mode-choose">
      <button class="mode-btn" data-mode="multiplication">Classique</button>
      <button class="mode-btn" data-mode="chrono">Chrono</button>
      <button class="mode-btn" data-mode="vrai_faux">Vrai/Faux</button>
      <button class="mode-btn" data-mode="erreur">Erreur</button>
    </div>

    <!-- ROULETTE iPHONE 3D POUR LE CHRONO -->
    <div id="chronoPickerContainer" class="hidden">
      <h3>DurÃ©e du chrono :</h3>

      <div class="wheel" id="chronoWheel">
        <div class="wheel-list" id="chronoWheelList"></div>
        <div class="wheel-highlight"></div>
      </div>
    </div>

    <button id="btn-play" class="button">Valider et jouer</button>
  </div>

  <!-- JEU -->
  <form id="game" class="hidden" onsubmit="return false;">
    <div id="question"></div>
    <input id="answer" type="text" maxlength="10" autocomplete="off">
    <div id="numpad"></div>

    <!-- TIMER VISUEL -->
    <div id="chronoBar" class="hidden">
      <div id="chronoFill"></div>
    </div>

    <p id="progress"></p>
    <p id="chronoLine"></p>
  </form>

  <!-- RÃ‰SULTATS -->
  <div id="result" class="hidden">
    <h2>RÃ©sultat</h2>
    <p id="scoreText"></p>
    <p id="bestTimeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>
<script>

// --------------------------------------------------
// Ã‰TAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: 'multiply',
  level: 1,
  numQuestions: 10,
  prenom: '',
  classe: '',
  questionCount: 0,
  correctCount: 0,
  currentQuestion: '',
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  chronoDuration: 60,
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: []
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$('startApp').onclick = () => {
  $('welcome').classList.add('hidden');
  $('start').classList.remove('hidden');
};

// --------------------------------------------------
// OPÃ‰RATIONS
// --------------------------------------------------
document.querySelectorAll('#op-choose .operation-btn').forEach(btn=>{
  btn.onclick = () => {
    state.operation = btn.dataset.op;

    document.querySelectorAll('.operation-btn')
      .forEach(b => b.classList.remove('op-selected'));

    btn.classList.add('op-selected');

    // tables personnalisÃ©es uniquement en multiplication
    if (state.operation === "multiply") {
      $('tables-choose').classList.remove('hidden');
    } else {
      $('tables-choose').classList.add('hidden');
      state.selectedTables = [];
      document.querySelectorAll(".table-btn").forEach(b => b.classList.remove('table-selected'));
    }
  };
});
document.querySelector('.operation-btn[data-op="multiply"]').click();

// --------------------------------------------------
// TABLES PERSONNALISÃ‰ES
// --------------------------------------------------
document.querySelectorAll(".table-btn").forEach(btn => {
  btn.onclick = () => {
    let t = parseInt(btn.dataset.table);

    if (state.selectedTables.includes(t)) {
      state.selectedTables = state.selectedTables.filter(x => x !== t);
      btn.classList.remove("table-selected");
    } else {
      state.selectedTables.push(t);
      btn.classList.add("table-selected");
    }
  };
});

// --------------------------------------------------
// NIVEAUX
// --------------------------------------------------
document.querySelectorAll('#level-choose .level-btn').forEach(btn=>{
  btn.onclick = () => {
    state.level = parseInt(btn.dataset.level);
    document.querySelectorAll('.level-btn')
      .forEach(b=>b.classList.remove('level-selected'));
    btn.classList.add('level-selected');
  };
});
document.querySelector('.level-btn[data-level="1"]').click();

// --------------------------------------------------
// NOMBRE DE QUESTIONS
// --------------------------------------------------
document.querySelectorAll('#questions-choose .questions-btn').forEach(btn=>{
  btn.onclick = () => {
    state.numQuestions = parseInt(btn.dataset.q);
    document.querySelectorAll('.questions-btn')
      .forEach(b => b.classList.remove('questions-selected'));
    btn.classList.add('questions-selected');
  };
});
document.querySelector('.questions-btn[data-q="10"]').click();

// --------------------------------------------------
// MODES + affichage roulette chrono
// --------------------------------------------------
document.querySelectorAll('#mode-choose .mode-btn').forEach(btn=>{
  btn.onclick = () => {
    state.mode = btn.dataset.mode;

    document.querySelectorAll('.mode-btn')
      .forEach(b => b.classList.remove('mode-selected'));

    btn.classList.add('mode-selected');

    if (state.mode === "chrono") {
      $('chronoPickerContainer').classList.remove('hidden');
    } else {
      $('chronoPickerContainer').classList.add('hidden');
    }
  };
});
document.querySelector('.mode-btn[data-mode="multiplication"]').click();

// --------------------------------------------------
// ROULETTE iPHONE 3D
// --------------------------------------------------
const wheelValues = [];
for (let i = 5; i <= 120; i += 5) wheelValues.push(i);

function setupWheel() {
  const wheelList = $('chronoWheelList');
  wheelList.innerHTML = "";

  wheelValues.forEach((val, i) => {
    let div = document.createElement("div");
    div.className = "wheel-item";
    div.textContent = val + " sec";

    let angle = (i * 40);
    div.style.transform = `rotateX(${angle}deg) translateZ(120px)`;

    wheelList.appendChild(div);
  });

  let position = 0;
  let lastY = 0;
  let dragging = false;

  function updateWheel() {
    $('chronoWheelList').style.transform = `translateY(-50%) rotateX(${position}deg)`;
    let index = Math.round((-position / 40)) % wheelValues.length;
    if (index < 0) index += wheelValues.length;
    state.chronoDuration = wheelValues[index];
  }

  $('chronoWheel').addEventListener("touchstart", e => {
    dragging = true;
    lastY = e.touches[0].clientY;
  });

  $('chronoWheel').addEventListener("touchmove", e => {
    if (!dragging) return;
    let y = e.touches[0].clientY;
    let delta = (y - lastY) / 2;
    position += delta;
    lastY = y;
    updateWheel();
  });

  $('chronoWheel').addEventListener("touchend", () => {
    dragging = false;
  });

  updateWheel();
}

setupWheel();

// --------------------------------------------------
// LANCER LE JEU
// --------------------------------------------------
$('btn-play').onclick = () => {

  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if (!state.prenom || !state.classe) {
    alert("Merci dâ€™entrer un prÃ©nom et une classe.");
    return;
  }

  state.questionCount = 0;
  state.correctCount = 0;

  $('start').classList.add('hidden');
  $('result').classList.add('hidden');
  $('game').classList.remove('hidden');

  // CHRONO
  if (state.mode === "chrono") {
    state.chronoStart = Date.now();
    $('chronoLine').textContent = "â± 0 sec";
    $('chronoBar').classList.remove("hidden");
    startChronoDisplay();
  } else {
    $('chronoLine').textContent = "";
    $('chronoBar').classList.add("hidden");
  }

  nextQuestion();
};

// --------------------------------------------------
// TIMER VISUEL
// --------------------------------------------------
let chronoInterval = null;

function startChronoDisplay(){
  if (chronoInterval) clearInterval(chronoInterval);

  const total = state.chronoDuration;

  chronoInterval = setInterval(() => {
    let elapsed = Math.floor((Date.now() - state.chronoStart) / 1000);
    $('chronoLine').textContent = "â± " + elapsed + " sec";

    let remaining = Math.max(0, total - elapsed);
    $('chronoFill').style.width = (remaining / total * 100) + "%";

    if (elapsed >= total) {
      clearInterval(chronoInterval);
      submitAnswer();
    }

  }, 200);
}

function stopChrono() {
  if (chronoInterval) clearInterval(chronoInterval);
  state.chronoTime = Math.floor((Date.now() - state.chronoStart)/1000);
}

// --------------------------------------------------
// UTILITAIRES
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getRangeFromLevel(level){
  if(level===1) return [1,9];
  if(level===2) return [10,20];
  return [10,99];
}

// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createContextualPad(){
  const pad = $('numpad');
  pad.innerHTML = "";

  if(state.mode === "vrai_faux"){
    return createTrueFalseButtons("vrai","faux");
  }

  if(state.mode === "erreur"){
    return createTrueFalseButtons("juste","faux");
  }

  const digits=[[1,2,3],[4,5,6],[7,8,9],['Eff',0,'OK']];

  digits.forEach(row=>{
    row.forEach(val=>{
      const b=document.createElement("button");
      b.type="button";
      b.textContent=val;
      if(val==='Eff') b.className="numpad-eff";
      if(val==='OK')  b.className="numpad-ok";
      b.onclick=()=>handleNumpad(val);
      pad.appendChild(b);
    });
    pad.appendChild(document.createElement("br"));
  });
}

function createTrueFalseButtons(txt1,txt2){
  const pad=$('numpad');
  let b1=document.createElement("button");
  b1.type="button"; b1.textContent=txt1; b1.className="numpad-vrai";
  b1.onclick=()=>{ $('answer').value=txt1; submitAnswer(); };

  let b2=document.createElement("button");
  b2.type="button"; b2.textContent=txt2; b2.className="numpad-faux";
  b2.onclick=()=>{ $('answer').value=txt2; submitAnswer(); };

  pad.appendChild(b1); 
  pad.appendChild(b2);
}

function handleNumpad(v){
  const input=$('answer');
  if(typeof v==='number'){ input.value+=v; }
  else if(v==="Eff"){ input.value=input.value.slice(0,-1); }
  else if(v==="OK"){ submitAnswer(); }
}

// --------------------------------------------------
// GÃ‰NÃ‰RATION DES QUESTIONS
// --------------------------------------------------
function nextQuestion(){
  state.questionCount++;
  if(state.questionCount > state.numQuestions){
    return finishGame();
  }

  let a,b,rep,quest;

  if (state.operation === "multiply" && state.selectedTables.length > 0) {
    a = state.selectedTables[randInt(0, state.selectedTables.length - 1)];
    b = randInt(0, 12);
    quest = `${a} Ã— ${b}`;
    rep = a * b;
  } else {
    let [min,max] = getRangeFromLevel(state.level);
    a = randInt(min,max);
    b = randInt(min,max);

    switch(state.operation){
      case "add": quest=`${a} + ${b}`; rep=a+b; break;
      case "subtract": if(b>a)[a,b]=[b,a]; quest=`${a} âˆ’ ${b}`; rep=a-b; break;
      case "multiply": quest=`${a} Ã— ${b}`; rep=a*b; break;
      case "divide": rep=a; quest=`${a*b} Ã· ${b}`; break;
    }
  }

  state.correctAnswer = rep;

  if(state.mode==="vrai_faux"){
    let shown = rep + (Math.random()<0.5?0:randInt(1,5));
    state.vraiFauxIsTrue = (shown === rep);
    state.currentQuestion = quest+" = "+shown;
  }

  else if(state.mode==="erreur"){
    let isWrong = Math.random() < 0.5;
    let shown = isWrong ? rep + randInt(1,3) : rep;
    state.erreurQuestion = isWrong;
    state.currentQuestion = quest+" = "+shown;
  }

  else {
    state.currentQuestion = quest;
  }

  $('question').textContent = state.currentQuestion;
  $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;
  $('answer').value="";
  $('answer').focus();

  createContextualPad();
}

// --------------------------------------------------
// VALIDATION DES RÃ‰PONSES
// --------------------------------------------------
function submitAnswer(){
  let ans = $('answer').value.trim().toLowerCase();
  let ok=false;

  if(state.mode==="multiplication" || state.mode==="chrono"){
    ok = (parseInt(ans) === state.correctAnswer);
  }
  else if(state.mode==="vrai_faux"){
    let userTrue = /^(vrai|true|1)$/i.test(ans);
    ok = (userTrue === state.vraiFauxIsTrue);
  }
  else if(state.mode==="erreur"){
    let userJuste = /^(juste|true|1)$/i.test(ans);
    let userFaux  = /^(faux|false|0)$/i.test(ans);
    ok = (state.erreurQuestion && userFaux) || (!state.erreurQuestion && userJuste);
  }

  if(ok) state.correctCount++;

  nextQuestion();
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){

  if(state.mode==="chrono"){
    stopChrono();

    if(state.bestTime===null || state.chronoTime < state.bestTime){
      state.bestTime = state.chronoTime;
      localStorage.setItem("bestTime", state.bestTime);
    }
  }

  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

  if(state.mode==="chrono"){
    $('bestTimeText').textContent = 
      `â± Temps : ${state.chronoTime}s â€” Record : ${state.bestTime}s`;
  } else {
    $('bestTimeText').textContent = "";
  }

  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    infos: `${state.operation} N${state.level} ${state.correctCount}/${state.numQuestions}`,
    temps: state.chronoTime ?? null
  };

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// RESTART
// --------------------------------------------------
$('restart').onclick = ()=>{
  $('result').classList.add('hidden');
  $('start').classList.remove('hidden');
};

</script>
