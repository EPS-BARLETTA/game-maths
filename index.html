<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DÃ©fi MathÃ©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #1e1e1e; 
      color: #fff; 
      margin: 0; 
      padding: 30px; 
      min-height: 100vh; 
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* CONTAINER PRINCIPAL â€” PLUS GRAND POUR TABLETTE */
    .container { 
      width: 100%;
      max-width: 650px;
      background: #2b2b2b;
      border-radius: 22px;
      padding: 30px 25px;
      box-shadow: 0 6px 20px #0008;
      text-align: center;
    }

    /* TITRE */
    #welcome h1 {
      font-size: 2.8rem;
      margin-bottom: 25px;
    }

    #startApp {
      font-size: 1.6rem;
      padding: 16px 40px;
      background: #fff;
      color: #000;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    /* BOUTONS GÃ‰NÃ‰RAUX */
    button.button,
    .operation-btn,
    .level-btn,
    .mode-btn,
    .questions-btn,
    .table-btn {
      padding: 14px 28px;
      font-size: 1.4rem;
      margin: 10px;
      border-radius: 14px;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px #0006;
      transition: 0.15s;
    }

    /* PASTEL PREMIUM */
    .operation-btn[data-op="multiply"] { background:#FFE0A3; color:#000; }
    .operation-btn[data-op="add"] { background:#A7D8FF; color:#000; }
    .operation-btn[data-op="subtract"] { background:#F7B7CF; color:#000; }
    .operation-btn[data-op="divide"] { background:#FFB5A7; color:#000; }

    /* SÃ‰LECTION : bouton qui se fonce lÃ©gÃ¨rement */
    .op-selected,
    .level-selected,
    .questions-selected,
    .mode-selected {
      filter: brightness(0.85);
      border: 3px solid #fff;
    }

    /* INPUT PRÃ‰NOM / CLASSE â€” PLUS GRAND */
    #prenom, #classe {
      width: 85%;
      font-size: 1.6rem;
      padding: 12px;
      border-radius: 12px;
      border: 2px solid #555;
      margin-top: 10px;
      background:#111;
      color:white;
      text-align:center;
    }

    h2 { font-size: 1.8rem; margin-top: 20px; }

    .hidden { display:none !important; }
  </style>
</head>

<body>

<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>ðŸŽ® DÃ©fi MathÃ©matiques</h1>
    <button id="startApp">DÃ©marrer</button>
  </div>

  <!-- PAGE DE SÃ‰LECTION -->
  <div id="start" class="hidden">

    <p>PrÃ©nom : <input id="prenom" type="text" maxlength="18"></p>
    <p>Classe : <input id="classe" type="text" maxlength="18"></p>

    <h2>Type d'opÃ©ration</h2>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <h2>Niveau</h2>
    <div id="level-choose"></div>

    <h2>Nombre de questions</h2>
    <div id="questions-choose"></div>

    <h2>Mode</h2>
    <div id="mode-choose"></div>

    <button id="btn-play" class="button">Valider</button>
  </div>

<!-- BLOC 2 ICI -->
  <!-- PAGE DE JEU -->
  <div id="game" class="hidden">
    
    <!-- Question -->
    <div id="question" style="font-size:3rem; margin-top:20px; min-height:70px;"></div>

    <!-- Zone de rÃ©ponse -->
    <input id="answer" type="text" autocomplete="off" 
      style="width:80%; font-size:2rem; padding:14px; margin-top:12px; 
             background:#111; border:2px solid #777; border-radius:14px; color:white;">

    <!-- PavÃ© numÃ©rique -->
    <div id="numpad" style="margin-top:18px;"></div>

    <!-- Chrono simple -->
    <div id="chronoLine" style="font-size:1.8rem; margin-top:20px;"></div>

    <!-- Progression -->
    <p id="progress" style="font-size:1.6rem; margin-top:15px;"></p>

  </div>

  <!-- PAGE RÃ‰SULTATS -->
  <div id="result" class="hidden">
    <h2 style="font-size:2.4rem;">RÃ©sultat</h2>

    <p id="scoreText" style="font-size:2rem; margin-bottom:10px;"></p>
    <p id="bestTimeText" style="font-size:1.4rem; opacity:0.8;"></p>

    <canvas id="qr" style="margin:20px auto; display:block;"></canvas>

    <button id="restart" class="button" style="margin-top:20px;">Rejouer</button>
  </div>

</div>

<style>

  /* Boutons du pavÃ© numÃ©rique agrandis */
  #numpad button {
    width: 90px;
    height: 90px;
    font-size: 2rem;
    margin: 10px;
    border-radius: 18px;
    border: none;
    background: #444;
    color: #fff;
  }

  .numpad-eff { background:#bdbdbd !important; color:#222 !important; }
  .numpad-ok { background:#4CAF50 !important; color:white !important; }

  /* BOUTONS VRAI / FAUX PREMIUM */
  .numpad-vrai {
    background:#7ED957 !important;   /* vert premium */
    width:46%;
    height:90px;
    font-size:2rem;
    border-radius:16px;
    margin: 5px;
  }

  .numpad-faux {
    background:#FF6B6B !important;   /* rouge pastel premium */
    width:46%;
    height:90px;
    font-size:2rem;
    border-radius:16px;
    margin: 5px;
  }

</style>

<!-- BLOC 3 ICI -->
<script>

// --------------------------------------------------
// Ã‰TAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: 'multiply',
  level: 1,
  numQuestions: 10,
  prenom: '',
  classe: '',
  questionCount: 0,
  correctCount: 0,
  currentQuestion: '',
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: [],
  gameStarted: false
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$('startApp').onclick = () => {
  $('welcome').classList.add('hidden');
  $('start').classList.remove('hidden');
};

// --------------------------------------------------
// UTILITAIRES
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getRangeFromLevel(level){
  if(level===1) return [1,9];
  if(level===2) return [10,20];
  return [10,99];
}

// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createNumpad(){

  const pad = $('numpad');
  pad.innerHTML = "";

  // Mode Vrai / Faux
  if(state.mode === "vrai_faux"){
    let v = document.createElement("button");
    v.className = "numpad-vrai";
    v.textContent = "Vrai";
    v.onclick = () => { $('answer').value = "vrai"; submitAnswer(); };

    let f = document.createElement("button");
    f.className = "numpad-faux";
    f.textContent = "Faux";
    f.onclick = () => { $('answer').value = "faux"; submitAnswer(); };

    pad.appendChild(v);
    pad.appendChild(f);
    return;
  }

  // Mode Erreur (Juste / Faux)
  if(state.mode === "erreur"){
    let j = document.createElement("button");
    j.className = "numpad-vrai";
    j.textContent = "Juste";
    j.onclick = () => { $('answer').value = "juste"; submitAnswer(); };

    let f = document.createElement("button");
    f.className = "numpad-faux";
    f.textContent = "Faux";
    f.onclick = () => { $('answer').value = "faux"; submitAnswer(); };

    pad.appendChild(j);
    pad.appendChild(f);
    return;
  }

  // PavÃ© numÃ©rique classique
  const rows = [
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ['Eff',0,'OK']
  ];

  rows.forEach(r=>{
    let line = document.createElement("div");
    line.style.display = "flex";
    line.style.justifyContent = "center";

    r.forEach(v=>{
      let b = document.createElement("button");
      b.textContent = v;

      if(v === "Eff") b.className = "numpad-eff";
      if(v === "OK") b.className = "numpad-ok";

      b.onclick = ()=> handleNumpad(v);
      line.appendChild(b);
    });

    pad.appendChild(line);
  });
}

function handleNumpad(v){
  let input = $('answer');

  if(typeof v === "number"){
    input.value += v;
  }
  else if(v === "Eff"){
    input.value = input.value.slice(0,-1);
  }
  else if(v === "OK"){
    submitAnswer();
  }
}

// --------------------------------------------------
// GÃ‰NÃ‰RATION DES QUESTIONS
// --------------------------------------------------
function nextQuestion(){

  if(!state.gameStarted){
    $('question').textContent = "Clique sur â–¶ï¸ DÃ©marrer lâ€™exercice";
    return;
  }

  state.questionCount++;

  if(state.questionCount > state.numQuestions){
    finishGame();
    return;
  }

  let a,b,rep,quest;

  // Tables personnalisÃ©es
  if(state.operation==="multiply" && state.selectedTables.length>0){
    a = state.selectedTables[randInt(0,state.selectedTables.length-1)];
    b = randInt(0,12);
    rep = a*b;
    quest = `${a} Ã— ${b}`;
  }
  else {
    let [min,max] = getRangeFromLevel(state.level);
    a = randInt(min,max);
    b = randInt(min,max);

    switch(state.operation){
      case "add": rep=a+b; quest=`${a} + ${b}`; break;
      case "subtract": if(b>a)[a,b]=[b,a]; rep=a-b; quest=`${a} âˆ’ ${b}`; break;
      case "multiply": rep=a*b; quest=`${a} Ã— ${b}`; break;
      case "divide": rep=a; quest=`${a*b} Ã· ${b}`; break;
    }
  }

  state.correctAnswer = rep;

  // Modes spÃ©ciaux
  if(state.mode==="vrai_faux"){
    let shown = rep + (Math.random()<0.5 ? 0 : randInt(1,5));
    state.vraiFauxIsTrue = (shown===rep);
    quest += " = " + shown;
  }

  if(state.mode==="erreur"){
    let wrong = Math.random()<0.5;
    let shown = wrong ? rep + randInt(1,3) : rep;
    state.erreurQuestion = wrong;
    quest += " = " + shown;
  }

  state.currentQuestion = quest;
  $('question').textContent = quest;
  $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;
  $('answer').value = "";
  $('answer').focus();

  createNumpad();
}

// --------------------------------------------------
// VALIDATION
// --------------------------------------------------
function submitAnswer(){

  let ans = $('answer').value.trim().toLowerCase();
  let ok = false;

  if(state.mode==="multiplication" || state.mode==="chrono"){
    ok = (parseInt(ans) === state.correctAnswer);
  }

  if(state.mode==="vrai_faux"){
    ok = (/^(vrai|1)$/i.test(ans) === state.vraiFauxIsTrue);
  }

  if(state.mode==="erreur"){
    let juste = /^(juste)$/i.test(ans);
    let faux  = /^(faux)$/i.test(ans);
    ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
  }

  // Affichage du âœ”ï¸ ou âŒ + bonne rÃ©ponse
  if(ok){
    $('question').textContent = "âœ”ï¸ Bonne rÃ©ponse !";
  } else {
    $('question').textContent = `âŒ Faux â€” RÃ©ponse : ${state.correctAnswer}`;
  }

  // Petite pause pour laisser lire (1.3s)
  setTimeout(nextQuestion, 1300);

  if(ok) state.correctCount++;
}

// --------------------------------------------------
// LANCEMENT DU JEU
// --------------------------------------------------
$('btn-play').onclick = ()=>{

  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if(!state.prenom || !state.classe){
    alert("Merci dâ€™entrer prÃ©nom + classe");
    return;
  }

  // On va Ã  la page de jeu
  $('start').classList.add('hidden');
  $('game').classList.remove('hidden');

  // Ajout du bouton dÃ©marrer
  if(!$("startGameBtn")){
    let btn = document.createElement("button");
    btn.id = "startGameBtn";
    btn.textContent = "â–¶ï¸ DÃ©marrer lâ€™exercice";
    btn.style.cssText = "margin-top:20px; padding:14px 26px; font-size:1.6rem; border-radius:12px;";
    btn.onclick = startGame;
    $('game').appendChild(btn);
  }

  nextQuestion();
};

function startGame(){
  state.gameStarted = true;
  $('startGameBtn').remove();

  if(state.mode==="chrono"){
    state.chronoStart = Date.now();
    startChrono();
  }

  nextQuestion();
}

// --------------------------------------------------
// CHRONO
// --------------------------------------------------
function startChrono(){
  let chrono = $('chronoLine');

  let int = setInterval(()=>{
    let sec = Math.floor((Date.now() - state.chronoStart)/1000);
    chrono.textContent = "â± " + sec + " sec";

    state.chronoTime = sec;

    if(state.questionCount >= state.numQuestions){
      clearInterval(int);
    }
  },300);
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){

  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

  if(state.mode==="chrono"){
    $('bestTimeText').textContent = `â± Temps : ${state.chronoTime}s`;
  } else {
    $('bestTimeText').textContent = "";
  }

  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    mode: state.mode,
    resultat: `${state.correctCount}/${state.numQuestions}`,
    temps: state.mode==="chrono" ? state.chronoTime : undefined
  };

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$('restart').onclick = ()=>{
  location.reload();
};

</script>
