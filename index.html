<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>D√©fi Math√©matiques - ScanProf</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

<style>

  /* -------------------- GLOBAL -------------------- */
  body {
    margin: 0;
    padding: 0;
    background: #1f1f1f;
    font-family: Arial, sans-serif;
    color: #fff;
    display: flex;
    justify-content: center;
    min-height: 100vh;
  }

  /* Cadre principal ‚Äî largeur ma√Ætris√©e */
  .container {
    width: 360px;
    background: #2e2e2e;
    border-radius: 18px;
    padding: 20px;
    margin-top: 20px;
    box-shadow: 0 0 25px #0008;
    text-align: center;
  }

  h1, h2 {
    margin: 0 0 15px 0;
    font-weight: 600;
  }

  button {
    cursor: pointer;
  }

  /* -------------------- PAGE DE GARDE -------------------- */
  #welcome {
    display: flex;
    flex-direction: column;
    justify-content: center;
    height: 70vh;
  }

  #startApp {
    background: white;
    color: black;
    padding: 12px 24px;
    border-radius: 10px;
    font-size: 1.2em;
    border: none;
    font-weight: bold;
  }

  /* -------------------- MENU -------------------- */

  input[type="text"] {
    width: 80%;
    padding: 10px;
    margin: 8px 0;
    border-radius: 10px;
    border: none;
    text-align: center;
    font-size: 1.1em;
    background: #444;
    color: white;
  }

  /* Boutons g√©n√©raux */
  .menu-btn {
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    margin: 5px;
    color: white;
    font-size: 1.05em;
    box-shadow: 0 2px 4px #0005;
  }

  /* Op√©rations */
  .operation-btn[data-op="multiply"] { background:#ff9800; }
  .operation-btn[data-op="add"]      { background:#2196f3; }
  .operation-btn[data-op="subtract"] { background:#9c27b0; }
  .operation-btn[data-op="divide"]   { background:#e53935; }
  .op-selected { outline: 2px solid #fff; }

  /* Modes */
  .mode-btn[data-mode="multiplication"] { background:#4CAF50; }
  .mode-btn[data-mode="chrono"]         { background:#00BCD4; }
  .mode-btn[data-mode="vrai_faux"]      { background:#F06292; }
  .mode-btn[data-mode="erreur"]         { background:#795548; }
  .mode-selected { outline: 2px solid #fff; }

  /* Niveaux */
  .level-btn[data-level="1"] { background:#A5D6A7; color:#000; }
  .level-btn[data-level="2"] { background:#FFF176; color:#000; }
  .level-btn[data-level="3"] { background:#90A4AE; }
  .level-selected { outline: 2px solid #fff; }

  /* Questions */
  .questions-btn { background:#333; }
  .questions-selected { background:#03A9F4; outline:2px solid #fff; }

  /* Tables */
  .table-btn { background:#333; width: 55px; }
  .table-selected { background:#009688; outline:2px solid #fff; }

  /* Bouton "Jouer" */
  #btn-play {
    background: white;
    color: black;
    font-weight: 700;
    padding: 12px 24px;
    border-radius: 12px;
    margin-top: 15px;
    border: none;
    box-shadow: 0 2px 5px #0007;
  }

  /* -------------------- JEU -------------------- */

  #question {
    font-size: 2em;
    margin: 15px 0;
    min-height: 2em;
  }

  /* Champ r√©ponse */
  #answer {
    width: 80%;
    padding: 10px;
    margin-top: 8px;
    background:#222;
    border:none;
    border-radius:8px;
    color:white;
    font-size:1.3em;
    text-align:center;
  }

  /* Pav√© num√©rique */
  #numpad {
    margin-top: 10px;
  }

  #numpad-row {
    display: flex;
    justify-content: center;
  }

  #numpad button {
    width: 60px;
    height: 54px;
    margin: 4px;
    font-size: 1.25em;
    border-radius: 8px;
    background:#444;
    color:white;
    border:none;
  }

  .numpad-eff { background:#aaa !important; color:#000 !important; }
  .numpad-ok  { background:#4CAF50 !important; color:white !important; }

  /* vrai/faux */
  .numpad-vrai { background:#4CAF50 !important; width:45%; height:54px; }
  .numpad-faux { background:#E53935 !important; width:45%; height:54px; }

  /* Feedback r√©ponse */
  #feedback {
    font-size: 1.3em;
    margin-top: 8px;
    min-height: 1.5em;
  }

  /* Barre chrono */
  #chronoBar {
    width: 100%;
    height: 12px;
    background:#555;
    border-radius:6px;
    overflow:hidden;
    margin-top:10px;
  }

  #chronoFill {
    height: 100%;
    background:#00e676;
    width:100%;
  }

  /* -------------------- R√âSULTATS -------------------- */

  #result canvas {
    margin: 15px auto;
    display: block;
  }

  #restart {
    background:white;
    color:black;
    padding:10px 20px;
    border-radius:10px;
    border:none;
    margin-top:15px;
    font-weight:bold;
  }

  .hidden { display:none !important; }

</style>
</head>

<body>

<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>üßÆ D√©fi Math√©matiques ‚ôæÔ∏è</h1>
    <button id="startApp">D√©marrer</button>
  </div>

  <!-- MENU -->
  <div id="start" class="hidden">

    <p>Pr√©nom : <input id="prenom" type="text" maxlength="18"></p>
    <p>Classe : <input id="classe" type="text" maxlength="18"></p>

    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <div id="level-choose"></div>

    <div id="questions-choose"></div>

    <div id="mode-choose"></div>

    <div id="chronoPickerContainer" class="hidden"></div>

    <button id="btn-play">Valider et jouer</button>
  </div>

  <!-- JEU -->
  <div id="game" class="hidden">
    <div id="question"></div>
    <input id="answer" type="text">

    <div id="feedback"></div>

    <div id="numpad"></div>

    <div id="chronoBar" class="hidden">
      <div id="chronoFill"></div>
    </div>

    <p id="progress"></p>
    <p id="chronoLine"></p>
  </div>

  <!-- R√âSULTATS -->
  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText"></p>
    <p id="bestTimeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart">Rejouer</button>
  </div>

</div>

<!-- ICI TU COLLERAS LE BLOC 2 -->
<script>
// --------------------------------------------------
// √âTAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: "multiply",
  level: 1,
  numQuestions: 10,
  prenom: "",
  classe: "",
  questionCount: 0,
  correctCount: 0,
  currentQuestion: "",
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  chronoDuration: 60,
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: []
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$("startApp").onclick = () => {
  $("welcome").classList.add("hidden");
  $("start").classList.remove("hidden");
};

// --------------------------------------------------
// CR√âATION DES BOUTONS DU MENU
// --------------------------------------------------

/* --- Op√©rations --- */
const ops = [
  { op: "multiply", label: "√ó" },
  { op: "add", label: "+" },
  { op: "subtract", label: "‚àí" },
  { op: "divide", label: "√∑" }
];

ops.forEach(o => {
  let b = document.createElement("button");
  b.className = "menu-btn operation-btn";
  b.dataset.op = o.op;
  b.textContent = o.label;

  b.onclick = () => {
    state.operation = o.op;

    document.querySelectorAll(".operation-btn").forEach(x => x.classList.remove("op-selected"));
    b.classList.add("op-selected");

    $("tables-choose").classList.toggle("hidden", o.op !== "multiply");

    if (o.op !== "multiply") {
      state.selectedTables = [];
      document.querySelectorAll(".table-btn").forEach(t => t.classList.remove("table-selected"));
    }
  };

  $("op-choose").appendChild(b);
});
document.querySelector('.operation-btn[data-op="multiply"]').classList.add("op-selected");

/* --- Tables personnalis√©es --- */
let htmlTables = "";
for (let i = 1; i <= 12; i++) htmlTables += `<button class="table-btn menu-btn" data-table="${i}">${i}</button>`;
$("tables-choose").innerHTML = htmlTables;

document.querySelectorAll(".table-btn").forEach(btn => {
  btn.onclick = () => {
    let val = parseInt(btn.dataset.table);

    if (state.selectedTables.includes(val)) {
      state.selectedTables = state.selectedTables.filter(x => x !== val);
      btn.classList.remove("table-selected");
    } else {
      state.selectedTables.push(val);
      btn.classList.add("table-selected");
    }
  };
});

/* --- Niveaux --- */
[1, 2, 3].forEach(l => {
  let b = document.createElement("button");
  b.className = "menu-btn level-btn";
  b.dataset.level = l;
  b.textContent = "Niveau " + l;

  b.onclick = () => {
    state.level = l;
    document.querySelectorAll(".level-btn").forEach(x => x.classList.remove("level-selected"));
    b.classList.add("level-selected");
  };

  $("level-choose").appendChild(b);
});
document.querySelector('.level-btn[data-level="1"]').classList.add("level-selected");

/* --- Nombre de questions --- */
[10, 15, 20].forEach(q => {
  let b = document.createElement("button");
  b.className = "menu-btn questions-btn";
  b.dataset.q = q;
  b.textContent = q;

  b.onclick = () => {
    state.numQuestions = q;
    document.querySelectorAll(".questions-btn").forEach(x => x.classList.remove("questions-selected"));
    b.classList.add("questions-selected");
  };

  $("questions-choose").appendChild(b);
});
document.querySelector('.questions-btn[data-q="10"]').classList.add("questions-selected");

/* --- Modes --- */
const modes = [
  { m: "multiplication", label: "Classique" },
  { m: "chrono", label: "Chrono" },
  { m: "vrai_faux", label: "Vrai/Faux" },
  { m: "erreur", label: "Erreur" }
];

modes.forEach(o => {
  let b = document.createElement("button");
  b.className = "menu-btn mode-btn";
  b.dataset.mode = o.m;
  b.textContent = o.label;

  b.onclick = () => {
    state.mode = o.m;

    document.querySelectorAll(".mode-btn").forEach(x => x.classList.remove("mode-selected"));
    b.classList.add("mode-selected");

    $("chronoPickerContainer").classList.toggle("hidden", o.m !== "chrono");
  };

  $("mode-choose").appendChild(b);
});
document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add("mode-selected");

/* --- S√©lecteur temps (chrono) --- */
let timeSelector = document.createElement("select");
timeSelector.style.padding = "8px";
timeSelector.style.fontSize = "1.1em";
timeSelector.style.borderRadius = "8px";

for (let t = 5; t <= 120; t += 5) {
  let opt = document.createElement("option");
  opt.value = t;
  opt.textContent = t + " sec";
  timeSelector.appendChild(opt);
}
timeSelector.onchange = () => (state.chronoDuration = parseInt(timeSelector.value));
$("chronoPickerContainer").appendChild(timeSelector);

// --------------------------------------------------
// LANCEMENT DU JEU
// --------------------------------------------------
$("btn-play").onclick = () => {
  state.prenom = $("prenom").value.trim();
  state.classe = $("classe").value.trim();

  if (!state.prenom || !state.classe) {
    alert("Merci d‚Äôindiquer un pr√©nom et une classe.");
    return;
  }

  state.questionCount = 0;
  state.correctCount = 0;

  $("start").classList.add("hidden");
  $("result").classList.add("hidden");
  $("game").classList.remove("hidden");
  $("feedback").textContent = "";

  if (state.mode === "chrono") {
    state.chronoStart = Date.now();
    $("chronoBar").classList.remove("hidden");
    startChrono();
  } else {
    $("chronoBar").classList.add("hidden");
  }

  nextQuestion();
};

// --------------------------------------------------
// CHRONO
// --------------------------------------------------
let chronoInterval = null;

function startChrono() {
  if (chronoInterval) clearInterval(chronoInterval);

  let total = state.chronoDuration;

  chronoInterval = setInterval(() => {
    let elapsed = Math.floor((Date.now() - state.chronoStart) / 1000);
    let remaining = Math.max(0, total - elapsed);
    $("chronoFill").style.width = (remaining / total) * 100 + "%";
    $("chronoLine").textContent = elapsed + " sec";

    if (elapsed >= total) {
      clearInterval(chronoInterval);
      submitAnswer(); // fin automatique
    }
  }, 200);
}

function stopChrono() {
  if (chronoInterval) clearInterval(chronoInterval);
  state.chronoTime = Math.floor((Date.now() - state.chronoStart) / 1000);
}

// --------------------------------------------------
// OUTILS
// --------------------------------------------------
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function levelRange(level) {
  if (level === 1) return [1, 9];
  if (level === 2) return [10, 20];
  return [10, 99];
}

// --------------------------------------------------
// PAV√â NUM√âRIQUE
// --------------------------------------------------
function createPad() {
  const pad = $("numpad");
  pad.innerHTML = "";

  // VRAI / FAUX mode
  if (state.mode === "vrai_faux") return createVF("vrai", "faux");
  if (state.mode === "erreur") return createVF("juste", "faux");

  // Pav√© classique
  const rows = [
    [1, 2, 3],
    [4, 5, 6],
    [7, 8, 9],
    ["Eff", 0, "OK"]
  ];

  rows.forEach(r => {
    let line = document.createElement("div");
    line.id = "numpad-row";

    r.forEach(v => {
      let b = document.createElement("button");
      b.textContent = v;

      if (v === "Eff") b.className = "numpad-eff";
      if (v === "OK") b.className = "numpad-ok";

      b.onclick = () => handleNumpad(v);

      line.appendChild(b);
    });

    pad.appendChild(line);
  });
}

function createVF(a, b) {
  $("numpad").innerHTML = `
    <button class="numpad-vrai">${a}</button>
    <button class="numpad-faux">${b}</button>
  `;

  document.querySelector(".numpad-vrai").onclick = () => {
    $("answer").value = a;
    submitAnswer();
  };
  document.querySelector(".numpad-faux").onclick = () => {
    $("answer").value = b;
    submitAnswer();
  };
}

function handleNumpad(v) {
  let input = $("answer");

  if (typeof v === "number") input.value += v;
  else if (v === "Eff") input.value = input.value.slice(0, -1);
  else if (v === "OK") submitAnswer();
}

// --------------------------------------------------
// G√âN√âRATION QUESTION
// --------------------------------------------------
function nextQuestion() {
  $("feedback").textContent = "";

  state.questionCount++;
  $("progress").textContent = `${state.questionCount}/${state.numQuestions}`;

  if (state.questionCount > state.numQuestions) return finishGame();

  let a, b, rep, quest;

  if (state.operation === "multiply" && state.selectedTables.length > 0) {
    a = state.selectedTables[randInt(0, state.selectedTables.length - 1)];
    b = randInt(0, 12);
    rep = a * b;
    quest = `${a} √ó ${b}`;
  } else {
    let [min, max] = levelRange(state.level);
    a = randInt(min, max);
    b = randInt(min, max);

    switch (state.operation) {
      case "add":
        rep = a + b;
        quest = `${a} + ${b}`;
        break;

      case "subtract":
        if (b > a) [a, b] = [b, a];
        rep = a - b;
        quest = `${a} ‚àí ${b}`;
        break;

      case "multiply":
        rep = a * b;
        quest = `${a} √ó ${b}`;
        break;

      case "divide":
        rep = a;
        quest = `${a * b} √∑ ${b}`;
        break;
    }
  }

  state.correctAnswer = rep;

  // VRAI/FAUX
  if (state.mode === "vrai_faux") {
    let shown = rep + (Math.random() < 0.5 ? 0 : randInt(1, 5));
    state.vraiFauxIsTrue = shown === rep;
    quest = `${quest} = ${shown}`;
  }

  // ERREUR
  if (state.mode === "erreur") {
    let wrong = Math.random() < 0.5;
    let shown = wrong ? rep + randInt(1, 3) : rep;
    state.erreurQuestion = wrong;
    quest = `${quest} = ${shown}`;
  }

  state.currentQuestion = quest;
  $("question").textContent = quest;
  $("answer").value = "";
  $("answer").focus();

  createPad();
}

// --------------------------------------------------
// VALIDATION
// --------------------------------------------------
function submitAnswer() {
  let ans = $("answer").value.trim().toLowerCase();
  let ok = false;

  // Modes classiques
  if (state.mode === "multiplication" || state.mode === "chrono") {
    ok = parseInt(ans) === state.correctAnswer;
  }

  // Mode VRAI / FAUX
  if (state.mode === "vrai_faux") {
    ok = (/^(vrai|true|1)$/i.test(ans)) === state.vraiFauxIsTrue;
  }

  // Mode ERREUR
  if (state.mode === "erreur") {
    let juste = /^(juste|true|1)$/i.test(ans);
    let faux = /^(faux|false|0)$/i.test(ans);
    ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
  }

  // Feedback visuel
  if (ok) {
    state.correctCount++;
    $("feedback").textContent = "‚úÖ Bravo !";
  } else {
    $("feedback").textContent = `‚ùå Mauvaise r√©ponse ‚Äî Correct : ${state.correctAnswer}`;
  }

  setTimeout(() => nextQuestion(), 600);
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame() {
  if (state.mode === "chrono") {
    stopChrono();

    if (state.bestTime === null || state.chronoTime < state.bestTime) {
      state.bestTime = state.chronoTime;
      localStorage.setItem("bestTime", state.bestTime);
    }
  }

  $("game").classList.add("hidden");
  $("result").classList.remove("hidden");

  $("scoreText").textContent = `${state.correctCount}/${state.numQuestions}`;

  if (state.mode === "chrono") {
    $("bestTimeText").textContent =
      `‚è± Temps : ${state.chronoTime}s ‚Äî Record : ${state.bestTime}s`;
  } else $("bestTimeText").textContent = "";

  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    score: `${state.correctCount}/${state.numQuestions}`,
    mode: state.mode,
    temps: state.chronoTime ?? null
  };

  new QRious({
    element: $("qr"),
    size: 240,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$("restart").onclick = () => {
  $("result").classList.add("hidden");
  $("start").classList.remove("hidden");
};
</script>
