<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Math√©matiques - ScanProf</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; background: #222; color: #fff; margin: 0; padding: 20px; min-height: 100vh; text-align: center;}
    .container { max-width: 400px; margin: 0 auto; background: #333; border-radius: 16px; box-shadow: 0 4px 16px #0007; padding: 20px; }
    h1 { font-size: 2em; margin: 8px 0 18px; }
    button.button, .operation-btn, .level-btn, .mode-btn, .questions-btn { padding: 11px 22px; margin: 6px; border: none; border-radius: 10px; color: #fff; font-size: 1.07em; cursor: pointer; margin-top: 7px; transition: background .22s; outline: none; box-shadow: 0 1px 4px #0005; }
    .operation-btn[data-op="multiply"] { background: #FF9800; }
    .operation-btn[data-op="add"]      { background: #2196F3; }
    .operation-btn[data-op="subtract"] { background: #8E24AA; }
    .operation-btn[data-op="divide"]   { background: #E53935; }
    .op-selected[data-op="multiply"], .op-selected[data-op="add"], .op-selected[data-op="subtract"], .op-selected[data-op="divide"] { border: 2px solid #fff; filter: brightness(1.2);}
    .level-btn[data-level="1"] { background: #A5D6A7; color: #222; }
    .level-btn[data-level="2"] { background: #FFF176; color: #222; }
    .level-btn[data-level="3"] { background: #90A4AE; color: #fff; }
    .level-selected { box-shadow: 0 0 1px 3px #fff3; border:2px solid #fff; filter: brightness(1.09);}
    .mode-btn[data-mode="multiplication"] { background:#4CAF50; }
    .mode-btn[data-mode="chrono"]         { background:#00BCD4; }
    .mode-btn[data-mode="vrai_faux"]      { background:#F06292; }
    .mode-btn[data-mode="erreur"]         { background:#795548; }
    .mode-selected { box-shadow:0 0 1px 3px #fff3; border:2px solid #fff; filter: brightness(1.09);}
    .questions-btn { background: #222; color: #fff;}
    .questions-selected { background: #00BCD4; color: #fff; border:2px solid #fff; }
    input[type="text"] { padding: 10px; border-radius: 8px; border: none; font-size: 1.1em; margin: 10px; width: 70%; background: #222; color: #fff; outline: none; text-align: center; margin-bottom: 18px; }
    #question { font-size: 2em; margin: 19px 0 10px; min-height: 2.2em;}
    #btn-help { margin-top: 8px; margin-bottom: 10px; background: #757575; }
    #helpbox { display:none; background:#263238; color:#fff; border-radius:10px; padding:18px; box-shadow: 0 4px 16px #0007; margin:18px 0;}
    #close-help { background:#e53935; color:#fff; margin-top:7px;}
    @media (max-width:600px) {.container { max-width: 98%; } body { padding: 7px; } h1 { font-size: 1.35em; } #question { font-size: 1.18em; } #numpad button { font-size: 1.1em !important; width: 43px !important; height: 39px !important;} #numpad .numpad-vrai, #numpad .numpad-faux { width: 48% !important; min-width:100px !important; }}
    #result canvas { margin: 20px auto; display: block; }
    .hidden { display: none !important; }
    #numpad { margin: 10px 0 10px 0; }
    #numpad button { width: 56px; height: 52px; font-size: 1.25em; margin: 3px; border-radius: 8px; border: none; background: #444; color: #fff; cursor: pointer; transition: background .18s; display: inline-block; outline: none; user-select: none;}
    #numpad button.numpad-eff { background: #aaa; color: #222; }
    #numpad button.numpad-ok  { background: #4CAF50; }
    #numpad .numpad-vrai { background: #6ac200; color: #fff; width: 48%; min-width:140px; height: 54px; font-size: 1.19em; margin:8px 1vw;}
    #numpad .numpad-faux { background: #e94444; color: #fff; width: 48%; min-width:140px; height: 54px; font-size: 1.19em; margin:8px 1vw;}
    #numpad button:active { background: #666; }
    .op-choose-label { font-size: 1.07em; margin-top:18px;}
  </style>
</head>
<body>
<div class="container">
  <h1>üéÆ D√©fi Math√©matiques</h1>
  <button id="btn-help">AIDE / Mode d'emploi</button>
  <div id="helpbox">
    <strong>Comment utiliser l'application ?</strong><br><br>
    <b>1. Choisis ton pr√©nom et ta classe.</b><br>
    <b>2. S√©lectionne le type d'exercice.</b><br>
    <b>3. Choisis un niveau.</b><br>
    <b>4. S√©lectionne le mode.</b><br>
    <b>5. R√©ponds avec le pav√© num√©rique ou les boutons adapt√©s.</b><br><br>
    <button id="close-help">Fermer l'aide</button>
  </div>

  <div id="start">
    <p>Pr√©nom : <input id="prenom" type="text" maxlength="18"></p>
    <p>Classe : <input id="classe" type="text" maxlength="18"></p>

    <div class="op-choose-label">Type d'op√©ration :</div>
    <div id="op-choose">
      <button class="operation-btn" data-op="multiply">√ó Multiplication</button>
      <button class="operation-btn" data-op="add">+ Addition</button>
      <button class="operation-btn" data-op="subtract">‚àí Soustraction</button>
      <button class="operation-btn" data-op="divide">√∑ Division</button>
    </div>
    <div id="op-chosen"></div>

    <div class="op-choose-label">Niveau :</div>
    <div id="level-choose">
      <button class="level-btn" data-level="1">Niveau 1</button>
      <button class="level-btn" data-level="2">Niveau 2</button>
      <button class="level-btn" data-level="3">Niveau 3</button>
    </div>
    <div id="level-chosen"></div>

    <div class="op-choose-label">Nombre de questions :</div>
    <div id="questions-choose">
      <button class="questions-btn" data-q="10">10</button>
      <button class="questions-btn" data-q="15">15</button>
      <button class="questions-btn" data-q="20">20</button>
      <button class="questions-btn" data-q="25">25</button>
      <button class="questions-btn" data-q="30">30</button>
      <button class="questions-btn" data-q="35">35</button>
      <button class="questions-btn" data-q="40">40</button>
    </div>
    <div id="questions-chosen"></div>

    <h3>Choisir un mode :</h3>
    <div id="mode-choose">
      <button class="mode-btn" data-mode="multiplication">Classique</button>
      <button class="mode-btn" data-mode="chrono">Chrono</button>
      <button class="mode-btn" data-mode="vrai_faux">Vrai/Faux</button>
      <button class="mode-btn" data-mode="erreur">Trouve l'Erreur</button>
    </div>

    <button id="btn-play" class="button">Valider et jouer</button>
  </div>

  <form id="game" class="hidden" onsubmit="return false;">
    <div id="question"></div>
    <input id="answer" type="text" maxlength="10" autocomplete="off">
    <div id="numpad"></div>
    <button class="button" type="submit">Valider</button>
    <p id="progress"></p>
    <p id="chronoLine"></p>
  </form>

  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText"></p>
    <p id="advice"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>
</div>

<script>

// --------------------------------------------------
// √âTAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null, operation:'multiply', level:1, numQuestions:10,
  prenom:'', classe:'',
  questionCount: 0, correctCount: 0,
  currentQuestion: '', correctAnswer: null,
  mistakes: {},
  vraiFauxIsTrue: false, erreurQuestion: false
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// AIDE
// --------------------------------------------------
$('btn-help').onclick = () => $('helpbox').style.display = 'block';
$('close-help').onclick = () => $('helpbox').style.display = 'none';

// --------------------------------------------------
// S√âLECTIONS DU MENU
// --------------------------------------------------
document.querySelectorAll('#op-choose .operation-btn').forEach(btn=>{
  btn.onclick=()=>{
    state.operation=btn.dataset.op;
    document.querySelectorAll('.operation-btn').forEach(b=>b.classList.remove('op-selected'));
    btn.classList.add('op-selected');
  };
});
document.querySelector('.operation-btn[data-op="multiply"]').click();

document.querySelectorAll('#level-choose .level-btn').forEach(btn=>{
  btn.onclick=()=>{
    state.level=parseInt(btn.dataset.level);
    document.querySelectorAll('.level-btn').forEach(b=>b.classList.remove('level-selected'));
    btn.classList.add('level-selected');
  };
});
document.querySelector('.level-btn[data-level="1"]').click();

document.querySelectorAll('#questions-choose .questions-btn').forEach(btn=>{
  btn.onclick=()=>{
    state.numQuestions=parseInt(btn.dataset.q);
    document.querySelectorAll('.questions-btn').forEach(b=>b.classList.remove('questions-selected'));
    btn.classList.add('questions-selected');
  };
});
document.querySelector('.questions-btn[data-q="10"]').click();

document.querySelectorAll('#mode-choose .mode-btn').forEach(btn=>{
  btn.onclick=()=>{
    state.mode=btn.dataset.mode;
    document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('mode-selected'));
    btn.classList.add('mode-selected');
  };
});
document.querySelector('.mode-btn[data-mode="multiplication"]').click();

// --------------------------------------------------
// LANCER LE JEU
// --------------------------------------------------
$('btn-play').onclick = ()=>{
  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if(!state.prenom || !state.classe){
    alert("Merci d‚Äôentrer un pr√©nom et une classe.");
    return;
  }

  state.questionCount=0;
  state.correctCount=0;
  state.mistakes={};

  $('start').classList.add('hidden');
  $('result').classList.add('hidden');
  $('game').classList.remove('hidden');

  nextQuestion();
};

// --------------------------------------------------
// UTILITAIRES
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getRangeFromLevel(level){
  if(level===1) return [1,9];
  if(level===2) return [10,20];
  return [10,99];
}

// --------------------------------------------------
// AFFICHAGE DU PAV√â NUM√âRIQUE / JUSTE / FAUX
// --------------------------------------------------
function createContextualPad(){
  const pad = $('numpad');
  pad.innerHTML = "";

  // Mode VRAI / FAUX
  if(state.mode === "vrai_faux"){
    createTrueFalseButtons("vrai","faux");
    return;
  }

  // Mode TROUVE L‚ÄôERREUR
  if(state.mode === "erreur"){
    createTrueFalseButtons("juste","faux");
    return;
  }

  // Sinon ‚Üí pav√© num√©rique classique
  const digits=[[1,2,3],[4,5,6],[7,8,9],['Eff',0,'OK']];
  digits.forEach(row=>{
    row.forEach(val=>{
      const b=document.createElement("button");
      b.type="button";
      b.textContent=val;

      if(val==='Eff') b.className="numpad-eff";
      if(val==='OK')  b.className="numpad-ok";

      b.onclick=()=>handleNumpad(val);
      pad.appendChild(b);
    });
    pad.appendChild(document.createElement("br"));
  });
}

// Boutons Vrai/Faux ou Juste/Faux
function createTrueFalseButtons(txt1,txt2){
  const pad = $('numpad');

  let b1=document.createElement("button");
  b1.type="button";
  b1.textContent=txt1;
  b1.className="numpad-vrai";
  b1.onclick=()=>{ $('answer').value=txt1; submitAnswer(); };

  let b2=document.createElement("button");
  b2.type="button";
  b2.textContent=txt2;
  b2.className="numpad-faux";
  b2.onclick=()=>{ $('answer').value=txt2; submitAnswer(); };

  pad.appendChild(b1);
  pad.appendChild(b2);
}

function handleNumpad(v){
  const input=$('answer');
  if(typeof v==='number'){ input.value+=v; }
  else if(v==="Eff"){ input.value=input.value.slice(0,-1); }
  else if(v==="OK"){ submitAnswer(); }
}

// --------------------------------------------------
// G√âN√âRATION DES QUESTIONS
// --------------------------------------------------
function nextQuestion(){
  state.questionCount++;
  if(state.questionCount > state.numQuestions){ return finishGame(); }

  let [min,max]=getRangeFromLevel(state.level);
  let a=randInt(min,max), b=randInt(min,max);
  let rep=null, quest='';

  switch(state.operation){
    case "add": quest=`${a} + ${b}`; rep=a+b; break;
    case "subtract": if(b>a)[a,b]=[b,a]; quest=`${a} ‚àí ${b}`; rep=a-b; break;
    case "multiply": quest=`${a} √ó ${b}`; rep=a*b; break;
    case "divide": rep=a; quest=`${a*b} √∑ ${b}`; break;
  }

  state.correctAnswer = rep;

  // Mode vrai/faux ‚Üí valeur potentiellement fausse
  if(state.mode==="vrai_faux"){
    let correct = Math.random() < 0.5;
    let shown = rep;

    if(!correct){
      shown = rep + randInt(1,5);
    }

    state.vraiFauxIsTrue = (shown === rep);
    state.currentQuestion = quest+" = "+shown;
  }

  // Mode trouve l'erreur ‚Üí "juste ou faux"
  else if(state.mode==="erreur"){
    let isWrong = Math.random() < 0.5;
    let shown = rep;

    if(isWrong){
      shown = rep + randInt(1,3);
    }

    state.erreurQuestion = isWrong;
    state.currentQuestion = quest+" = "+shown;
  }

  else {
    state.currentQuestion = quest;
  }

  $('question').textContent = state.currentQuestion;
  $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;
  $('answer').value="";
  $('answer').focus();

  createContextualPad();
}

// --------------------------------------------------
// VALIDATION DES R√âPONSES
// --------------------------------------------------
function submitAnswer(){
  let ans = $('answer').value.trim().toLowerCase();
  let ok=false;

  if(state.mode==="multiplication" || state.mode==="chrono" || state.mode==="classique"){
    ok = (parseInt(ans) === state.correctAnswer);
  }

  else if(state.mode==="vrai_faux"){
    let userTrue = /^(vrai|true|1)$/i.test(ans);
    ok = (userTrue === state.vraiFauxIsTrue);
  }

  else if(state.mode==="erreur"){
    let userJuste = /^(juste|true|1)$/i.test(ans);
    let userFaux  = /^(faux|false|0)$/i.test(ans);

    ok = (state.erreurQuestion && userFaux) || (!state.erreurQuestion && userJuste);
  }

  if(ok) state.correctCount++;

  nextQuestion();
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){
  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

  let qrData = {
    resultat: `${state.operation} N${state.level} ${state.correctCount}/${state.numQuestions}`
  };

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

$('restart').onclick = ()=>{
  $('result').classList.add('hidden');
  $('start').classList.remove('hidden');
};

</script>

</body>
</html>
