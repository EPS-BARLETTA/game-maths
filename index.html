<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Math√©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1a1a1a;
      color: #fff;
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 95%;
      max-width: 450px;
      background: #2b2b2b;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 0 25px #0008;
      text-align: center;
    }

    .hidden { display: none !important; }

    /* TITRES */
    h1, h2, h3 { margin: 10px 0; }

    /* PAGE DE GARDE */
    #welcome {
      padding: 20px;
    }

    #startApp {
      padding: 14px 28px;
      background: #fff;
      color: #000;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      font-weight: bold;
    }

    /* INPUT TEXTE MODERNE (OPTION C) */
    .answerBox {
      width: 150px;
      height: 55px;
      margin: 8px auto 12px auto;
      background: #111;
      color: white;
      border-radius: 12px;
      font-size: 1.8em;
      font-weight: bold;
      border: 2px solid #555;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: inset 0 0 10px #0007;
    }

    /* Pour cacher la zone en vrai/faux + erreur */
    .hideAnswerBox { visibility: hidden; }

    /* S√©lection page */
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      margin: 6px;
      cursor: pointer;
      font-size: 1.05em;
      color: #000;
      font-weight: bold;
    }

    /* Boutons pastel lisibles */
    .operation-btn[data-op="multiply"] { background: #ffb74d; }
    .operation-btn[data-op="add"]      { background: #81d4fa; }
    .operation-btn[data-op="subtract"] { background: #ce93d8; }
    .operation-btn[data-op="divide"]   { background: #ef9a9a; }

    .level-btn[data-level="1"] { background:#aed581; }
    .level-btn[data-level="2"] { background:#fff176; }
    .level-btn[data-level="3"] { background:#b0bec5; }

    .mode-btn[data-mode="multiplication"] { background:#81c784; }
    .mode-btn[data-mode="chrono"]         { background:#4fc3f7; }
    .mode-btn[data-mode="vrai_faux"]      { background:#f48fb1; }
    .mode-btn[data-mode="erreur"]         { background:#bcaaa4; }

    .questions-btn { background:#e0e0e0; }

    .selected {
      outline: 3px solid #fff;
      filter: brightness(1.12);
    }

    .button {
      background: #fff;
      color: #000;
      padding: 12px 24px;
      font-size: 1.2em;
      border-radius: 14px;
      font-weight: bold;
    }

    /* PAGE CHRONO AVANT D√âMARRAGE */
    #chronoStartPage { padding: 20px; }

    /* ZONE QUESTION */
    #question {
      font-size: 2.4em;
      margin: 12px 0;
      min-height: 1.2em;
    }

    /* PAV√â NUM√âRIQUE (GRAND) */
    #numpad-row {
      display: flex;
      justify-content: center;
    }

    #numpad button {
      width: 85px;
      height: 75px;
      margin: 5px;
      border-radius: 14px;
      background: #3c3c3c;
      color: #fff;
      font-size: 1.8em;
      box-shadow: 0 0 10px #0006;
      cursor: pointer;
    }

    .numpad-eff { background:#7e7e7e !important; }
    .numpad-ok  { background:#4caf50 !important; }

    .numpad-vrai { background:#4caf50 !important; width:48%; height:70px; }
    .numpad-faux { background:#e53935 !important; width:48%; height:70px; }

    /* FEEDBACK ‚úì / ‚ùå */
    #feedback {
      height: 45px;
      font-size: 2.4em;
      font-weight: bold;
      margin-top: 10px;
    }

    /* CHRONO */
    #chronoDisplay {
      margin-top: 12px;
      font-size: 1.5em;
      font-weight: bold;
    }

    /* R√âSULTATS */
    #result canvas {
      margin: 20px auto;
      display: block;
    }
  </style>
</head>

<body>

<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>üéÆ D√©fi Math√©matiques</h1>
    <button id="startApp">D√©marrer</button>
  </div>

  <!-- PAGE DE S√âLECTION -->
  <div id="start" class="hidden">
    <p>Pr√©nom : <input id="prenom" type="text"></p>
    <p>Classe : <input id="classe" type="text"></p>

    <h3>Op√©ration :</h3>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <h3>Niveau :</h3>
    <div id="level-choose"></div>

    <h3>Nombre de questions :</h3>
    <div id="questions-choose"></div>

    <h3>Mode :</h3>
    <div id="mode-choose"></div>

    <button id="btn-play" class="button">Valider</button>
  </div>

  <!-- PAGE INTERM√âDIAIRE CHRONO -->
  <div id="chronoStartPage" class="hidden">
    <h2>Mode Chrono</h2>
    <p>Appuie pour commencer :</p>
    <button id="btn-start-chrono" class="button">D√©marrer l‚Äôexercice</button>
  </div>

  <!-- PAGE DE JEU -->
  <form id="game" class="hidden" onsubmit="return false;">
    <div class="answerBox" id="answerBox"></div>
    <div id="question"></div>
    <div id="numpad"></div>
    <div id="feedback"></div>
    <div id="chronoDisplay" class="hidden">‚è± 0.0s</div>
    <p id="progress"></p>
  </form>

  <!-- R√âSULTATS -->
  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText"></p>
    <p id="timeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>

<!-- ICI TU COLLERAS LE BLOC 2 -->
// --------------------------------------------------
// √âTAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: 'multiply',
  level: 1,
  numQuestions: 10,
  prenom: '',
  classe: '',
  questionCount: 0,
  correctCount: 0,
  currentQuestion: '',
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: []
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$('startApp').onclick = () => {
  $('welcome').classList.add('hidden');
  $('start').classList.remove('hidden');
};

// --------------------------------------------------
// OP√âRATIONS
// --------------------------------------------------
const ops = [
  {op:"multiply", label:"√ó Multiplication"},
  {op:"add", label:"+ Addition"},
  {op:"subtract", label:"‚àí Soustraction"},
  {op:"divide", label:"√∑ Division"}
];

ops.forEach(o=>{
  let b=document.createElement("button");
  b.className="operation-btn";
  b.dataset.op=o.op;
  b.textContent=o.label;

  b.onclick=()=>{
    state.operation=o.op;
    document.querySelectorAll('.operation-btn').forEach(x=>x.classList.remove('op-selected'));
    b.classList.add('op-selected');

    $('tables-choose').classList.toggle('hidden', o.op!=="multiply");
    if(o.op!=="multiply"){
      state.selectedTables=[];
      document.querySelectorAll(".table-btn").forEach(t=>t.classList.remove("table-selected"));
    }
  };

  $('op-choose').appendChild(b);
});
document.querySelector('.operation-btn[data-op="multiply"]').classList.add('op-selected');

// --------------------------------------------------
// TABLES PERSO
// --------------------------------------------------
let htmlTables="";
for(let i=1;i<=12;i++){
  htmlTables += `<button class="table-btn" data-table="${i}">${i}</button>`;
}
$('tables-choose').innerHTML = "<h3>Tables personnalis√©es :</h3>" + htmlTables;

document.querySelectorAll(".table-btn").forEach(btn=>{
  btn.onclick=()=>{
    let val = parseInt(btn.dataset.table);
    if(state.selectedTables.includes(val)){
      state.selectedTables = state.selectedTables.filter(x=>x!==val);
      btn.classList.remove("table-selected");
    } else {
      state.selectedTables.push(val);
      btn.classList.add("table-selected");
    }
  };
});

// --------------------------------------------------
// NIVEAUX
// --------------------------------------------------
[1,2,3].forEach(l=>{
  let b=document.createElement("button");
  b.className="level-btn";
  b.dataset.level=l;
  b.textContent="Niveau "+l;

  b.onclick=()=>{
    state.level=l;
    document.querySelectorAll('.level-btn').forEach(x=>x.classList.remove('level-selected'));
    b.classList.add('level-selected');
  };

  $('level-choose').appendChild(b);
});
document.querySelector('.level-btn[data-level="1"]').classList.add('level-selected');

// --------------------------------------------------
// NOMBRE DE QUESTIONS (+ 25 et 30)
// --------------------------------------------------
[10,15,20,25,30].forEach(q=>{
  let b=document.createElement("button");
  b.className="questions-btn";
  b.dataset.q=q;
  b.textContent=q;

  b.onclick=()=>{
    state.numQuestions=q;
    document.querySelectorAll('.questions-btn').forEach(x=>x.classList.remove('questions-selected'));
    b.classList.add('questions-selected');
  };

  $('questions-choose').appendChild(b);
});
document.querySelector('.questions-btn[data-q="10"]').classList.add('questions-selected');

// --------------------------------------------------
// MODES
// --------------------------------------------------
const modes = [
  {m:"multiplication", label:"Classique"},
  {m:"chrono", label:"Chrono"},
  {m:"vrai_faux", label:"Vrai/Faux"},
  {m:"erreur", label:"Erreur"}
];

modes.forEach(o=>{
  let b=document.createElement("button");
  b.className="mode-btn";
  b.dataset.mode=o.m;
  b.textContent=o.label;

  b.onclick=()=>{
    state.mode=o.m;
    document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('mode-selected'));
    b.classList.add('mode-selected');
  };

  $('mode-choose').appendChild(b);
});
document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add('mode-selected');

// --------------------------------------------------
// LANCEMENT DU JEU
// --------------------------------------------------
$('btn-play').onclick = () => {

  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if(!state.prenom || !state.classe){
    alert("Merci d‚Äôentrer un pr√©nom et une classe.");
    return;
  }

  // Reset
  state.questionCount=0;
  state.correctCount=0;
  state.chronoTime=0;

  $('start').classList.add('hidden');
  $('result').classList.add('hidden');
  $('game').classList.remove('hidden');

  // On affiche d‚Äôabord un bouton pour d√©marrer en mode chrono
  if(state.mode==="chrono"){
    $('question').innerHTML = "<button id='startChronoBtn' class='button'>D√©marrer l‚Äôexercice</button>";
    $('numpad').innerHTML="";
    $('progress').textContent="";
    $('chronoLine').textContent="‚è± 0 sec";
    $('chronoBar').classList.add("hidden");

    document.getElementById("startChronoBtn").onclick = () => {
      state.chronoStart = Date.now();
      $('chronoBar').classList.remove("hidden");
      startChrono();
      nextQuestion();
    };
  }
  else {
    $('chronoBar').classList.add("hidden");
    nextQuestion();
  }
};

// --------------------------------------------------
// CHRONO ‚Äî COMPTE SIMPLE (pas de barre)
// --------------------------------------------------
let chronoInterval=null;

function startChrono(){
  if(chronoInterval) clearInterval(chronoInterval);

  chronoInterval=setInterval(()=>{
    let elapsed = Math.floor((Date.now()-state.chronoStart)/1000);
    $('chronoLine').textContent = "‚è± " + elapsed + " sec";
  },200);
}

function stopChrono(){
  if(chronoInterval) clearInterval(chronoInterval);
  state.chronoTime = Math.floor((Date.now()-state.chronoStart)/1000);
}

// --------------------------------------------------
// UTIL FUNCTIONS
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getRange(level){
  if(level===1) return [1,9];
  if(level===2) return [10,20];
  return [10,99];
}

// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createPad(){
  const pad=$('numpad');
  pad.innerHTML="";

  // VRAI / FAUX
  if(state.mode==="vrai_faux") return createVF("vrai","faux");
  if(state.mode==="erreur") return createVF("juste","faux");

  const rows=[
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ["Eff",0,"OK"]
  ];

  rows.forEach(r=>{
    let line=document.createElement("div");
    line.id="numpad-row";

    r.forEach(v=>{
      let b=document.createElement("button");
      b.textContent=v;

      if(v==="Eff") b.className="numpad-eff";
      if(v==="OK") b.className="numpad-ok";

      b.onclick = ()=>handleNumpad(v);
      line.appendChild(b);
    });

    pad.appendChild(line);
  });
}

function createVF(a,b){
  const pad=$('numpad');
  pad.innerHTML="";

  let b1=document.createElement("button");
  b1.className="numpad-vrai";
  b1.textContent=a;
  b1.onclick=()=>{ $('answer').value=a; submitAnswer(); };

  let b2=document.createElement("button");
  b2.className="numpad-faux";
  b2.textContent=b;
  b2.onclick=()=>{ $('answer').value=b; submitAnswer(); };

  pad.appendChild(b1);
  pad.appendChild(b2);
}

function handleNumpad(v){
  let input=$('answer');

  if(typeof v==="number"){
    input.value+=v;
  }
  else if(v==="Eff"){
    input.value=input.value.slice(0,-1);
  }
  else if(v==="OK"){
    submitAnswer();
  }
}

// --------------------------------------------------
// G√âN√âRATION QUESTION
// --------------------------------------------------
function nextQuestion(){

  state.questionCount++;

  if(state.questionCount>state.numQuestions){
    return finishGame();
  }

  let a,b,rep,quest;

  if(state.operation==="multiply" && state.selectedTables.length>0){
    a = state.selectedTables[randInt(0,state.selectedTables.length-1)];
    b = randInt(0,12);
    rep=a*b;
    quest=`${a} √ó ${b}`;
  }
  else {
    let [min,max] = getRange(state.level);
    a=randInt(min,max);
    b=randInt(min,max);

    switch(state.operation){
      case "add": rep=a+b; quest=`${a} + ${b}`; break;
      case "subtract": if(b>a)[a,b]=[b,a]; rep=a-b; quest=`${a} ‚àí ${b}`; break;
      case "multiply": rep=a*b; quest=`${a} √ó ${b}`; break;
      case "divide": rep=a; quest=`${a*b} √∑ ${b}`; break;
    }
  }

  state.correctAnswer=rep;
  $('answer').value="";
  $('answer').style.background="#111";
  $('answer').style.color="#fff";

  // VRAI / FAUX
  if(state.mode==="vrai_faux"){
    let shown = rep + (Math.random()<0.5 ? 0 : randInt(1,5));
    state.vraiFauxIsTrue = (shown===rep);
    quest += " = " + shown;
  }

  // ERREUR
  if(state.mode==="erreur"){
    let wrong = Math.random()<0.5;
    let shown = wrong ? rep + randInt(1,3) : rep;
    state.erreurQuestion = wrong;
    quest += " = " + shown;
  }

  state.currentQuestion=quest;

  $('question').textContent=quest;
  $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;

  createPad();
}

// --------------------------------------------------
// VALIDATION R√âPONSE
// --------------------------------------------------
function submitAnswer(){

  let ans = $('answer').value.trim().toLowerCase();
  let ok=false;

  if(state.mode==="multiplication" || state.mode==="chrono"){
    ok = (parseInt(ans)===state.correctAnswer);
  }

  if(state.mode==="vrai_faux"){
    ok = (/^(vrai|true|1)$/i.test(ans) === state.vraiFauxIsTrue);
  }

  if(state.mode==="erreur"){
    let juste = /^(juste|true|1)$/i.test(ans);
    let faux  = /^(faux|false|0)$/i.test(ans);
    ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
  }

  if(ok){
    $('question').innerHTML = "‚úÖ Bonne r√©ponse !";
    setTimeout(nextQuestion,500);
    state.correctCount++;
  }
  else {
    $('question').innerHTML = `‚ùå Faux<br><small>R√©ponse attendue : ${state.correctAnswer}</small>`;
    setTimeout(nextQuestion,1500);
  }
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){

  if(state.mode==="chrono"){
    stopChrono();
  }

  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

  if(state.mode==="chrono"){
    $('bestTimeText').textContent = `‚è± Temps : ${state.chronoTime}s`;
  } else {
    $('bestTimeText').textContent = "";
  }

  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    mode: state.mode,
    score: `${state.correctCount}/${state.numQuestions}`,
  };

  if(state.mode==="chrono"){
    qrData.temps = state.chronoTime;
  }

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// RESTART
// --------------------------------------------------
$('restart').onclick = ()=>{
  $('result').classList.add('hidden');
  $('start').classList.remove('hidden');
};
