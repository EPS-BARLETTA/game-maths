<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Math√©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    body { 
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #fff;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      width: 95%;
      max-width: 450px;
      background: #2b2b2b;
      padding: 20px;
      border-radius: 18px;
      box-shadow: 0 0 20px #0008;
      text-align: center;
    }

    /* TITRES */
    h1, h2, h3 {
      margin: 10px 0;
    }

    /* PAGE DE GARDE */
    #welcome { padding: 20px; }

    #startApp {
      padding: 14px 28px;
      background: #fff;
      color: #000;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-size: 1.2em;
      font-weight: bold;
    }

    /* INPUTS */
    input[type="text"] {
      width: 75%;
      padding: 10px;
      margin: 10px auto;
      background: #111;
      color: white;
      border-radius: 10px;
      border: none;
      font-size: 1.1em;
      text-align: center;
      display: block;
    }

    /* BOUTONS DE S√âLECTION (couleurs pastel sombre) */
    .operation-btn[data-op="multiply"] { background:#ff9800; }
    .operation-btn[data-op="add"] { background:#42a5f5; }
    .operation-btn[data-op="subtract"] { background:#ab47bc; }
    .operation-btn[data-op="divide"] { background:#ef5350; }

    .level-btn[data-level="1"] { background:#9ccc65; }
    .level-btn[data-level="2"] { background:#ffeb3b; color:#000; }
    .level-btn[data-level="3"] { background:#90a4ae; }

    .mode-btn[data-mode="multiplication"] { background:#4caf50; }
    .mode-btn[data-mode="chrono"] { background:#29b6f6; }
    .mode-btn[data-mode="vrai_faux"] { background:#f06292; }
    .mode-btn[data-mode="erreur"] { background:#8d6e63; }

    .questions-btn { background:#424242; }

    .selected {
      border: 2px solid #fff;
      filter: brightness(1.2);
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      margin: 6px;
      font-size: 1.1em;
    }

    .button {
      background: #fff;
      color: #000;
      font-weight: bold;
      border-radius: 12px;
    }

    /* PAGE CHRONO */
    #chronoStartPage {
      padding: 20px 10px;
    }

    /* ZONE DE JEU */
    #question {
      font-size: 2.4em;
      margin: 18px 0;
      min-height: 1.2em;
    }

    /* PAV√â NUM√âRIQUE (GROS) */
    #numpad { margin-top: 10px; }

    #numpad-row {
      display: flex;
      justify-content: center;
    }

    #numpad button {
      width: 85px;
      height: 75px;
      margin: 5px;
      font-size: 1.8em;
      background: #3c3c3c;
      color: white;
      border-radius: 14px;
      box-shadow: 0 0 10px #0006;
    }

    .numpad-eff { background:#888 !important; }
    .numpad-ok { background:#4caf50 !important; }
    .numpad-vrai { background:#4caf50 !important; width:48%; height:70px; }
    .numpad-faux { background:#e53935 !important; width:48%; height:70px; }

    /* FEEDBACK ‚úì / ‚úó */
    #feedback {
      height: 45px;
      font-size: 2.4em;
      font-weight: bold;
      margin-top: 10px;
    }

    /* CHRONO */
    #chronoDisplay {
      margin-top: 12px;
      font-size: 1.4em;
      font-weight: bold;
    }

    /* R√âSULTATS */
    #result { padding: 10px; }

    #result canvas {
      margin: 20px auto;
      display: block;
    }

    .hidden { display:none !important; }
  </style>
</head>

<body>

<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>üéÆ D√©fi Math√©matiques</h1>
    <button id="startApp">D√©marrer</button>
  </div>

  <!-- PAGE DE S√âLECTION -->
  <div id="start" class="hidden">
    
    <p>Pr√©nom : <input id="prenom" type="text"></p>
    <p>Classe : <input id="classe" type="text"></p>

    <h3>Op√©ration :</h3>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <h3>Niveau :</h3>
    <div id="level-choose"></div>

    <h3>Nombre de questions :</h3>
    <div id="questions-choose"></div>

    <h3>Mode :</h3>
    <div id="mode-choose"></div>

    <button id="btn-play" class="button">Valider</button>
  </div>

  <!-- PAGE INTERM√âDIAIRE CHRONO -->
  <div id="chronoStartPage" class="hidden">
    <h2>Mode Chrono</h2>
    <p>Lorsque tu es pr√™t :</p>
    <button id="btn-start-chrono" class="button">D√©marrer l‚Äôexercice</button>
  </div>

  <!-- ZONE DE JEU -->
  <form id="game" class="hidden" onsubmit="return false;">
    <div id="question"></div>
    <div id="numpad"></div>
    <div id="feedback"></div>
    <div id="chronoDisplay" class="hidden">‚è± 0.0s</div>
    <p id="progress"></p>
  </form>

  <!-- R√âSULTATS -->
  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText"></p>
    <p id="timeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>

<!-- ICI TU COLLERAS LE BLOC 2 -->
<script>
// --------------------------------------------------
// √âTAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: "multiply",
  level: 1,
  numQuestions: 10,
  prenom: "",
  classe: "",
  questionCount: 0,
  correctCount: 0,
  currentQuestion: "",
  correctAnswer: null,
  selectedTables: [],
  chronoStart: 0,
  chronoTime: 0,
};

// Raccourci
const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$("startApp").onclick = () => {
  $("welcome").classList.add("hidden");
  $("start").classList.remove("hidden");
};

// --------------------------------------------------
// CR√âATION DES BOUTONS DE S√âLECTION
// --------------------------------------------------
function createButtons() {

  // ----- OP√âRATIONS -----
  const ops = [
    { op: "multiply", label: "√ó Multiplication" },
    { op: "add", label: "+ Addition" },
    { op: "subtract", label: "‚àí Soustraction" },
    { op: "divide", label: "√∑ Division" }
  ];
  ops.forEach(o => {
    let b = document.createElement("button");
    b.className = "operation-btn";
    b.dataset.op = o.op;
    b.textContent = o.label;
    b.onclick = () => selectOperation(b, o.op);
    $("op-choose").appendChild(b);
  });

  // ----- NIVEAUX -----
  [1,2,3].forEach(l => {
    let b = document.createElement("button");
    b.className = "level-btn";
    b.dataset.level = l;
    b.textContent = "Niveau " + l;
    b.onclick = () => selectLevel(b, l);
    $("level-choose").appendChild(b);
  });

  // ----- QUESTIONS -----
  [10,15,20,25,30].forEach(q => {
    let b = document.createElement("button");
    b.className = "questions-btn";
    b.dataset.q = q;
    b.textContent = q;
    b.onclick = () => selectQuestions(b, q);
    $("questions-choose").appendChild(b);
  });

  // ----- MODES -----
  const modes = [
    { m: "multiplication", label: "Classique" },
    { m: "chrono", label: "Chrono" },
    { m: "vrai_faux", label: "Vrai/Faux" },
    { m: "erreur", label: "Erreur" }
  ];
  modes.forEach(o => {
    let b = document.createElement("button");
    b.className = "mode-btn";
    b.dataset.mode = o.m;
    b.textContent = o.label;
    b.onclick = () => selectMode(b, o.m);
    $("mode-choose").appendChild(b);
  });

  // S√©lections par d√©faut
  document.querySelector(".operation-btn[data-op='multiply']").classList.add("selected");
  document.querySelector(".level-btn[data-level='1']").classList.add("selected");
  document.querySelector(".questions-btn[data-q='10']").classList.add("selected");
  document.querySelector(".mode-btn[data-mode='multiplication']").classList.add("selected");
}
createButtons();

// --------------------------------------------------
// GESTION DES S√âLECTIONS
// --------------------------------------------------
function clearSelection(selector) {
  document.querySelectorAll(selector).forEach(b => b.classList.remove("selected"));
}

function selectOperation(btn, op) {
  clearSelection(".operation-btn");
  btn.classList.add("selected");
  state.operation = op;

  $("tables-choose").innerHTML = "";
  state.selectedTables = [];

  if (op === "multiply") {
    let txt = document.createElement("h3");
    txt.textContent = "Tables personnalis√©es :";
    $("tables-choose").appendChild(txt);

    for (let i = 1; i <= 12; i++) {
      let t = document.createElement("button");
      t.className = "table-btn";
      t.textContent = i;
      t.dataset.table = i;
      t.onclick = () => toggleTable(t, i);
      $("tables-choose").appendChild(t);
    }

    $("tables-choose").classList.remove("hidden");
  } else {
    $("tables-choose").classList.add("hidden");
  }
}

function toggleTable(btn, t) {
  if (state.selectedTables.includes(t)) {
    state.selectedTables = state.selectedTables.filter(x => x !== t);
    btn.classList.remove("selected");
  } else {
    state.selectedTables.push(t);
    btn.classList.add("selected");
  }
}

function selectLevel(btn, level) {
  clearSelection(".level-btn");
  btn.classList.add("selected");
  state.level = level;
}

function selectQuestions(btn, q) {
  clearSelection(".questions-btn");
  btn.classList.add("selected");
  state.numQuestions = q;
}

function selectMode(btn, mode) {
  clearSelection(".mode-btn");
  btn.classList.add("selected");
  state.mode = mode;
}

// --------------------------------------------------
// VALIDATION DES PARAM√àTRES
// --------------------------------------------------
$("btn-play").onclick = () => {

  state.prenom = $("prenom").value.trim();
  state.classe = $("classe").value.trim();

  if (!state.prenom || !state.classe) {
    alert("Merci d‚Äôentrer un pr√©nom et une classe.");
    return;
  }

  $("start").classList.add("hidden");

  if (state.mode === "chrono") {
    $("chronoStartPage").classList.remove("hidden");
  } else {
    startGame();
  }
};

// --------------------------------------------------
// BOUTON ‚Üí D√âBUT DU MODE CHRONO
// --------------------------------------------------
$("btn-start-chrono").onclick = () => {
  $("chronoStartPage").classList.add("hidden");
  startGame(true);
};

// --------------------------------------------------
// D√âBUT DU JEU
// --------------------------------------------------
function startGame(isChrono = false) {
  state.questionCount = 0;
  state.correctCount = 0;
  $("feedback").textContent = "";

  if (isChrono) {
    $("chronoDisplay").classList.remove("hidden");
    state.chronoStart = performance.now();
  } else {
    $("chronoDisplay").classList.add("hidden");
  }

  $("game").classList.remove("hidden");

  nextQuestion();
}

// --------------------------------------------------
// G√âN√âRATION DES QUESTIONS
// --------------------------------------------------
function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

function getLevelRange() {
  if (state.level === 1) return [1,9];
  if (state.level === 2) return [10,20];
  return [10,99];
}

function nextQuestion() {
  $("feedback").textContent = "";

  state.questionCount++;
  if (state.questionCount > state.numQuestions) return endGame();

  let a,b,rep,quest;

  // TABLES PERSO
  if (state.operation === "multiply" && state.selectedTables.length > 0) {
    a = state.selectedTables[randInt(0, state.selectedTables.length - 1)];
    b = randInt(0,12);
    rep = a*b;
    quest = `${a} √ó ${b}`;
  } else {
    let [min,max] = getLevelRange();
    a = randInt(min,max);
    b = randInt(min,max);

    switch (state.operation) {
      case "add": rep = a+b; quest = `${a} + ${b}`; break;
      case "subtract": if (b>a) [a,b]=[b,a]; rep=a-b; quest=`${a} ‚àí ${b}`; break;
      case "multiply": rep = a*b; quest = `${a} √ó ${b}`; break;
      case "divide": rep = a; quest = `${a*b} √∑ ${b}`; break;
    }
  }

  state.correctAnswer = rep;

  // MODES SP√âCIAUX
  if (state.mode === "vrai_faux") {
    let shown = rep + (Math.random() < 0.5 ? 0 : randInt(1,5));
    state.vraiCorrect = (shown === rep);
    quest += " = " + shown;
  }

  if (state.mode === "erreur") {
    let wrong = Math.random() < 0.5;
    let shown = wrong ? rep + randInt(1,3) : rep;
    state.errExpected = !wrong; // juste = pas faux
    quest += " = " + shown;
  }

  $("question").textContent = quest;
  $("progress").textContent = `${state.questionCount}/${state.numQuestions}`;

  createPad();
}

// --------------------------------------------------
// PAV√â NUM√âRIQUE
// --------------------------------------------------
function createPad() {
  const pad = $("numpad");
  pad.innerHTML = "";

  if (state.mode === "vrai_faux") {
    createVF("vrai","faux");
    return;
  }

  if (state.mode === "erreur") {
    createVF("juste","faux");
    return;
  }

  const rows = [
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ["Eff",0,"OK"]
  ];

  rows.forEach(row => {
    let div = document.createElement("div");
    div.id = "numpad-row";
    row.forEach(v => {
      let b = document.createElement("button");
      b.textContent = v;
      if (v === "Eff") b.className="numpad-eff";
      if (v === "OK") b.className="numpad-ok";
      b.onclick = () => handlePadClick(v);
      div.appendChild(b);
    });
    pad.appendChild(div);
  });
}

function createVF(a,b) {
  const pad = $("numpad");
  pad.innerHTML = "";

  let B1 = document.createElement("button");
  B1.className="numpad-vrai";
  B1.textContent=a;
  B1.onclick=()=>{ submitAnswer(a); };
  pad.appendChild(B1);

  let B2 = document.createElement("button");
  B2.className="numpad-faux";
  B2.textContent=b;
  B2.onclick=()=>{ submitAnswer(b); };
  pad.appendChild(B2);
}

function handlePadClick(v) {
  if (v === "Eff") return; // Efface ignor√© ici
  if (v === "OK") submitAnswer($("answer")?.value ?? "");
  else $("answer").value = ($("answer").value ?? "") + v;
}

// --------------------------------------------------
// VALIDATION DES R√âPONSES
// --------------------------------------------------
function submitAnswer(valRaw) {

  let ok = false;
  let expected = state.correctAnswer;

  if (state.mode === "multiplication" || state.mode === "chrono") {
    ok = (parseInt(valRaw) === expected);
  }

  if (state.mode === "vrai_faux") {
    ok = (/vrai/i.test(valRaw) === state.vraiCorrect);
  }

  if (state.mode === "erreur") {
    let isJuste = /juste/i.test(valRaw);
    let isFaux = /faux/i.test(valRaw);
    ok = (isJuste && state.errExpected) || (isFaux && !state.errExpected);
  }

  if (ok) {
    state.correctCount++;
    $("feedback").textContent = "‚úì";
    $("feedback").style.color = "#4caf50";
  } else {
    $("feedback").textContent = "‚úó  (R√©ponse : " + expected + ")";
    $("feedback").style.color = "#e53935";
  }

  setTimeout(nextQuestion, 1500);
}

// --------------------------------------------------
// FIN DU JEU
// --------------------------------------------------
function endGame() {
  $("game").classList.add("hidden");
  $("result").classList.remove("hidden");

  $("scoreText").textContent = `${state.correctCount}/${state.numQuestions}`;

  let time = null;
  if (state.mode === "chrono") {
    time = ((performance.now() - state.chronoStart) / 1000).toFixed(1);
    state.chronoTime = time;
    $("timeText").textContent = "‚è± Temps : " + time + "s";
  } else {
    $("timeText").textContent = "";
  }

  // QR CODE
  let data = {
    prenom: state.prenom,
    classe: state.classe,
    mode: state.mode,
    resultat: `${state.correctCount}/${state.numQuestions}`,
  };
  if (time) data.temps = time;

  new QRious({
    element: $("qr"),
    size: 260,
    value: JSON.stringify(data)
  });
}

// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$("restart").onclick = () => {
  $("result").classList.add("hidden");
  $("start").classList.remove("hidden");
};
</script>
