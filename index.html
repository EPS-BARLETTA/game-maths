<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>D√©fi Math√©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    /* PAGE EN FOND SOMBRE CENTR√âE */
    body { 
      font-family: Arial, sans-serif; 
      background: linear-gradient(145deg, #202124, #151515); 
      color: #fff; 
      margin: 0; 
      padding: 20px; 
      min-height: 100vh; 
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* CADRE PRINCIPAL */
    .container { 
      width: 100%;
      max-width: 580px;
      background: #2b2b2b;
      border-radius: 22px;
      padding: 24px 22px 26px;
      box-shadow: 0 6px 22px #000a;
      text-align: center;
    }

    #welcome h1 {
      font-size: 2.6rem;
      margin: 10px 0 24px;
    }

    #startApp {
      font-size: 1.6rem;
      padding: 14px 34px;
      background: #ffffff;
      color: #000;
      border-radius: 14px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 3px 8px #0009;
    }

    /* BOUTONS */
    button.button,
    .operation-btn,
    .level-btn,
    .mode-btn,
    .questions-btn,
    .table-btn {
      padding: 10px 18px;
      font-size: 1.1rem;
      margin: 6px;
      border-radius: 12px;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px #0006;
      transition: 0.2s ease;
    }

    /* PASTELS */
    .operation-btn[data-op="multiply"] { background:#FFE0A3; color:#000; }
    .operation-btn[data-op="add"]      { background:#A7D8FF; color:#000; }
    .operation-btn[data-op="subtract"] { background:#F7B7CF; color:#000; }
    .operation-btn[data-op="divide"]   { background:#FFB5A7; color:#000; }

    .level-btn[data-level="1"] { background:#C8E6C9; color:#000; }
    .level-btn[data-level="2"] { background:#FFF9C4; color:#000; }
    .level-btn[data-level="3"] { background:#B0BEC5; color:#000; }

    .mode-btn[data-mode="multiplication"] { background:#D1C4E9; color:#000; }
    .mode-btn[data-mode="chrono"]         { background:#B3E5FC; color:#000; }
    .mode-btn[data-mode="vrai_faux"]      { background:#FFCDD2; color:#000; }
    .mode-btn[data-mode="erreur"]         { background:#FFE0B2; color:#000; }

    .questions-btn { background:#E0E0E0; color:#000; }

    /* ‚≠ê‚≠ê‚≠ê VISUEL DE S√âLECTION (MODIFI√â) ‚≠ê‚≠ê‚≠ê */
    .op-selected,
    .level-selected,
    .questions-selected,
    .mode-selected,
    .table-selected {
      filter: brightness(0.70);
      border: 3px solid #fff;
      box-shadow: 0 0 14px #ffffffaa;
      transform: scale(1.10);
    }

    /* INPUTS */
    #prenom, #classe {
      width: 85%;
      font-size: 1.4rem;
      padding: 10px;
      border-radius: 10px;
      border: 2px solid #555;
      margin-top: 6px;
      background:#111;
      color:white;
      text-align:center;
    }

    h2 { font-size: 1.4rem; margin: 14px 0 6px; }

    .hidden { display:none !important; }

    /* JEU */
    #question { font-size: 3rem; margin-top: 10px; min-height: 72px; }
    #answer {
      width: 80%;
      font-size: 2rem;
      padding: 12px;
      margin-top: 10px;
      background:#111;
      border:2px solid #777;
      border-radius:14px;
      color:white;
      text-align:center;
    }

    #numpad button {
      width: 80px;
      height: 80px;
      font-size: 1.8rem;
      margin: 8px;
      border-radius: 16px;
      border: none;
      background: #444;
      color: #fff;
    }

    .numpad-eff { background:#bdbdbd !important; color:#222 !important; }
    .numpad-ok  { background:#4CAF50 !important; color:white !important; }

    .numpad-vrai {
      background:#34C759 !important;
      width:46%;
      height:90px;
      font-size:2rem;
      border-radius:16px;
      margin: 6px;
      border:none;
      color:white;
    }

    .numpad-faux {
      background:#FF3B30 !important;
      width:46%;
      height:90px;
      font-size:2rem;
      border-radius:16px;
      margin: 6px;
      border:none;
      color:white;
    }

    #result h2 { font-size:2.2rem; }
    #scoreText { font-size:2rem; }
    #bestTimeText { font-size:1.3rem; opacity:0.85; }
  </style>
</head>

<body>
<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>üéÆ D√©fi Math√©matiques</h1>
    <button id="startApp">D√©marrer</button>
  </div>

  <!-- PAGE DE S√âLECTION -->
  <div id="start" class="hidden">

    <p>Pr√©nom :<br><input id="prenom" type="text" maxlength="18"></p>
    <p>Classe :<br><input id="classe" type="text" maxlength="18"></p>

    <h2>Type d'op√©ration</h2>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <h2>Niveau</h2>
    <div id="level-choose"></div>

    <h2>Nombre de questions</h2>
    <div id="questions-choose"></div>

    <h2>Mode</h2>
    <div id="mode-choose"></div>

    <button id="btn-play" class="button" style="margin-top:14px;">Valider</button>
  </div>
  <!-- PAGE DE JEU -->
  <div id="game" class="hidden">
    <div id="question"></div>

    <input id="answer" type="text" autocomplete="off">

    <div id="numpad"></div>

    <div id="chronoLine"></div>
    <p id="progress"></p>
  </div>

  <!-- PAGE R√âSULTATS -->
  <div id="result" class="hidden">
    <h2>R√©sultat</h2>
    <p id="scoreText"></p>
    <p id="bestTimeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button" style="margin-top:16px;">Rejouer</button>
  </div>

</div> <!-- FIN CONTAINER -->

<script>
  // --------------------------------------------------
  // √âTAT GLOBAL
  // --------------------------------------------------
  let state = {
    mode: null,
    operation: 'multiply',
    level: 1,
    numQuestions: 10,
    prenom: '',
    classe: '',
    questionCount: 0,
    correctCount: 0,
    currentQuestion: '',
    correctAnswer: null,
    chronoStart: 0,
    chronoTime: 0,
    chronoInterval: null,
    vraiFauxIsTrue: false,
    erreurQuestion: false,
    selectedTables: [],
    gameStarted: false
  };

  const $ = id => document.getElementById(id);

  // --------------------------------------------------
  // PAGE DE GARDE
  // --------------------------------------------------
  $('startApp').onclick = () => {
    $('welcome').classList.add('hidden');
    $('start').classList.remove('hidden');
  };

  // --------------------------------------------------
  // UTILITAIRES
  // --------------------------------------------------
  function randInt(min,max){ 
    return Math.floor(Math.random()*(max-min+1))+min; 
  }

  function getRangeFromLevel(level){
    if(level===1) return [1,9];
    if(level===2) return [10,20];
    return [10,99];
  }

  // --------------------------------------------------
  // CONSTRUCTION DES BOUTONS DE S√âLECTION
  // --------------------------------------------------

  // Op√©rations
  const ops = [
    {op:"multiply", label:"√ó Multiplication"},
    {op:"add", label:"+ Addition"},
    {op:"subtract", label:"‚àí Soustraction"},
    {op:"divide", label:"√∑ Division"}
  ];

  ops.forEach(o=>{
    let b=document.createElement("button");
    b.className="operation-btn";
    b.dataset.op=o.op;
    b.textContent=o.label;

    b.onclick=()=>{
      state.operation=o.op;
      document.querySelectorAll('.operation-btn').forEach(x=>x.classList.remove('op-selected'));
      b.classList.add('op-selected');

      // tables perso uniquement pour multiplication
      const tDiv = $('tables-choose');
      if(o.op==="multiply"){
        tDiv.classList.remove('hidden');
      } else {
        tDiv.classList.add('hidden');
        state.selectedTables = [];
        document.querySelectorAll(".table-btn")
          .forEach(t=>t.classList.remove("table-selected"));
      }
    };

    $('op-choose').appendChild(b);
  });

  // Tables personnalis√©es
  (function buildTables(){
    const tDiv = $('tables-choose');
    const title = document.createElement('h2');
    title.textContent = "Tables personnalis√©es";
    tDiv.appendChild(title);

    for(let i=1;i<=12;i++){
      let b=document.createElement("button");
      b.className="table-btn";
      b.dataset.table=i;
      b.textContent=i;

      b.onclick=()=>{
        let val = parseInt(b.dataset.table);
        if(state.selectedTables.includes(val)){
          state.selectedTables = state.selectedTables.filter(x=>x!==val);
          b.classList.remove("table-selected");
        } else {
          state.selectedTables.push(val);
          b.classList.add("table-selected");
        }
      };

      tDiv.appendChild(b);
    }
  })();

  // Niveaux
  [1,2,3].forEach(l=>{
    let b=document.createElement("button");
    b.className="level-btn";
    b.dataset.level=l;
    b.textContent="Niveau "+l;

    b.onclick=()=>{
      state.level=l;
      document.querySelectorAll('.level-btn')
        .forEach(x=>x.classList.remove('level-selected'));
      b.classList.add('level-selected');
    };

    $('level-choose').appendChild(b);
  });

  // Nombre de questions (10,15,20,25,30)
  [10,15,20,25,30].forEach(q=>{
    let b=document.createElement("button");
    b.className="questions-btn";
    b.dataset.q=q;
    b.textContent=q;

    b.onclick=()=>{
      state.numQuestions=q;
      document.querySelectorAll('.questions-btn')
        .forEach(x=>x.classList.remove('questions-selected'));
      b.classList.add('questions-selected');
    };

    $('questions-choose').appendChild(b);
  });

  // Modes
  const modes = [
    {m:"multiplication", label:"Classique"},
    {m:"chrono", label:"Chrono"},
    {m:"vrai_faux", label:"Vrai/Faux"},
    {m:"erreur", label:"Erreur"}
  ];

  modes.forEach(o=>{
    let b=document.createElement("button");
    b.className="mode-btn";
    b.dataset.mode=o.m;
    b.textContent=o.label;

    b.onclick=()=>{
      state.mode=o.m;
      document.querySelectorAll('.mode-btn')
        .forEach(x=>x.classList.remove('mode-selected'));
      b.classList.add('mode-selected');
    };

    $('mode-choose').appendChild(b);
  });

  // S√©lections par d√©faut
  document.querySelector('.operation-btn[data-op="multiply"]').classList.add('op-selected');
  $('tables-choose').classList.remove('hidden');
  document.querySelector('.level-btn[data-level="1"]').classList.add('level-selected');
  document.querySelector('.questions-btn[data-q="10"]').classList.add('questions-selected');
  document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add('mode-selected');
  state.mode = "multiplication";

  // --------------------------------------------------
  // PAV√â NUM√âRIQUE
  // --------------------------------------------------
  function createNumpad(){
    const pad = $('numpad');
    pad.innerHTML = "";

    // Mode VRAI / FAUX
    if(state.mode === "vrai_faux"){
      let v = document.createElement("button");
      v.className = "numpad-vrai";
      v.textContent = "Vrai";
      v.onclick = () => { $('answer').value = "vrai"; submitAnswer(); };

      let f = document.createElement("button");
      f.className = "numpad-faux";
      f.textContent = "Faux";
      f.onclick = () => { $('answer').value = "faux"; submitAnswer(); };

      pad.appendChild(v);
      pad.appendChild(f);
      $('answer').style.visibility = 'hidden';
      return;
    }

    // Mode ERREUR
    if(state.mode === "erreur"){
      let j = document.createElement("button");
      j.className = "numpad-vrai";
      j.textContent = "Juste";
      j.onclick = () => { $('answer').value = "juste"; submitAnswer(); };

      let f = document.createElement("button");
      f.className = "numpad-faux";
      f.textContent = "Faux";
      f.onclick = () => { $('answer').value = "faux"; submitAnswer(); };

      pad.appendChild(j);
      pad.appendChild(f);
      $('answer').style.visibility = 'hidden';
      return;
    }

    // Mode normal
    $('answer').style.visibility = 'visible';

    const rows = [
      [1,2,3],
      [4,5,6],
      [7,8,9],
      ['Eff',0,'OK']
    ];

    rows.forEach(r=>{
      let line=document.createElement("div");
      line.style.display="flex";
      line.style.justifyContent="center";

      r.forEach(v=>{
        let b=document.createElement("button");
        b.textContent=v;
        if(v==="Eff") b.className="numpad-eff";
        if(v==="OK")  b.className="numpad-ok";
        b.onclick = ()=> handleNumpad(v);
        line.appendChild(b);
      });

      pad.appendChild(line);
    });
  }

  function handleNumpad(v){
    let input = $('answer');

    if(typeof v === "number"){
      input.value += v;
    }
    else if(v === "Eff"){
      input.value = input.value.slice(0,-1);
    }
    else if(v === "OK"){
      submitAnswer();
    }
  }
  // --------------------------------------------------
  // G√âN√âRATION DES QUESTIONS
  // --------------------------------------------------
  function nextQuestion(){
    state.questionCount++;

    if(state.questionCount > state.numQuestions){
      finishGame();
      return;
    }

    let a,b,rep,quest;

    // Tables perso pour multiplication
    if(state.operation==="multiply" && state.selectedTables.length>0){
      a = state.selectedTables[randInt(0,state.selectedTables.length-1)];
      b = randInt(0,12);
      rep = a*b;
      quest = `${a} √ó ${b}`;
    } else {
      let [min,max] = getRangeFromLevel(state.level);
      a = randInt(min,max);
      b = randInt(min,max);

      switch(state.operation){
        case "add":      
          rep = a + b; 
          quest = `${a} + ${b}`; 
          break;

        case "subtract": 
          if(b > a) [a,b] = [b,a];
          rep = a - b; 
          quest = `${a} ‚àí ${b}`; 
          break;

        case "multiply": 
          rep = a * b; 
          quest = `${a} √ó ${b}`; 
          break;

        case "divide":   
          rep = a; 
          quest = `${a*b} √∑ ${b}`; 
          break;
      }
    }

    state.correctAnswer = rep;

    // Mode VRAI / FAUX
    if(state.mode==="vrai_faux"){
      let shown = rep + (Math.random()<0.5 ? 0 : randInt(1,5));
      state.vraiFauxIsTrue = (shown === rep);
      quest += " = " + shown;
    }

    // Mode ERREUR
    if(state.mode==="erreur"){
      let wrong = Math.random() < 0.5;
      let shown = wrong ? rep + randInt(1,3) : rep;
      state.erreurQuestion = wrong;
      quest += " = " + shown;
    }

    state.currentQuestion = quest;
    $('question').textContent = quest;
    $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;
    $('answer').value = "";

    if(state.mode!=="vrai_faux" && state.mode!=="erreur"){
      $('answer').focus();
    }

    createNumpad();
  }

  // --------------------------------------------------
  // VALIDATION
  // --------------------------------------------------
  function submitAnswer(){
    let ans = $('answer').value.trim().toLowerCase();
    let ok = false;

    if(state.mode==="multiplication" || state.mode==="chrono"){
      ok = (parseInt(ans) === state.correctAnswer);
    }

    if(state.mode==="vrai_faux"){
      ok = (/^(vrai|1)$/i.test(ans) === state.vraiFauxIsTrue);
    }

    if(state.mode==="erreur"){
      let juste = /^(juste)$/i.test(ans);
      let faux  = /^(faux)$/i.test(ans);
      ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
    }

    // Affichage ‚úîÔ∏è / ‚ùå
    if(ok){
      $('question').textContent = "‚úîÔ∏è Bonne r√©ponse !";
    } else {
      $('question').textContent = `‚ùå Faux ‚Äî R√©ponse : ${state.correctAnswer}`;
    }

    if(ok) state.correctCount++;

    setTimeout(nextQuestion, 1300);
  }

  // --------------------------------------------------
  // LANCEMENT DU JEU
  // --------------------------------------------------
  $('btn-play').onclick = ()=>{
    state.prenom = $('prenom').value.trim();
    state.classe = $('classe').value.trim();

    if(!state.prenom || !state.classe){
      alert("Merci d‚Äôentrer pr√©nom + classe");
      return;
    }

    state.questionCount = 0;
    state.correctCount  = 0;
    state.gameStarted   = (state.mode !== "chrono");
    state.chronoTime    = 0;
    $('chronoLine').textContent = "";

    $('start').classList.add('hidden');
    $('welcome').classList.add('hidden');
    $('result').classList.add('hidden');
    $('game').classList.remove('hidden');

    // On supprime un √©ventuel bouton pr√©c√©dent
    const oldBtn = document.getElementById('startGameBtn');
    if(oldBtn) oldBtn.remove();

    if(state.mode === "chrono"){

      $('question').textContent = "Clique sur ‚ñ∂Ô∏è D√©marrer l‚Äôexercice";
      $('progress').textContent = `0/${state.numQuestions}`;
      $('answer').value = "";
      $('answer').style.visibility = 'visible';

      createNumpad();

      let btn = document.createElement("button");
      btn.id = "startGameBtn";
      btn.textContent = "‚ñ∂Ô∏è D√©marrer l‚Äôexercice";
      btn.className = "button";
      btn.style.marginTop = "20px";

      btn.onclick = ()=>{
        state.gameStarted = true;
        btn.remove();
        state.chronoStart = Date.now();
        startChrono();
        nextQuestion();
      };

      $('game').appendChild(btn);

    } else {
      nextQuestion();
    }
  };

  // --------------------------------------------------
  // CHRONO
  // --------------------------------------------------
  function startChrono(){
    if(state.chronoInterval) clearInterval(state.chronoInterval);

    state.chronoInterval = setInterval(()=>{
      let sec = Math.floor((Date.now() - state.chronoStart)/1000);
      state.chronoTime = sec;
      $('chronoLine').textContent = "‚è± " + sec + " sec";
    }, 300);
  }

  function stopChrono(){
    if(state.chronoInterval){
      clearInterval(state.chronoInterval);
      state.chronoInterval = null;
    }
  }

  // --------------------------------------------------
  // FIN DE PARTIE
  // --------------------------------------------------
  function finishGame(){
    stopChrono();

    $('game').classList.add('hidden');
    $('result').classList.remove('hidden');

    $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

    if(state.mode==="chrono"){
      $('bestTimeText').textContent = `‚è± Temps : ${state.chronoTime}s`;
    } else {
      $('bestTimeText').textContent = "";
    }

    let qrData = {
      prenom: state.prenom,
      classe: state.classe,
      mode: state.mode,
      resultat: `${state.correctCount}/${state.numQuestions}`,
      temps: state.mode==="chrono" ? state.chronoTime : undefined
    };

    new QRious({
      element: $('qr'),
      size: 260,
      value: JSON.stringify(qrData)
    });
  }

  // --------------------------------------------------
  // REJOUER
  // --------------------------------------------------
  $('restart').onclick = ()=>{
    location.reload();
  };
</script>

</body>
</html>
