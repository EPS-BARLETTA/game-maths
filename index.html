<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DÃ©fi MathÃ©matiques - ScanProf</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #111; 
      color: #fff; 
      margin: 0; 
      padding: 0; 
      min-height: 100vh; 
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* CONTENEUR GLOBAL (au centre de l'Ã©cran) */
    .wrap {
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    /* CADRE "carte iPad" */
    .card {
      width: 100%;
      max-width: 420px;
      padding: 35px 25px;
      border-radius: 22px;
      background: linear-gradient(145deg, #3a3a3a, #2b2b2b);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
      text-align: center;
    }

    h1 { font-size: 2em; margin-bottom: 20px; }

    /* INPUTS */
    input[type="text"] {
      padding: 12px;
      border-radius: 10px;
      border: none;
      width: 80%;
      background: #222;
      color: #fff;
      font-size: 1.2em;
      margin-bottom: 12px;
      text-align: center;
    }

    /* BOUTONS GÃ‰NÃ‰RAUX */
    button {
      padding: 12px 24px;
      font-size: 1.1em;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      margin: 5px;
      transition: 0.2s;
    }

    .main-btn {
      background: #fff;
      color: #222;
      font-weight: bold;
      width: 80%;
    }

    /* CHAMP QUESTION */
    #question {
      font-size: 2.2em;
      margin-bottom: 20px;
      min-height: 40px;
    }

    /* NUMPAD */
    #numpad {
      margin-top: 15px;
    }
    #numpad-row {
      display: flex;
      justify-content: center;
    }
    #numpad-row button {
      width: 60px;
      height: 55px;
      font-size: 1.3em;
      background: #444;
      color: #fff;
      margin: 4px;
      border-radius: 10px;
    }
    .numpad-eff { background: #aaa !important; color: #222 !important; }
    .numpad-ok { background: #4CAF50 !important; color: #fff !important; }

    /* VRAI/FAUX */
    .numpad-vrai {
      background: #2ecc71;
      width: 48%;
      height: 55px;
      border-radius: 12px;
      font-size: 1.3em;
    }
    .numpad-faux {
      background: #e74c3c;
      width: 48%;
      height: 55px;
      border-radius: 12px;
      font-size: 1.3em;
    }

    /* MESSAGE CORRECTION */
    #feedback {
      font-size: 1.8em;
      margin-top: 15px;
      min-height: 40px;
    }

    /* CHRONO TEXTE */
    #chronoLine {
      margin-top: 8px;
      font-size: 1.1em;
      opacity: 0.9;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body>

<div class="wrap">
  <div class="card">

    <!-- PAGE DE GARDE -->
    <div id="welcome">
      <h1>ðŸ§® DÃ©fi MathÃ©matiques</h1>
      <button id="startApp" class="main-btn">DÃ©marrer</button>
    </div>

    <!-- MENU -->
    <div id="start" class="hidden">
      <p>PrÃ©nom :</p>
      <input id="prenom" type="text" maxlength="18">

      <p>Classe :</p>
      <input id="classe" type="text" maxlength="18">

      <p>Type d'opÃ©ration :</p>
      <div id="op-choose"></div>

      <div id="tables-choose" class="hidden"></div>

      <p>Niveau :</p>
      <div id="level-choose"></div>

      <p>Nombre de questions :</p>
      <div id="questions-choose"></div>

      <h3>Mode :</h3>
      <div id="mode-choose"></div>

      <div id="chronoPickerContainer" class="hidden">
        <button id="launchChrono" class="main-btn hidden">DÃ©marrer lâ€™exercice</button>
      </div>

      <button id="btn-play" class="main-btn">Valider et jouer</button>
    </div>

    <!-- JEU -->
    <div id="game" class="hidden">
      <div id="question"></div>
      <input id="answer" autocomplete="off">

      <div id="feedback"></div>

      <div id="numpad"></div>

      <p id="progress"></p>
      <p id="chronoLine"></p>
    </div>

    <!-- RÃ‰SULTATS -->
    <div id="result" class="hidden">
      <h2>RÃ©sultat</h2>
      <p id="scoreText"></p>
      <p id="bestTimeText"></p>
      <canvas id="qr"></canvas>
      <button id="restart" class="main-btn">Rejouer</button>
    </div>

  </div>
</div>

<!-- ðŸ”½ ICI TU COLLES LE BLOC 2 DIRECTEMENT EN DESSOUS ðŸ”½ -->
<script>
// --------------------------------------------------
// Ã‰TAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: 'multiply',
  level: 1,
  numQuestions: 10,
  prenom: '',
  classe: '',
  questionCount: 0,
  correctCount: 0,
  currentQuestion: '',
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  chronoDuration: 60, // DURÃ‰E PAR DÃ‰FAUT
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: [],
  chronoActive: false
};

const $ = id => document.getElementById(id);

// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$('startApp').onclick = () => {
  $('welcome').classList.add('hidden');
  $('start').classList.remove('hidden');
};

// --------------------------------------------------
// OPÃ‰RATIONS
// --------------------------------------------------
const ops = [
  {op:"multiply", label:"Ã— Multiplication"},
  {op:"add", label:"+ Addition"},
  {op:"subtract", label:"âˆ’ Soustraction"},
  {op:"divide", label:"Ã· Division"}
];

ops.forEach(o=>{
  let b=document.createElement("button");
  b.className="operation-btn";
  b.dataset.op=o.op;
  b.textContent=o.label;

  b.onclick=()=>{
    state.operation=o.op;

    document.querySelectorAll('.operation-btn').forEach(x=>{
      x.classList.remove('op-selected');
    });
    b.classList.add('op-selected');

    $('tables-choose').classList.toggle('hidden', o.op!=="multiply");

    if (o.op !== "multiply") {
      state.selectedTables = [];
      document.querySelectorAll(".table-btn").forEach(t=>t.classList.remove("table-selected"));
    }
  };

  $('op-choose').appendChild(b);
});
document.querySelector('.operation-btn[data-op="multiply"]').classList.add('op-selected');

// --------------------------------------------------
// TABLES PERSONNALISÃ‰ES
// --------------------------------------------------
let htmlTables = "";
for(let i=1;i<=12;i++){
  htmlTables += `<button class="table-btn" data-table="${i}">${i}</button>`;
}
$('tables-choose').innerHTML = "<h3>Tables personnalisÃ©es :</h3>" + htmlTables;

document.querySelectorAll(".table-btn").forEach(btn=>{
  btn.onclick=()=>{
    let val = parseInt(btn.dataset.table);
    if(state.selectedTables.includes(val)){
      state.selectedTables = state.selectedTables.filter(x=>x!==val);
      btn.classList.remove("table-selected");
    } else {
      state.selectedTables.push(val);
      btn.classList.add("table-selected");
    }
  };
});

// --------------------------------------------------
// NIVEAUX
// --------------------------------------------------
[1,2,3].forEach(l=>{
  let b=document.createElement("button");
  b.className="level-btn";
  b.dataset.level=l;
  b.textContent="Niveau "+l;

  b.onclick=()=>{
    state.level=l;
    document.querySelectorAll('.level-btn').forEach(x=>x.classList.remove('level-selected'));
    b.classList.add('level-selected');
  };

  $('level-choose').appendChild(b);
});
document.querySelector('.level-btn[data-level="1"]').classList.add('level-selected');

// --------------------------------------------------
// NOMBRE DE QUESTIONS
// --------------------------------------------------
[10,15,20].forEach(q=>{
  let b=document.createElement("button");
  b.className="questions-btn";
  b.dataset.q=q;
  b.textContent=q;

  b.onclick=()=>{
    state.numQuestions=q;
    document.querySelectorAll('.questions-btn').forEach(x=>x.classList.remove('questions-selected'));
    b.classList.add('questions-selected');
  };

  $('questions-choose').appendChild(b);
});
document.querySelector('.questions-btn[data-q="10"]').classList.add('questions-selected');

// --------------------------------------------------
// MODES
// --------------------------------------------------
const modes = [
  {m:"multiplication", label:"Classique"},
  {m:"chrono", label:"Chrono"},
  {m:"vrai_faux", label:"Vrai/Faux"},
  {m:"erreur", label:"Erreur"}
];

modes.forEach(o=>{
  let b=document.createElement("button");
  b.className="mode-btn";
  b.dataset.mode=o.m;
  b.textContent=o.label;

  b.onclick=()=>{
    state.mode=o.m;

    document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('mode-selected'));
    b.classList.add('mode-selected');

    $('chronoPickerContainer').classList.toggle('hidden', o.m!=="chrono");
    $('launchChrono').classList.add('hidden');
  };

  $('mode-choose').appendChild(b);
});
document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add('mode-selected');

// --------------------------------------------------
// CHOIX TEMPS â€“ LISTE SIMPLE
// --------------------------------------------------
let selector = document.createElement("select");
selector.style.fontSize = "1.1em";
selector.style.padding = "6px";
selector.style.borderRadius = "8px";

for (let t=10; t<=120; t+=10){
  let opt = document.createElement("option");
  opt.value = t;
  opt.textContent = t + " sec";
  selector.appendChild(opt);
}

selector.onchange = () => {
  state.chronoDuration = parseInt(selector.value);
  $('launchChrono').classList.remove('hidden');
};

$('chronoPickerContainer').appendChild(selector);

// --------------------------------------------------
// BOUTON "DÃ©marrer exercice" (mode chrono)
// --------------------------------------------------
$('launchChrono').onclick = () => {
  $('start').classList.add('hidden');
  $('result').classList.add('hidden');
  $('game').classList.remove('hidden');

  state.chronoActive = true;
  startChrono();

  nextQuestion();
};

// --------------------------------------------------
// BOUTON LANCER JEU (hors mode chrono)
// --------------------------------------------------
$('btn-play').onclick = () => {

  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if (!state.prenom || !state.classe) {
    alert("Merci dâ€™entrer un prÃ©nom et une classe.");
    return;
  }

  if(state.mode==="chrono"){
    alert("SÃ©lectionne une durÃ©e et clique sur 'DÃ©marrer lâ€™exercice'.");
    return;
  }

  $('start').classList.add('hidden');
  $('result').classList.add('hidden');
  $('game').classList.remove('hidden');

  state.chronoActive = false;

  nextQuestion();
};

// --------------------------------------------------
// CHRONO SIMPLE (texte uniquement)
// --------------------------------------------------
let chronoInterval = null;

function startChrono(){
  state.chronoStart = Date.now();

  if(chronoInterval) clearInterval(chronoInterval);

  chronoInterval = setInterval(()=>{
    let elapsed = Math.floor((Date.now() - state.chronoStart) / 1000);
    state.chronoTime = elapsed;
    $('chronoLine').textContent = "â± " + elapsed + " sec";
  }, 200);
}

function stopChrono(){
  if(chronoInterval) clearInterval(chronoInterval);
}

// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createPad(){
  const pad = $('numpad');
  pad.innerHTML = "";

  if(state.mode==="vrai_faux"){
    return createVF("vrai","faux");
  }

  if(state.mode==="erreur"){
    return createVF("juste","faux");
  }

  const rows = [
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ['Eff',0,'OK']
  ];

  rows.forEach(r=>{
    let line=document.createElement("div");
    line.id="numpad-row";

    r.forEach(v=>{
      let b=document.createElement("button");
      b.textContent=v;

      if(v==="Eff") b.className="numpad-eff";
      if(v==="OK") b.className="numpad-ok";

      b.onclick = ()=> handleNumpad(v);
      line.appendChild(b);
    });

    pad.appendChild(line);
  });
}

function createVF(txt1, txt2){
  const pad = $('numpad');
  pad.innerHTML = "";

  let b1=document.createElement("button");
  b1.className="numpad-vrai";
  b1.textContent=txt1;
  b1.onclick=()=>{ $('answer').value=txt1; submitAnswer(); };

  let b2=document.createElement("button");
  b2.className="numpad-faux";
  b2.textContent=txt2;
  b2.onclick=()=>{ $('answer').value=txt2; submitAnswer(); };

  pad.appendChild(b1);
  pad.appendChild(b2);
}

function handleNumpad(v){
  let input = $('answer');

  if(typeof v === "number"){
    input.value += v;
  }
  else if(v === "Eff"){
    input.value = input.value.slice(0,-1);
  }
  else if(v === "OK"){
    submitAnswer();
  }
}

// --------------------------------------------------
// GÃ‰NÃ‰RATION DES QUESTIONS
// --------------------------------------------------
function nextQuestion(){

  $('feedback').textContent = "";

  state.questionCount++;
  if(state.questionCount > state.numQuestions){
    return finishGame();
  }

  let a,b,rep,quest;

  // Tables perso
  if(state.operation==="multiply" && state.selectedTables.length>0){
    a = state.selectedTables[randInt(0, state.selectedTables.length-1)];
    b = randInt(0,12);
    rep = a*b;
    quest = `${a} Ã— ${b}`;
  }
  else {
    let [min,max] = getRangeFromLevel(state.level);

    a = randInt(min,max);
    b = randInt(min,max);

    switch(state.operation){
      case "add": rep=a+b; quest=`${a} + ${b}`; break;
      case "subtract": if(b>a)[a,b]=[b,a]; rep=a-b; quest=`${a} âˆ’ ${b}`; break;
      case "multiply": rep=a*b; quest=`${a} Ã— ${b}`; break;
      case "divide": rep=a; quest=`${a*b} Ã· ${b}`; break;
    }
  }

  // Mode vrai/faux ?
  if(state.mode==="vrai_faux"){
    let shown = rep + (Math.random()<0.5 ? 0 : randInt(1,5));
    state.vraiFauxIsTrue = (shown === rep);
    quest += " = " + shown;
  }

  // Mode erreur ?
  if(state.mode==="erreur"){
    let wrong = Math.random() < 0.5;
    let shown = wrong ? rep + randInt(1,3) : rep;
    state.erreurQuestion = wrong;
    quest += " = " + shown;
  }

  state.currentQuestion = quest;
  state.correctAnswer = rep;

  $('question').textContent = quest;
  $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;
  $('answer').value = "";
  $('answer').focus();

  createPad();
}

// --------------------------------------------------
// VALIDATION RÃ‰PONSE
// --------------------------------------------------
function submitAnswer(){
  let ans = $('answer').value.trim().toLowerCase();
  let ok = false;

  if(state.mode==="multiplication" || state.mode==="chrono"){
    ok = (parseInt(ans) === state.correctAnswer);
  }

  if(state.mode==="vrai_faux"){
    ok = (/^(vrai|true|1)$/i.test(ans) === state.vraiFauxIsTrue);
  }

  if(state.mode==="erreur"){
    let juste = /^(juste|true|1)$/i.test(ans);
    let faux  = /^(faux|false|0)$/i.test(ans);
    ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
  }

  // Afficher feedback pendant 1.5 sec
  if(ok){
    $('feedback').textContent = "âœ… Bravo !";
  } else {
    $('feedback').innerHTML = `âŒ Faux<br>RÃ©ponse attendue : ${state.correctAnswer}`;
  }

  setTimeout(()=>{
    nextQuestion();
  },1500);

  if(ok) state.correctCount++;
}

// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){

  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  if(state.mode==="chrono"){
    stopChrono();
    state.bestTime = state.bestTime === null ? state.chronoTime : Math.min(state.bestTime, state.chronoTime);
    localStorage.setItem("bestTime", state.bestTime);
  }

  $('scoreText').textContent = `${state.correctCount}/${state.numQuestions}`;

  if(state.mode==="chrono"){
    $('bestTimeText').textContent = `â± Temps : ${state.chronoTime}s â€” Record : ${state.bestTime}s`;
  } else {
    $('bestTimeText').textContent = "";
  }

  // QR Code organisÃ© et propre
  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    mode: state.mode,
    resultat: `${state.correctCount}/${state.numQuestions}`
  };

  if(state.mode==="chrono"){
    qrData.temps = state.chronoTime;
  }

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}

// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$('restart').onclick = ()=>{
  $('result').classList.add('hidden');
  $('start').classList.remove('hidden');
};

// --------------------------------------------------
// UTILITAIRE
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

</script>
