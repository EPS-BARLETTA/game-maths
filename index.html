<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DÃ©fi MathÃ©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    body { 
      font-family: Arial, sans-serif; 
      background: #1e1e1e; 
      color: #fff; 
      margin: 0; 
      padding: 30px; 
      min-height: 100vh; 
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* CONTAINER PRINCIPAL â€” PLUS GRAND POUR TABLETTE */
    .container { 
      width: 100%;
      max-width: 650px;     /* Ã©largi */
      background: #2b2b2b;
      border-radius: 20px;
      padding: 30px 25px;
      box-shadow: 0 6px 20px #0008;
      text-align: center;
      transform: scale(1.05);   /* lÃ©ger zoom */
    }

    /* TITRE */
    #welcome h1 {
      font-size: 2.6rem;   /* plus grand */
      margin-bottom: 25px;
    }

    #startApp {
      font-size: 1.6rem;
      padding: 14px 40px;
      background: #fff;
      color: #000;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }

    /* BOUTONS +++ PLUS GRANDS POUR TABLETTE */
    button.button,
    .operation-btn,
    .level-btn,
    .mode-btn,
    .questions-btn,
    .table-btn {
      padding: 14px 26px;
      font-size: 1.4rem;
      margin: 10px;
      border-radius: 12px;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 6px #0006;
    }

    /* COULEURS opÃ©ration â€” texte NOIR car fond clair */
    .operation-btn[data-op="multiply"] { background: #ffd28a; color:#000; }
    .operation-btn[data-op="add"] { background: #a8d1ff; color:#000; }
    .operation-btn[data-op="subtract"] { background: #e3b3ff; color:#000; }
    .operation-btn[data-op="divide"] { background: #ff9b9b; color:#000; }
    .op-selected { filter: brightness(0.85); border: 3px solid #fff; }

    /* INPUT PLUS GRAND & VISIBLE */
    #answer {
      width: 80%;
      font-size: 2rem;
      margin-top: 10px;
      padding: 14px;
      border-radius: 12px;
      border: 2px solid #555;
      background: #111;
      color: #fff;
      text-align: center;
    }

    /* QUESTION â€” PLUS GRANDE */
    #question {
      font-size: 3rem;
      margin: 25px 0;
      min-height: 70px;
    }

    /* NUMPAD â€” VERSION AGRANDIE TABLETTE */
    #numpad {
      margin-top: 20px;
    }

    #numpad button {
      width: 90px;           /* plus large */
      height: 90px;          /* plus haut */
      margin: 8px;
      font-size: 2rem;       /* plus lisible */
      border-radius: 16px;   /* arrondi premium */
      background: #444;
      color: #fff;
      border: none;
    }

    .numpad-eff { background:#bbbbbb !important; color:#222 !important; }
    .numpad-ok { background:#4CAF50 !important; color:#fff !important; }

    /* VRAI / FAUX â€” encore plus grands */
    .numpad-vrai, .numpad-faux {
      width: 46%;
      height: 90px;
      font-size: 2rem;
      border-radius: 16px;
    }

    .numpad-vrai { background: #6ac200; }
    .numpad-faux { background: #e94444; }

    /* BARRE CHRONO (en bas, simple) */
    #chronoLine {
      font-size: 1.6rem;
      margin-top: 10px;
    }

    /* PAGE RÃ‰SULTATS */
    #scoreText {
      font-size: 2.2rem;
      margin-bottom: 10px;
    }

    #bestTimeText {
      font-size: 1.4rem;
      opacity: 0.8;
    }

    #result canvas {
      margin: 25px auto;
      display: block;
    }

    .hidden { display: none !important; }
  </style>
</head>

<body>

<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>ðŸŽ® DÃ©fi MathÃ©matiques</h1>
    <button id="startApp">DÃ©marrer</button>
  </div>

  <!-- PAGE DE SÃ‰LECTION -->
  <div id="start" class="hidden">

    <p>PrÃ©nom : <input id="prenom" type="text" maxlength="18"></p>
    <p>Classe : <input id="classe" type="text" maxlength="18"></p>

    <h2>Type d'opÃ©ration</h2>
    <div id="op-choose"></div>

    <div id="tables-choose" class="hidden"></div>

    <h2>Niveau</h2>
    <div id="level-choose"></div>

    <h2>Nombre de questions</h2>
    <div id="questions-choose"></div>

    <h2>Mode</h2>
    <div id="mode-choose"></div>

    <button id="btn-play" class="button">Valider</button>
  </div>

  <!-- PAGE DE JEU -->
  <div id="game" class="hidden">
    <div id="question"></div>

    <!-- Zone de saisie visible sauf vrai/faux -->
    <input id="answer" type="text" autocomplete="off">

    <!-- PavÃ© numÃ©rique -->
    <div id="numpad"></div>

    <!-- chrono simple -->
    <div id="chronoLine"></div>

    <!-- progression -->
    <p id="progress"></p>
  </div>

  <!-- PAGE RÃ‰SULTATS -->
  <div id="result" class="hidden">
    <h2>RÃ©sultat</h2>
    <p id="scoreText"></p>
    <p id="bestTimeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>

<!-- PLACE ICI LE BLOC 3 -->
<script>
// --------------------------------------------------
// Ã‰TAT GLOBAL
// --------------------------------------------------
let state = {
  mode: null,
  operation: 'multiply',
  level: 1,
  numQuestions: 10,
  prenom: '',
  classe: '',
  questionCount: 0,
  correctCount: 0,
  currentQuestion: '',
  correctAnswer: null,
  chronoStart: 0,
  chronoTime: 0,
  bestTime: localStorage.getItem("bestTime") ?? null,
  vraiFauxIsTrue: false,
  erreurQuestion: false,
  selectedTables: []
};

const $ = id => document.getElementById(id);


// --------------------------------------------------
// PAGE DE GARDE
// --------------------------------------------------
$('startApp').onclick = () => {
  $('welcome').classList.add('hidden');
  $('start').classList.remove('hidden');
};


// --------------------------------------------------
// BOUTONS OPÃ‰RATION
// --------------------------------------------------
const ops = [
  {op:"multiply", label:"Ã— Multiplication"},
  {op:"add", label:"+ Addition"},
  {op:"subtract", label:"âˆ’ Soustraction"},
  {op:"divide", label:"Ã· Division"}
];

ops.forEach(o=>{
  let b=document.createElement("button");
  b.className="operation-btn";
  b.dataset.op=o.op;
  b.textContent=o.label;
  
  b.onclick=()=>{
    state.operation=o.op;
    document.querySelectorAll('.operation-btn').forEach(x=>x.classList.remove('op-selected'));
    b.classList.add('op-selected');

    $('tables-choose').classList.toggle('hidden', o.op!=="multiply");

    if(o.op!=="multiply"){
      state.selectedTables=[];
      document.querySelectorAll(".table-btn").forEach(t=>t.classList.remove("table-selected"));
    }
  };

  $('op-choose').appendChild(b);
});
document.querySelector('.operation-btn[data-op="multiply"]').classList.add('op-selected');


// --------------------------------------------------
// TABLES DE MULTIPLICATION PERSONNALISÃ‰ES
// --------------------------------------------------
let htmlTables="";
for(let i=1;i<=12;i++){
  htmlTables += `<button class="table-btn" data-table="${i}">${i}</button>`;
}
$('tables-choose').innerHTML = "<h3>Tables personnalisÃ©es :</h3>" + htmlTables;

document.querySelectorAll(".table-btn").forEach(btn=>{
  btn.onclick=()=>{
    const val=parseInt(btn.dataset.table);

    if(state.selectedTables.includes(val)){
      state.selectedTables = state.selectedTables.filter(x=>x!==val);
      btn.classList.remove("table-selected");
    } else {
      state.selectedTables.push(val);
      btn.classList.add("table-selected");
    }
  };
});


// --------------------------------------------------
// NIVEAUX
// --------------------------------------------------
[1,2,3].forEach(n=>{
  let b=document.createElement("button");
  b.className="level-btn";
  b.dataset.level=n;
  b.textContent="Niveau "+n;

  b.onclick=()=>{
    state.level=n;
    document.querySelectorAll('.level-btn').forEach(x=>x.classList.remove('level-selected'));
    b.classList.add('level-selected');
  };

  $('level-choose').appendChild(b);
});
document.querySelector('.level-btn[data-level="1"]').classList.add('level-selected');


// --------------------------------------------------
// QUESTIONS (10,15,20,25,30)
// --------------------------------------------------
[10,15,20,25,30].forEach(q=>{
  let b=document.createElement("button");
  b.className="questions-btn";
  b.dataset.q=q;
  b.textContent=q;

  b.onclick=()=>{
    state.numQuestions=q;
    document.querySelectorAll('.questions-btn').forEach(x=>x.classList.remove('questions-selected'));
    b.classList.add('questions-selected');
  };

  $('questions-choose').appendChild(b);
});
document.querySelector('.questions-btn[data-q="10"]').classList.add('questions-selected');


// --------------------------------------------------
// MODES
// --------------------------------------------------
const modes = [
  {m:"multiplication", label:"Classique"},
  {m:"chrono", label:"Chrono"},
  {m:"vrai_faux", label:"Vrai / Faux"},
  {m:"erreur", label:"Erreur"}
];

modes.forEach(md=>{
  let b=document.createElement("button");
  b.className="mode-btn";
  b.dataset.mode=md.m;
  b.textContent=md.label;

  b.onclick=()=>{
    state.mode=md.m;
    document.querySelectorAll('.mode-btn').forEach(x=>x.classList.remove('mode-selected'));
    b.classList.add('mode-selected');
  };

  $('mode-choose').appendChild(b);
});
document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add('mode-selected');


// --------------------------------------------------
// LANCER LE JEU
// --------------------------------------------------
$('btn-play').onclick = () => {

  state.prenom = $('prenom').value.trim();
  state.classe = $('classe').value.trim();

  if(!state.prenom || !state.classe){
    alert("Merci dâ€™entrer un prÃ©nom et une classe.");
    return;
  }

  state.questionCount = 0;
  state.correctCount = 0;

  $('start').classList.add('hidden');
  $('game').classList.remove('hidden');

  // MODE CHRONO â†’ le chrono commence au premier clic OK
  state.chronoStart = 0;

  nextQuestion();
};


// --------------------------------------------------
// CHRONO SIMPLE
// --------------------------------------------------
let chronoInterval = null;

function startChrono(){
  state.chronoStart = Date.now();

  chronoInterval = setInterval(()=>{
    let t = Math.floor((Date.now() - state.chronoStart)/1000);
    $('chronoLine').textContent = "â± " + t + " sec";
  }, 200);
}

function stopChrono(){
  if(chronoInterval) clearInterval(chronoInterval);
  state.chronoTime = Math.floor((Date.now() - state.chronoStart)/1000);
}


// --------------------------------------------------
// NUMPAD
// --------------------------------------------------
function createPad(){
  const pad=$('numpad');
  pad.innerHTML="";

  // vrai / faux
  if(state.mode==="vrai_faux"){
    return createVF("vrai", "faux");
  }
  if(state.mode==="erreur"){
    return createVF("juste", "faux");
  }

  const rows=[
    [1,2,3],
    [4,5,6],
    [7,8,9],
    ["Eff",0,"OK"]
  ];

  rows.forEach(r=>{
    let line=document.createElement("div");
    line.id="numpad-row";

    r.forEach(v=>{
      let b=document.createElement("button");
      b.textContent=v;

      if(v==="Eff") b.className="numpad-eff";
      if(v==="OK") b.className="numpad-ok";

      b.onclick=()=>handleNumpad(v);
      line.appendChild(b);
    });

    pad.appendChild(line);
  });
}

function createVF(a,b){
  const pad=$('numpad');
  pad.innerHTML="";

  let b1=document.createElement("button");
  b1.className="numpad-vrai";
  b1.textContent=a;
  b1.onclick=()=>{ $('answer').value=a; submitAnswer(); };

  let b2=document.createElement("button");
  b2.className="numpad-faux";
  b2.textContent=b;
  b2.onclick=()=>{ $('answer').value=b; submitAnswer(); };

  pad.appendChild(b1);
  pad.appendChild(b2);
}

function handleNumpad(v){
  let input = $('answer');

  if(typeof v==="number"){
    input.value += v;
  }
  else if(v==="Eff"){
    input.value = input.value.slice(0,-1);
  }
  else if(v==="OK"){
    submitAnswer();
  }
}


// --------------------------------------------------
// GÃ‰NÃ‰RATION DES QUESTIONS
// --------------------------------------------------
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

function getRange(level){
  if(level===1) return [1,9];
  if(level===2) return [10,20];
  return [10,99];
}

function nextQuestion(){

  state.questionCount++;

  // fin du jeu
  if(state.questionCount > state.numQuestions){
    return finishGame();
  }

  let a,b,rep,q;

  // tables perso
  if(state.operation==="multiply" && state.selectedTables.length>0){
    a = state.selectedTables[randInt(0,state.selectedTables.length-1)];
    b = randInt(0,12);
    rep = a*b;
    q = `${a} Ã— ${b}`;
  }
  else{
    let [min,max] = getRange(state.level);
    a = randInt(min,max);
    b = randInt(min,max);

    switch(state.operation){
      case "add": rep=a+b; q=`${a} + ${b}`; break;
      case "subtract": if(b>a)[a,b]=[b,a]; rep=a-b; q=`${a} âˆ’ ${b}`; break;
      case "multiply": rep=a*b; q=`${a} Ã— ${b}`; break;
      case "divide": rep=a; q=`${a*b} Ã· ${b}`; break;
    }
  }

  // modes spÃ©ciaux
  if(state.mode==="vrai_faux"){
    let shown = rep + (Math.random()<0.5 ? 0 : randInt(1,5));
    state.vraiFauxIsTrue = (shown===rep);
    q += " = " + shown;
  }

  if(state.mode==="erreur"){
    let wrong = Math.random()<0.5;
    let shown = wrong ? rep + randInt(1,3) : rep;
    state.erreurQuestion = wrong;
    q += " = " + shown;
  }

  state.currentQuestion=q;
  state.correctAnswer=rep;

  $('question').textContent=q;
  $('progress').textContent=`${state.questionCount}/${state.numQuestions}`;
  $('answer').value="";
  $('answer').style.display = (state.mode==="vrai_faux" || state.mode==="erreur") ? "none" : "block";

  createPad();
}


// --------------------------------------------------
// VALIDATION
// --------------------------------------------------
function submitAnswer(){
  let ans = $('answer').value.trim().toLowerCase();

  // START chrono au moment du premier clic OK
  if(state.mode==="chrono" && state.chronoStart===0){
    startChrono();
  }

  let ok = false;

  if(state.mode==="multiplication" || state.mode==="chrono"){
    ok = (parseInt(ans) === state.correctAnswer);
  }

  if(state.mode==="vrai_faux"){
    ok = (/^(vrai|true|1)$/i.test(ans) === state.vraiFauxIsTrue);
  }

  if(state.mode==="erreur"){
    let juste = /^(juste|true|1)$/i.test(ans);
    let faux  = /^(faux|false|0)$/i.test(ans);
    ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
  }

  // feedback
  if(ok){
    $('question').innerHTML = "âœ… Bonne rÃ©ponse !";
  } else {
    $('question').innerHTML = "âŒ Faux â€” rÃ©ponse attendue : <b>"+state.correctAnswer+"</b>";
  }

  // attendre 1.3 sec avant question suivante
  setTimeout(()=>{
    nextQuestion();
  }, 1300);

  if(ok) state.correctCount++;
}


// --------------------------------------------------
// FIN DE PARTIE
// --------------------------------------------------
function finishGame(){

  if(state.mode==="chrono"){
    stopChrono();
  }

  $('game').classList.add('hidden');
  $('result').classList.remove('hidden');

  $('scoreText').textContent=`${state.correctCount}/${state.numQuestions}`;

  if(state.mode==="chrono"){
    $('bestTimeText').textContent = "â± Temps : "+state.chronoTime+" sec";
  } else {
    $('bestTimeText').textContent = "";
  }

  // QR CODE
  let qrData = {
    prenom: state.prenom,
    classe: state.classe,
    mode: state.mode,
    resultat: `${state.correctCount}/${state.numQuestions}`
  };

  if(state.mode==="chrono"){
    qrData.temps = state.chronoTime;
  }

  new QRious({
    element: $('qr'),
    size: 260,
    value: JSON.stringify(qrData)
  });
}


// --------------------------------------------------
// REJOUER
// --------------------------------------------------
$('restart').onclick = ()=>{
  $('result').classList.add('hidden');
  $('start').classList.remove('hidden');
};
</script>
