<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>DÃ©fi MathÃ©matiques - ScanProf</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Librairie QRCode -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js" defer></script>

  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 16px;
      background: radial-gradient(circle at top, #1e293b 0%, #020617 55%, #000 100%);
      color: #e5e7eb;
    }

    .container {
      width: 100%;
      max-width: 460px;
      background: linear-gradient(145deg, #020617, #020817);
      border-radius: 24px;
      padding: 16px 20px 20px;
      box-shadow:
        0 18px 60px rgba(0, 0, 0, 0.7),
        0 0 0 1px rgba(148, 163, 184, 0.12);
      border: 1px solid rgba(148, 163, 184, 0.3);
    }

    h1 {
      font-size: 1.9rem;
      margin: 0 0 12px;
    }

    h2 {
      margin-top: 8px;
      margin-bottom: 12px;
    }

    h3 {
      margin: 10px 0 6px;
      font-size: 1rem;
      color: #cbd5f5;
    }

    /* PAGE DE GARDE */
    #welcome {
      min-height: 300px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 24px 8px 20px;
    }

    #welcome p {
      margin-top: 6px;
      color: #9ca3af;
      font-size: 0.9rem;
    }

    #startApp {
      margin-top: 14px;
      padding: 12px 28px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      background: linear-gradient(135deg, #f97316, #facc15);
      color: #111827;
      box-shadow: 0 10px 25px rgba(248, 181, 71, 0.5);
    }

    #startApp:active {
      transform: translateY(1px);
      box-shadow: 0 6px 18px rgba(248, 181, 71, 0.5);
    }

    /* BOUTONS GÃ‰NÃ‰RAUX */
    button {
      font-family: inherit;
    }

    .button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      background: #e5e7eb;
      color: #111827;
    }

    .button:active {
      transform: translateY(1px);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .operation-btn,
    .level-btn,
    .mode-btn,
    .questions-btn,
    .table-btn {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      font-weight: 500;
      color: #020617;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, filter 0.08s;
      box-shadow: 0 2px 6px rgba(15, 23, 42, 0.6);
      min-width: 44px;
    }

    .operation-btn[data-op="multiply"] { background: #fde68a; }
    .operation-btn[data-op="add"]       { background: #bfdbfe; }
    .operation-btn[data-op="subtract"]  { background: #fecaca; }
    .operation-btn[data-op="divide"]    { background: #ddd6fe; }

    .level-btn[data-level="1"] { background: #bbf7d0; }
    .level-btn[data-level="2"] { background: #fed7aa; }
    .level-btn[data-level="3"] { background: #e5e7eb; }

    .mode-btn[data-mode="multiplication"] { background: #a5b4fc; }
    .mode-btn[data-mode="chrono"]         { background: #7dd3fc; }
    .mode-btn[data-mode="vrai_faux"]      { background: #f9a8d4; }
    .mode-btn[data-mode="erreur"]         { background: #fed7aa; }

    .questions-btn { background: #e5e7eb; }

    .table-btn {
      background: #0f172a;
      color: #e5e7eb;
      border-radius: 999px;
      min-width: 40px;
      padding: 6px 10px;
      font-size: 0.85rem;
    }

    .pill-selected {
      filter: brightness(0.9);
      box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.8);
    }

    .table-selected {
      background: #22c55e;
      color: #022c22;
      box-shadow: 0 0 0 2px rgba(21, 128, 61, 0.9);
    }

    /* FORMULAIRE MENU */
    #start p {
      margin: 6px 0 2px;
      font-size: 0.9rem;
      text-align: left;
    }

    #start p label {
      display: inline-block;
      margin-bottom: 2px;
    }

    input[type="text"] {
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #4b5563;
      font-size: 0.95rem;
      width: 100%;
      max-width: 260px;
      background: #020617;
      color: #f9fafb;
      text-align: left;
      margin-top: 4px;
    }

    /* JEU */
    #game {
      text-align: center;
      padding: 8px 4px 4px;
    }

    #question {
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.7rem;
      margin-top: 4px;
      margin-bottom: 6px;
    }

    #feedback {
      min-height: 28px;
      font-size: 0.95rem;
      margin-bottom: 4px;
    }

    #feedback.ok {
      color: #4ade80;
    }

    #feedback.ko {
      color: #f97373;
    }

    #answer {
      margin: 6px auto 6px;
      text-align: center;
      max-width: 180px;
      background: #020617;
      color: #f9fafb;
      border: 1px solid #64748b;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 1rem;
    }

    #numpad {
      margin-top: 4px;
      margin-bottom: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }

    .numpad-row {
      display: flex;
      justify-content: center;
      gap: 4px;
    }

    #numpad button {
      min-width: 54px;
      height: 46px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-size: 1.1rem;
      background: #1f2937;
      color: #f9fafb;
      box-shadow: 0 2px 5px rgba(15, 23, 42, 0.7);
    }

    .numpad-eff {
      background: #e5e7eb !important;
      color: #111827 !important;
      font-size: 0.95rem !important;
    }

    .numpad-ok {
      background: #22c55e !important;
      color: #022c22 !important;
      font-weight: 700;
    }

    .numpad-vrai {
      width: 48%;
      max-width: 170px;
      background: #4ade80 !important;
      color: #064e3b !important;
      font-weight: 700;
      border-radius: 999px !important;
    }

    .numpad-faux {
      width: 48%;
      max-width: 170px;
      background: #f87171 !important;
      color: #7f1d1d !important;
      font-weight: 700;
      border-radius: 999px !important;
    }

    #progress,
    #chronoLine {
      margin: 2px 0;
      font-size: 0.9rem;
      color: #9ca3af;
    }

    /* RÃ‰SULTATS */
    #result {
      text-align: center;
      padding-top: 10px;
      padding-bottom: 6px;
    }

    #scoreText {
      font-size: 1.3rem;
      margin: 4px 0;
    }

    #bestTimeText {
      margin: 2px 0 10px;
      font-size: 0.95rem;
      color: #9ca3af;
    }

    #qr {
      margin: 10px auto 12px;
      background: #fff;
      border-radius: 12px;
      padding: 6px;
    }

    .hidden {
      display: none !important;
    }
  </style>
</head>

<body>
<div class="container">

  <!-- PAGE DE GARDE -->
  <div id="welcome">
    <h1>ðŸŽ® DÃ©fi MathÃ©matiques</h1>
    <p>Choisis ton dÃ©fi, joue sur lâ€™iPad, scanne le QR pour rÃ©cupÃ©rer les rÃ©sultats.</p>
    <button id="startApp">Commencer</button>
  </div>

  <!-- MENU DE CONFIGURATION -->
  <div id="start" class="hidden">

    <p><label for="prenom">PrÃ©nom :</label>
      <input id="prenom" type="text" maxlength="18">
    </p>

    <p><label for="classe">Classe :</label>
      <input id="classe" type="text" maxlength="18">
    </p>

    <h3>Type d'opÃ©ration</h3>
    <div id="op-choose" class="pill-row"></div>

    <div id="tables-choose" class="hidden">
      <h3>Tables personnalisÃ©es</h3>
      <div class="pill-row" id="tables-row"></div>
    </div>

    <h3>Niveau</h3>
    <div id="level-choose" class="pill-row"></div>

    <h3>Nombre de questions</h3>
    <div id="questions-choose" class="pill-row"></div>

    <h3>Mode</h3>
    <div id="mode-choose" class="pill-row"></div>

    <div style="margin-top:10px; text-align:center;">
      <button id="btn-play" class="button">Valider et jouer</button>
    </div>
  </div>

  <!-- JEU -->
  <form id="game" class="hidden" onsubmit="return false;">
    <div id="question"></div>
    <input id="answer" type="text" autocomplete="off">
    <div id="feedback"></div>
    <div id="numpad"></div>
    <p id="progress"></p>
    <p id="chronoLine"></p>
  </form>

  <!-- RÃ‰SULTATS -->
  <div id="result" class="hidden">
    <h2>RÃ©sultat</h2>
    <p id="scoreText"></p>
    <p id="bestTimeText"></p>
    <canvas id="qr"></canvas>
    <button id="restart" class="button">Rejouer</button>
  </div>

</div>

<script>
  // --------------------------------------------------
  // Ã‰TAT GLOBAL
  // --------------------------------------------------
  let state = {
    mode: null,
    operation: 'multiply',
    level: 1,
    numQuestions: 10,
    prenom: '',
    classe: '',
    questionCount: 0,
    correctCount: 0,
    currentQuestion: '',
    correctAnswer: null,
    chronoStart: 0,
    chronoTime: 0,
    bestTime: localStorage.getItem("bestTime") ?? null,
    vraiFauxIsTrue: false,
    erreurQuestion: false,
    selectedTables: []
  };

  const $ = id => document.getElementById(id);

  // --------------------------------------------------
  // PAGE DE GARDE
  // --------------------------------------------------
  $('startApp').onclick = () => {
    $('welcome').classList.add('hidden');
    $('start').classList.remove('hidden');
  };

  // --------------------------------------------------
  // OPÃ‰RATIONS
  // --------------------------------------------------
  const ops = [
    {op: "multiply", label: "Ã— Multiplication"},
    {op: "add",      label: "+ Addition"},
    {op: "subtract", label: "âˆ’ Soustraction"},
    {op: "divide",   label: "Ã· Division"}
  ];

  ops.forEach(o => {
    let b = document.createElement("button");
    b.type = "button";
    b.className = "operation-btn";
    b.dataset.op = o.op;
    b.textContent = o.label;

    b.onclick = () => {
      state.operation = o.op;
      document.querySelectorAll('.operation-btn').forEach(x => x.classList.remove('pill-selected'));
      b.classList.add('pill-selected');

      const showTables = (o.op === "multiply");
      $('tables-choose').classList.toggle('hidden', !showTables);
      if (!showTables) {
        state.selectedTables = [];
        document.querySelectorAll(".table-btn").forEach(t => t.classList.remove("table-selected"));
      }
    };

    $('op-choose').appendChild(b);
  });
  document.querySelector('.operation-btn[data-op="multiply"]').classList.add('pill-selected');

  // --------------------------------------------------
  // TABLES PERSONNALISÃ‰ES
  // --------------------------------------------------
  let tablesHTML = "";
  for (let i = 1; i <= 12; i++) {
    tablesHTML += `<button type="button" class="table-btn" data-table="${i}">${i}</button>`;
  }
  $('tables-row').innerHTML = tablesHTML;

  document.querySelectorAll(".table-btn").forEach(btn => {
    btn.onclick = () => {
      const val = parseInt(btn.dataset.table);
      if (state.selectedTables.includes(val)) {
        state.selectedTables = state.selectedTables.filter(x => x !== val);
        btn.classList.remove("table-selected");
      } else {
        state.selectedTables.push(val);
        btn.classList.add("table-selected");
      }
    };
  });

  // --------------------------------------------------
  // NIVEAUX
  // --------------------------------------------------
  [1, 2, 3].forEach(l => {
    let b = document.createElement("button");
    b.type = "button";
    b.className = "level-btn";
    b.dataset.level = l;
    b.textContent = "Niveau " + l;

    b.onclick = () => {
      state.level = l;
      document.querySelectorAll('.level-btn').forEach(x => x.classList.remove('pill-selected'));
      b.classList.add('pill-selected');
    };

    $('level-choose').appendChild(b);
  });
  document.querySelector('.level-btn[data-level="1"]').classList.add('pill-selected');

  // --------------------------------------------------
  // NOMBRE DE QUESTIONS
  // --------------------------------------------------
  [10, 15, 20, 25, 30].forEach(q => {
    let b = document.createElement("button");
    b.type = "button";
    b.className = "questions-btn";
    b.dataset.q = q;
    b.textContent = q;

    b.onclick = () => {
      state.numQuestions = q;
      document.querySelectorAll('.questions-btn').forEach(x => x.classList.remove('pill-selected'));
      b.classList.add('pill-selected');
    };

    $('questions-choose').appendChild(b);
  });
  document.querySelector('.questions-btn[data-q="10"]').classList.add('pill-selected');

  // --------------------------------------------------
  // MODES
  // --------------------------------------------------
  const modes = [
    {m: "multiplication", label: "Classique"},
    {m: "chrono",         label: "Chrono"},
    {m: "vrai_faux",      label: "Vrai/Faux"},
    {m: "erreur",         label: "Erreur"}
  ];

  modes.forEach(o => {
    let b = document.createElement("button");
    b.type = "button";
    b.className = "mode-btn";
    b.dataset.mode = o.m;
    b.textContent = o.label;

    b.onclick = () => {
      state.mode = o.m;
      document.querySelectorAll('.mode-btn').forEach(x => x.classList.remove('pill-selected'));
      b.classList.add('pill-selected');
    };

    $('mode-choose').appendChild(b);
  });
  document.querySelector('.mode-btn[data-mode="multiplication"]').classList.add('pill-selected');
  state.mode = "multiplication";

  // --------------------------------------------------
  // LANCEMENT DU JEU
  // --------------------------------------------------
  $('btn-play').onclick = () => {
    state.prenom = $('prenom').value.trim();
    state.classe = $('classe').value.trim();

    if (!state.prenom || !state.classe) {
      alert("Merci dâ€™entrer un prÃ©nom et une classe.");
      return;
    }

    state.questionCount = 0;
    state.correctCount = 0;
    state.chronoTime = 0;

    $('start').classList.add('hidden');
    $('result').classList.add('hidden');
    $('game').classList.remove('hidden');

    $('feedback').textContent = "";
    $('feedback').className = "";
    $('answer').value = "";
    $('chronoLine').textContent = "";

    if (state.mode === "chrono") {
      $('question').innerHTML = "<button id='startChronoBtn' type='button' class='button'>DÃ©marrer lâ€™exercice</button>";
      $('numpad').innerHTML = "";
      $('progress').textContent = `0/${state.numQuestions}`;

      const btn = document.getElementById('startChronoBtn');
      btn.onclick = () => {
        state.chronoStart = Date.now();
        startChrono();
        nextQuestion();
      };
    } else {
      nextQuestion();
    }
  };

  // --------------------------------------------------
  // CHRONO SIMPLE (TEXTE SEUL)
  // --------------------------------------------------
  let chronoInterval = null;

  function startChrono() {
    if (chronoInterval) clearInterval(chronoInterval);
    chronoInterval = setInterval(() => {
      const elapsed = Math.floor((Date.now() - state.chronoStart) / 1000);
      $('chronoLine').textContent = "â± " + elapsed + " s";
    }, 200);
  }

  function stopChrono() {
    if (chronoInterval) clearInterval(chronoInterval);
    state.chronoTime = Math.floor((Date.now() - state.chronoStart) / 1000);
  }

  // --------------------------------------------------
  // UTILITAIRES
  // --------------------------------------------------
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function getRange(level) {
    if (level === 1) return [1, 9];
    if (level === 2) return [10, 20];
    return [10, 99];
  }

  // --------------------------------------------------
  // NUMPAD
  // --------------------------------------------------
  function createPad() {
    const pad = $('numpad');
    pad.innerHTML = "";

    // VRAI / FAUX et ERREUR
    if (state.mode === "vrai_faux") {
      return createVFButtons("vrai", "faux");
    }
    if (state.mode === "erreur") {
      return createVFButtons("juste", "faux");
    }

    const rows = [
      [1, 2, 3],
      [4, 5, 6],
      [7, 8, 9],
      ["Eff", 0, "OK"]
    ];

    rows.forEach(r => {
      let line = document.createElement("div");
      line.className = "numpad-row";

      r.forEach(v => {
        let b = document.createElement("button");
        b.type = "button";
        b.textContent = v;
        if (v === "Eff") b.className = "numpad-eff";
        if (v === "OK") b.className = "numpad-ok";
        b.onclick = () => handleNumpad(v);
        line.appendChild(b);
      });

      pad.appendChild(line);
    });
  }

  function createVFButtons(txt1, txt2) {
    const pad = $('numpad');
    pad.innerHTML = "";

    let b1 = document.createElement("button");
    b1.type = "button";
    b1.className = "numpad-vrai";
    b1.textContent = txt1;
    b1.onclick = () => {
      $('answer').value = txt1;
      submitAnswer();
    };

    let b2 = document.createElement("button");
    b2.type = "button";
    b2.className = "numpad-faux";
    b2.textContent = txt2;
    b2.onclick = () => {
      $('answer').value = txt2;
      submitAnswer();
    };

    pad.appendChild(b1);
    pad.appendChild(b2);
  }

  function handleNumpad(v) {
    const input = $('answer');
    if (typeof v === "number") {
      input.value += v;
    } else if (v === "Eff") {
      input.value = input.value.slice(0, -1);
    } else if (v === "OK") {
      submitAnswer();
    }
  }

  // --------------------------------------------------
  // GÃ‰NÃ‰RATION DES QUESTIONS
  // --------------------------------------------------
  function nextQuestion() {
    $('feedback').textContent = "";
    $('feedback').className = "";

    if (state.questionCount >= state.numQuestions) {
      return finishGame();
    }

    state.questionCount++;

    let a, b, rep, quest;

    if (state.operation === "multiply" && state.selectedTables.length > 0) {
      a = state.selectedTables[randInt(0, state.selectedTables.length - 1)];
      b = randInt(0, 12);
      rep = a * b;
      quest = `${a} Ã— ${b}`;
    } else {
      const [min, max] = getRange(state.level);
      a = randInt(min, max);
      b = randInt(min, max);

      switch (state.operation) {
        case "add":
          rep = a + b;
          quest = `${a} + ${b}`;
          break;
        case "subtract":
          if (b > a) [a, b] = [b, a];
          rep = a - b;
          quest = `${a} âˆ’ ${b}`;
          break;
        case "multiply":
          rep = a * b;
          quest = `${a} Ã— ${b}`;
          break;
        case "divide":
          rep = a;
          quest = `${a * b} Ã· ${b}`;
          break;
      }
    }

    state.correctAnswer = rep;

    // SpÃ©cifique Vrai/Faux
    if (state.mode === "vrai_faux") {
      const shown = rep + (Math.random() < 0.5 ? 0 : randInt(1, 5));
      state.vraiFauxIsTrue = (shown === rep);
      quest = quest + " = " + shown;
    }

    // SpÃ©cifique Erreur
    if (state.mode === "erreur") {
      const wrong = Math.random() < 0.5;
      const shown = wrong ? rep + randInt(1, 3) : rep;
      state.erreurQuestion = wrong;
      quest = quest + " = " + shown;
    }

    state.currentQuestion = quest;
    $('question').textContent = quest;
    $('progress').textContent = `${state.questionCount}/${state.numQuestions}`;

    $('answer').value = "";
    $('answer').focus();

    createPad();
  }

  // --------------------------------------------------
  // VALIDATION RÃ‰PONSE
  // --------------------------------------------------
  function submitAnswer() {
    const raw = $('answer').value.trim().toLowerCase();
    let ok = false;

    if (state.mode === "multiplication" || state.mode === "chrono") {
      ok = (parseInt(raw, 10) === state.correctAnswer);
    } else if (state.mode === "vrai_faux") {
      const saisieVrai = /^(vrai|true|1)$/i.test(raw);
      ok = (saisieVrai === state.vraiFauxIsTrue);
    } else if (state.mode === "erreur") {
      const juste = /^(juste|true|1)$/i.test(raw);
      const faux = /^(faux|false|0)$/i.test(raw);
      ok = (state.erreurQuestion && faux) || (!state.erreurQuestion && juste);
    }

    if (ok) {
      state.correctCount++;
      $('feedback').textContent = "âœ… Bonne rÃ©ponse !";
      $('feedback').className = "ok";
      setTimeout(nextQuestion, 600);
    } else {
      $('feedback').innerHTML = `âŒ Mauvaise rÃ©ponse<br><span style="font-size:0.9rem;">RÃ©ponse attendue : <b>${state.correctAnswer}</b></span>`;
      $('feedback').className = "ko";
      setTimeout(nextQuestion, 1700);
    }
  }

  // --------------------------------------------------
  // FIN DE PARTIE
  // --------------------------------------------------
  function finishGame() {
    if (state.mode === "chrono") {
      stopChrono();
    }

    $('game').classList.add('hidden');
    $('result').classList.remove('hidden');

    $('scoreText').textContent = `${state.correctCount} / ${state.numQuestions}`;

    if (state.mode === "chrono") {
      $('bestTimeText').textContent = `â± Temps total : ${state.chronoTime} s`;
    } else {
      $('bestTimeText').textContent = "";
    }

    const qrData = {
      prenom: state.prenom,
      classe: state.classe,
      mode: state.mode,
      score: `${state.correctCount}/${state.numQuestions}`
    };

    if (state.mode === "chrono") {
      qrData.temps = state.chronoTime;
    }

    new QRious({
      element: $('qr'),
      size: 260,
      value: JSON.stringify(qrData)
    });
  }

  // --------------------------------------------------
  // REJOUER
  // --------------------------------------------------
  $('restart').onclick = () => {
    $('result').classList.add('hidden');
    $('start').classList.remove('hidden');
  };
</script>
</body>
</html>
